-- Nowa struktura bazy danych dla systemu miesięcznych snapshotów
-- Wklej ten kod do Supabase SQL Editor

-- 1. Tabela śledząca utworzone miesiące
CREATE TABLE IF NOT EXISTS public.created_months (
  month TEXT PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 2. Tabela uczestników miesięczna
CREATE TABLE IF NOT EXISTS public.participants_month (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  month TEXT NOT NULL,
  name TEXT NOT NULL,
  email TEXT,
  phone TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 3. Tabela powiązań uczestnik-grupa miesięczna
CREATE TABLE IF NOT EXISTS public.participant_groups_month (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  month TEXT NOT NULL,
  participant_id UUID REFERENCES participants_month(id) ON DELETE CASCADE,
  group_id UUID REFERENCES groups_month(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 4. Tabela płatności miesięczna
CREATE TABLE IF NOT EXISTS public.payments_month (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  month TEXT NOT NULL,
  participant_id UUID REFERENCES participants_month(id) ON DELETE CASCADE,
  group_id UUID REFERENCES groups_month(id) ON DELETE CASCADE,
  amount DECIMAL(10,2) NOT NULL,
  payment_method TEXT,
  comment TEXT,
  confirmed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Dodaj kolumnę comment do istniejącej tabeli payments_month (jeśli nie istnieje)
ALTER TABLE public.payments_month ADD COLUMN IF NOT EXISTS comment TEXT;

-- Indeksy dla lepszej wydajności
CREATE INDEX IF NOT EXISTS idx_participants_month_month ON participants_month(month);
CREATE INDEX IF NOT EXISTS idx_participant_groups_month_month ON participant_groups_month(month);
CREATE INDEX IF NOT EXISTS idx_payments_month_month ON payments_month(month);

-- 5. Funkcja do kopiowania grup z poprzedniego miesiąca
CREATE OR REPLACE FUNCTION copy_groups_month(p_from_month TEXT, p_to_month TEXT)
RETURNS VOID
LANGUAGE plpgsql
AS $$
DECLARE
  prev_month TEXT;
BEGIN
  -- Znajdź poprzedni miesiąc (najnowszy przed p_to_month)
  SELECT month INTO prev_month
  FROM groups_month 
  WHERE month < p_to_month 
  ORDER BY month DESC 
  LIMIT 1;
  
  -- Jeśli nie ma poprzedniego miesiąca, nie rób nic
  IF prev_month IS NULL THEN
    RETURN;
  END IF;
  
  -- Skopiuj grupy z poprzedniego miesiąca
  INSERT INTO groups_month (month, name, day, start_time, trainer)
  SELECT p_to_month, name, day, start_time, trainer
  FROM groups_month 
  WHERE month = prev_month;
END;
$$;

-- 6. Funkcja do dodawania uczestnika
CREATE OR REPLACE FUNCTION insert_participant_month(
  p_month TEXT,
  p_name TEXT,
  p_email TEXT DEFAULT NULL,
  p_phone TEXT DEFAULT NULL
) RETURNS UUID
LANGUAGE plpgsql
AS $$
DECLARE
  new_id UUID;
BEGIN
  INSERT INTO participants_month (month, name, email, phone)
  VALUES (p_month, p_name, p_email, p_phone)
  RETURNING id INTO new_id;
  RETURN new_id;
END;
$$;

-- 7. Funkcja do listowania uczestników w miesiącu
CREATE OR REPLACE FUNCTION list_participants_month(p_month TEXT)
RETURNS TABLE (id UUID, name TEXT, email TEXT, phone TEXT)
LANGUAGE sql
AS $$
  SELECT id, name, email, phone
  FROM participants_month
  WHERE month = p_month
  ORDER BY name;
$$;

-- 8. Funkcja do dodawania uczestnika do grupy
CREATE OR REPLACE FUNCTION add_participant_to_group_month(
  p_month TEXT,
  p_participant_id UUID,
  p_group_id UUID
) RETURNS UUID
LANGUAGE plpgsql
AS $$
DECLARE
  new_id UUID;
BEGIN
  INSERT INTO participant_groups_month (month, participant_id, group_id)
  VALUES (p_month, p_participant_id, p_group_id)
  RETURNING id INTO new_id;
  RETURN new_id;
END;
$$;

-- 9. Funkcja do dodawania płatności
CREATE OR REPLACE FUNCTION insert_payment_month(
  p_month TEXT,
  p_participant_id UUID,
  p_group_id UUID,
  p_amount DECIMAL(10,2),
  p_payment_method TEXT DEFAULT NULL
) RETURNS UUID
LANGUAGE plpgsql
AS $$
DECLARE
  new_id UUID;
BEGIN
  INSERT INTO payments_month (month, participant_id, group_id, amount, payment_method)
  VALUES (p_month, p_participant_id, p_group_id, p_amount, p_payment_method)
  RETURNING id INTO new_id;
  RETURN new_id;
END;
$$;

-- 10. Funkcja do potwierdzania płatności
CREATE OR REPLACE FUNCTION confirm_payment_month(p_payment_id UUID)
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
  UPDATE payments_month 
  SET confirmed = TRUE 
  WHERE id = p_payment_id;
END;
$$;

-- 11. Funkcja do usuwania uczestnika z grupy
CREATE OR REPLACE FUNCTION remove_participant_from_group_month(
  p_month TEXT,
  p_participant_id UUID,
  p_group_id UUID
) RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
  DELETE FROM participant_groups_month 
  WHERE month = p_month 
    AND participant_id = p_participant_id 
    AND group_id = p_group_id;
    
  -- Usuń też płatności dla tego uczestnika w tej grupie w tym miesiącu
  DELETE FROM payments_month 
  WHERE month = p_month 
    AND participant_id = p_participant_id 
    AND group_id = p_group_id;
END;
$$;

-- 12. Funkcja do usuwania uczestnika całkowicie z miesiąca
CREATE OR REPLACE FUNCTION delete_participant_month(
  p_month TEXT,
  p_participant_id UUID
) RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
  -- Usuń wszystkie płatności uczestnika w tym miesiącu
  DELETE FROM payments_month 
  WHERE month = p_month AND participant_id = p_participant_id;
  
  -- Usuń wszystkie powiązania uczestnik-grupa w tym miesiącu
  DELETE FROM participant_groups_month 
  WHERE month = p_month AND participant_id = p_participant_id;
  
  -- Usuń uczestnika
  DELETE FROM participants_month 
  WHERE month = p_month AND id = p_participant_id;
END;
$$;

-- 13. Funkcja do kopiowania uczestników i płatności z poprzedniego miesiąca
CREATE OR REPLACE FUNCTION copy_participants_month(p_from_month TEXT, p_to_month TEXT)
RETURNS VOID
LANGUAGE plpgsql
AS $$
DECLARE
  prev_month TEXT;
  participant_record RECORD;
  new_participant_id UUID;
  group_mapping RECORD;
BEGIN
  -- Znajdź poprzedni miesiąc (najnowszy przed p_to_month)
  SELECT month INTO prev_month
  FROM participants_month 
  WHERE month < p_to_month 
  ORDER BY month DESC 
  LIMIT 1;
  
  -- Jeśli nie ma poprzedniego miesiąca, nie rób nic
  IF prev_month IS NULL THEN
    RETURN;
  END IF;
  
  -- Skopiuj uczestników z poprzedniego miesiąca
  FOR participant_record IN 
    SELECT id, name, email, phone
    FROM participants_month 
    WHERE month = prev_month
  LOOP
    -- Dodaj uczestnika do nowego miesiąca
    INSERT INTO participants_month (month, name, email, phone)
    VALUES (p_to_month, participant_record.name, participant_record.email, participant_record.phone)
    RETURNING id INTO new_participant_id;
    
    -- Skopiuj powiązania uczestnik-grupa (używając mapowania grup)
    FOR group_mapping IN
      SELECT 
        pgm.group_id as old_group_id,
        gm_new.id as new_group_id
      FROM participant_groups_month pgm
      JOIN groups_month gm_old ON gm_old.id = pgm.group_id
      JOIN groups_month gm_new ON gm_new.month = p_to_month 
        AND gm_new.name = gm_old.name 
        AND gm_new.day = gm_old.day 
        AND gm_new.start_time = gm_old.start_time
      WHERE pgm.month = prev_month 
        AND pgm.participant_id = participant_record.id
    LOOP
      -- Dodaj powiązanie uczestnik-grupa
      INSERT INTO participant_groups_month (month, participant_id, group_id)
      VALUES (p_to_month, new_participant_id, group_mapping.new_group_id);
      
      -- Skopiuj płatności (z resetowanym statusem na niezaplacony)
      INSERT INTO payments_month (month, participant_id, group_id, amount, payment_method, confirmed)
      SELECT p_to_month, new_participant_id, group_mapping.new_group_id, pm.amount, pm.payment_method, FALSE
      FROM payments_month pm
      WHERE pm.month = prev_month 
        AND pm.participant_id = participant_record.id
        AND pm.group_id = group_mapping.old_group_id;
    END LOOP;
  END LOOP;
END;
$$;

-- 14. Funkcja do aktualizacji potwierdzenia płatności
CREATE OR REPLACE FUNCTION update_payment_confirmation(
  p_month TEXT,
  p_participant_id UUID,
  p_group_id UUID,
  p_payment_method TEXT,
  p_comment TEXT DEFAULT NULL
) RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
  UPDATE payments_month 
  SET payment_method = p_payment_method,
      comment = p_comment,
      confirmed = TRUE
  WHERE month = p_month 
    AND participant_id = p_participant_id 
    AND group_id = p_group_id;
END;
$$;

-- 15. Funkcja do usuwania potwierdzenia płatności
CREATE OR REPLACE FUNCTION remove_payment_confirmation(
  p_month TEXT,
  p_participant_id UUID,
  p_group_id UUID
) RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
  UPDATE payments_month 
  SET payment_method = NULL,
      comment = NULL,
      confirmed = FALSE
  WHERE month = p_month 
    AND participant_id = p_participant_id 
    AND group_id = p_group_id;
END;
$$;
