<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admina - Grupy</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-bg: #121212;
      --secondary-bg: #1e1e1e;
      --gold: #d4af37;
      --gold-light: #f1e5b9;
      --text-light: #f5f5f5;
      --text-gray: #b0b0b0;
      --border-dark: #333;
      --success: #28a745;
      --error: #dc3545;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: var(--primary-bg);
      color: var(--text-light);
      min-height: 100vh;
      display: flex;
    }
    
    /* Sidebar */
    .sidebar {
      width: 250px;
      background-color: var(--secondary-bg);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      padding: 20px 0;
      border-right: 1px solid var(--border-dark);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .logo {
      text-align: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--border-dark);
      margin-bottom: 20px;
    }
    
    .logo h1 {
      color: var(--gold);
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .logo span {
      color: var(--text-light);
    }
    
    .nav-links {
      list-style: none;
      padding: 0 15px;
    }
    
    .nav-links li {
      margin-bottom: 5px;
    }
    
    .nav-links a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      text-decoration: none;
      color: var(--text-gray);
      border-radius: 5px;
      transition: all 0.3s ease;
    }
    
    .nav-links a:hover, .nav-links a.active {
      background-color: rgba(212, 175, 55, 0.1);
      color: var(--gold);
    }
    
    .nav-links a i {
      margin-right: 10px;
      font-size: 1.1rem;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 250px;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-dark);
    }
    
    .header h2 {
      color: var(--gold);
      font-size: 1.8rem;
    }
    
    .user-info {
      display: flex;
      align-items: center;
    }
    
    .user-info span {
      margin-right: 15px;
      color: var(--text-gray);
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
    }
    
    .btn i {
      margin-right: 5px;
    }
    
    .btn-primary {
      background-color: var(--gold);
      color: var(--primary-bg);
    }
    
    .btn-primary:hover {
      background-color: #c19b2e;
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--gold);
      color: var(--gold);
    }
    
    .btn-outline:hover {
      background-color: rgba(212, 175, 55, 0.1);
    }
    
    /* Content Box */
    .content-box {
      background-color: var(--secondary-bg);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-dark);
    }
    
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .content-header h3 {
      color: var(--gold);
      font-size: 1.3rem;
    }
    
    /* Groups List */
    .group-card {
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--border-dark);
      transition: all 0.3s ease;
      margin-bottom: 12px;
    }
    .groups-day-header { padding: 8px 4px; margin: 10px 0 6px; border-bottom: 1px dashed var(--border-dark); }
    
    .group-card:hover {
      border-color: var(--gold);
      transform: translateY(-2px);
    }
    
    .group-card h4 {
      color: var(--gold);
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .group-detail {
      display: flex;
      margin-bottom: 8px;
      color: var(--text-gray);
      font-size: 0.9rem;
    }
    
    .group-detail i {
      margin-right: 8px;
      color: var(--gold);
      width: 16px;
    }
    
    .group-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
      gap: 10px;
    }

    /* Make all modals scrollable and usable on small screens */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal.active { display: flex; }
    .modal .modal-content {
      background: var(--secondary-bg);
      border: 1px solid var(--border-dark);
      border-radius: 8px;
      max-width: 800px;
      width: 100%;
      max-height: 80vh;
      overflow: auto;
      padding: 16px;
    }
    .modal .modal-header { margin-bottom: 12px; }
    .modal .modal-close { float: right; }
    /* Sidebar collapse */
    .sidebar.collapsed { width: 70px; }
    .sidebar.collapsed .logo-text, .sidebar.collapsed .link-text { display: none; }
    .main-content.collapsed { margin-left: 70px; }
    .logo h1 { white-space: normal; line-height: 1.2; }
    .sidebar.collapsed .nav-links { padding: 0 10px; }
    .sidebar.collapsed .nav-links a { justify-content: center; padding: 15px 10px; }
    .sidebar.collapsed .nav-links a i { margin-right: 0; font-size: 1.3rem; }
    #sidebar-toggle { position: absolute; right: 10px; top: 10px; z-index: 1001; }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background-color: var(--secondary-bg);
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      padding: 25px;
      border: 1px solid var(--border-dark);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    
    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-gray);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .modal-close:hover {
      color: var(--text-light);
    }
    
    .modal-header {
      margin-bottom: 20px;
      padding-right: 30px;
    }
    
    .modal-header h3 {
      color: var(--gold);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-gray);
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.07);
      border: 1px solid var(--border-dark);
      border-radius: 4px;
      color: var(--text-light);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--gold);
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
      gap: 10px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-gray);
    }
    
    .empty-state i {
      font-size: 3rem;
      color: var(--gold);
      margin-bottom: 15px;
    }
    
    .empty-state p {
      margin-bottom: 20px;
    }
    /* Summary cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .summary-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--border-dark);
      border-radius: 8px;
      padding: 12px;
    }
    .summary-card .label { color: var(--text-gray); font-size: 0.85rem; }
    .summary-card .value { color: var(--gold); font-weight: 700; font-size: 1.05rem; }
    .summary-card .sub { color: var(--text-light); font-weight: 600; font-size: 0.95rem; }
    .progress { width: 100%; height: 8px; background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; border: 1px solid var(--border-dark); }
    .progress-bar { height: 100%; background: var(--gold); width: 0%; transition: width 0.3s ease; }
    /* Compact controls inside rows */
    .form-control.small { padding: 6px 8px; font-size: 0.9rem; }
    .participant-row { padding: 10px; }
    .btn.btn-sm { padding: 4px 8px; font-size: 0.85rem; }
    .participant-row.paid { background-color: rgba(40, 167, 69, 0.08); border-left: 3px solid var(--success); }
    .participant-row.unpaid { background-color: rgba(220, 53, 69, 0.06); border-left: 3px solid var(--error); }
    .p-index { color: var(--gold); font-weight: 700; margin-right: 8px; }
    
    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--gold);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 992px) {
      .sidebar {
        width: 70px;
      }
      
      .sidebar .logo-text, .sidebar .link-text {
        display: none;
      }
      
      .sidebar .logo {
        padding: 10px;
      }
      
      .nav-links {
        padding: 0 10px;
      }
      
      .nav-links a {
        justify-content: center;
        padding: 15px 10px;
      }
      
      .nav-links a i {
        margin-right: 0;
        font-size: 1.3rem;
      }
      
      .main-content {
        margin-left: 70px;
      }
    }
    
    @media (max-width: 576px) {
      .sidebar {
        width: 0;
        overflow: hidden;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .groups-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo" style="display:flex; flex-direction:column; align-items:center; gap:8px; position:relative; padding:44px 20px 20px;">
      <button class="btn btn-outline" id="sidebar-toggle" title="Zwiń/Rozwiń" style="padding:6px 10px;"><i class="fas fa-bars"></i></button>
      <h1 style="margin:0;"><span class="logo-text">Studio Tańca Imperia</span></h1>
    </div>
    
    <ul class="nav-links">
      <li>
        <a href="#" id="nav-groups" class="active">
          <i class="fas fa-users"></i>
          <span class="link-text">Grupy</span>
        </a>
      </li>
      <li>
        <a href="#" id="nav-participants">
          <i class="fas fa-user-friends"></i>
          <span class="link-text">Uczestnicy</span>
        </a>
      </li>
      <li>
        <a href="#" id="nav-lessons">
          <i class="fas fa-book"></i>
          <span class="link-text">Lekcje</span>
        </a>
      </li>
      <li>
        <a href="#" id="nav-first-dance">
          <i class="fas fa-heart"></i>
          <span class="link-text">Pierwszy taniec</span>
        </a>
      </li>
      <li>
        <a href="#" id="nav-schedule">
          <i class="fas fa-calendar-alt"></i>
          <span class="link-text">Harmonogram</span>
        </a>
      </li>
      <li>
        <a href="#">
          <i class="fas fa-chart-line"></i>
          <span class="link-text">Płatności</span>
        </a>
      </li>
      <li>
        <a href="#" id="nav-trainers">
          <i class="fas fa-user-tie"></i>
          <span class="link-text">Trenerzy</span>
        </a>
      </li>
      <li>
        <a href="#">
          <i class="fas fa-cog"></i>
          <span class="link-text">Ustawienia</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="header">
      <h2>Zarządzanie grupami</h2>
      <div class="user-info">
        <span>Witaj, Admin!</span>
        <button class="btn btn-outline" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Wyloguj
        </button>
      </div>
    </div>

    <div class="content-box" id="groups-section">
      <div class="content-header">
        <h3>Lista grup treningowych</h3>
        <button class="btn btn-primary" id="add-group-btn">
          <i class="fas fa-plus"></i> Dodaj grupę
        </button>
      </div>

      <div id="groups-list">
        <!-- Groups will be loaded here dynamically -->
        <div class="empty-state" id="emptyState">
          <i class="fas fa-users"></i>
          <p>Brak grup do wyświetlenia</p>
          <button class="btn btn-primary" id="add-first-group">
            <i class="fas fa-plus"></i> Dodaj pierwszą grupę
          </button>
        </div>
      </div>
    </div>
    
    <!-- Group Details Section (inline) -->
    <div class="content-box" id="group-details-section" style="display:none;">
      <div class="content-header">
        <div style="display:flex; align-items:center; gap:10px;">
          <button class="btn btn-outline" id="back-to-groups-btn"><i class="fas fa-arrow-left"></i> Wróć</button>
          <h3 id="group-details-title">Szczegóły grupy</h3>
        </div>
        <div id="group-controls-row" style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
          <label for="month-select" style="color: var(--text-gray);">Miesiąc</label>
          <select id="month-select" class="form-control" style="width:220px;"></select>
          <label for="participants-filter" style="color: var(--text-gray);">Filtr</label>
          <select id="participants-filter" class="form-control" style="width:180px;">
            <option value="all">Wszyscy</option>
            <option value="paid">Kto zapłacił</option>
            <option value="unpaid">Kto nie zapłacił</option>
          </select>
          <button class="btn btn-primary" id="add-participant-btn"><i class="fas fa-user-plus"></i> Dodaj uczestnika</button>
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn btn-primary" id="group-view-tab">Podgląd grupy</button>
        <button class="btn btn-outline" id="group-attendance-tab">Dziennik</button>
      </div>
      <div id="add-participant-form" class="content-box" style="display:none; margin-top:10px;">
        <div class="form-group">
          <label>Imię</label>
          <input type="text" id="participant-first-name" class="form-control" placeholder="Imię">
        </div>
        <div class="form-group">
          <label>Nazwisko</label>
          <input type="text" id="participant-last-name" class="form-control" placeholder="Nazwisko">
        </div>
        <div class="form-group">
          <label>Telefon</label>
          <input type="tel" id="participant-phone" class="form-control" placeholder="Numer telefonu">
        </div>
        <div class="form-group" style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="participant-multisport" style="width:auto;">
          <label for="participant-multisport" style="margin:0;">Korzysta z Multisport</label>
        </div>
        <div class="form-actions">
          <button class="btn btn-outline" id="cancel-add-participant">Anuluj</button>
          <button class="btn btn-primary" id="save-participant-btn"><i class="fas fa-save"></i> Dodaj uczestnika</button>
        </div>
      </div>
      <div class="content-box" id="participants-summary" style="margin-top:10px; padding:12px;">
        <div class="summary-grid">
          <div class="summary-card">
            <div class="label">Uczestnicy</div>
            <div class="value" id="sum-count">0</div>
          </div>
          <div class="summary-card">
            <div class="label">Zapłacili</div>
            <div class="sub"><span id="sum-paid-count">0</span> osób</div>
            <div class="value" id="sum-paid-amount">0.00 zł</div>
            <div class="progress"><div class="progress-bar" id="sum-paid-progress" style="width:0%"></div></div>
          </div>
          <div class="summary-card">
            <div class="label">Niezapłacone</div>
            <div class="sub"><span id="sum-unpaid-count">0</span> osób</div>
            <div class="value" id="sum-unpaid-amount">0.00 zł</div>
          </div>
          <div class="summary-card">
            <div class="label">Zysk</div>
            <div class="value" id="sum-profit">0.00 zł</div>
            <div class="label" style="margin-top:6px;">Potencjalny zysk</div>
            <div class="sub" id="sum-potential-profit">0.00 zł</div>
          </div>
        </div>
      </div>
      <div class="content-box" style="margin-top:15px;">
        <div class="content-header" style="margin-bottom:12px;">
          <h3 style="font-size:1.1rem;">Uczestnicy</h3>
        </div>
        <div id="participants-list">
          <div class="empty-state"><p>Brak uczestników w tej grupie</p></div>
        </div>
      </div>
      <!-- Attendance (Dziennik) Panel -->
      <div id="group-attendance-panel" style="display:none; margin-top:15px;">
        <div class="content-box" style="padding:12px;">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap: wrap;">
            <label for="attendance-month-select" style="color: var(--text-gray);">Miesiąc</label>
            <select id="attendance-month-select" class="form-control" style="width:220px;"></select>
            <div id="attendance-dates" style="display:flex; gap:8px; flex-wrap: wrap;"></div>
          </div>
        </div>
        <div class="content-box" style="margin-top:10px;">
          <div class="content-header" style="align-items:center; gap:10px;">
            <h3 style="font-size:1.1rem; margin-right:auto;">Obecność</h3>
            <div>
              <button class="btn btn-primary" id="confirm-attendance-btn" style="display:none;">Zatwierdź obecność</button>
              <button class="btn btn-outline" id="edit-attendance-btn" style="display:none;">Popraw</button>
            </div>
          </div>
          <div id="attendance-list">
            <div class="empty-state"><p>Brak uczestników</p></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Lessons Section -->
    <div class="content-box" id="lessons-section" style="display:none;">
      <div class="content-header">
        <h3>Lekcje</h3>
        <div>
          <button class="btn btn-primary" id="create-lesson-btn"><i class="fas fa-plus"></i> Utwórz zajęcia</button>
        </div>
      </div>
      <div id="lessons-list">
        <div class="empty-state"><i class="fas fa-book"></i><p>Brak zajęć</p></div>
      </div>
    </div>

    <!-- Lesson Details Section -->
    <div class="content-box" id="lesson-details-section" style="display:none;">
      <div class="content-header" style="gap:10px; align-items:center;">
        <h3 id="lesson-details-title" style="margin-right:auto;">Szczegóły zajęć</h3>
        <label for="lesson-month-select" style="color: var(--text-gray);">Miesiąc</label>
        <select id="lesson-month-select" class="form-control" style="width:220px;"></select>
        <button class="btn btn-primary" id="add-lesson-entry-btn"><i class="fas fa-plus"></i> Dodaj lekcję</button>
        <button class="btn btn-outline" id="delete-lesson-btn" title="Usuń zajęcia"><i class="fas fa-trash"></i></button>
      </div>
      <div class="content-box" id="lesson-summary" style="margin-bottom:12px; padding:12px;">
        <div class="summary-grid">
          <div class="summary-card">
            <div class="label">Lekcje</div>
            <div class="value" id="le-sum-count">0</div>
          </div>
          <div class="summary-card">
            <div class="label">Zapłacone</div>
            <div class="sub"><span id="le-sum-paid-count">0</span> szt</div>
            <div class="value" id="le-sum-paid-amount">0.00 zł</div>
            <div class="progress"><div class="progress-bar" id="le-sum-paid-progress" style="width:0%"></div></div>
          </div>
          <div class="summary-card">
            <div class="label">Niezapłacone</div>
            <div class="sub"><span id="le-sum-unpaid-count">0</span> szt</div>
            <div class="value" id="le-sum-unpaid-amount">0.00 zł</div>
          </div>
          <div class="summary-card">
            <div class="label">Zysk</div>
            <div class="value" id="le-sum-profit">0.00 zł</div>
            <div class="label" style="margin-top:6px;">Potencjalny zysk</div>
            <div class="sub" id="le-sum-potential">0.00 zł</div>
          </div>
        </div>
      </div>
      <div id="lesson-participants-summary"></div>
      <div class="content-box" id="lesson-entries-list" style="margin-top:12px;"></div>
      <div style="margin-top:12px; text-align:right; color: var(--gold); font-weight:600;" id="lesson-total"></div>
    </div>

    <!-- First Dance Section: identical UI as lessons -->
    <div class="content-box" id="first-dance-section" style="display:none;">
      <div class="content-header" style="gap:10px; align-items:center;">
        <h3 id="fd-title" style="margin-right:auto;">Pierwszy taniec</h3>
        <label for="fd-month-select" style="color: var(--text-gray);">Miesiąc</label>
        <select id="fd-month-select" class="form-control" style="width:220px;"></select>
        <button class="btn btn-primary" id="fd-add-entry-btn"><i class="fas fa-plus"></i> Dodaj lekcję</button>
      </div>
      <div class="content-box" id="fd-summary" style="margin-bottom:12px; padding:12px;">
        <div class="summary-grid">
          <div class="summary-card">
            <div class="label">Lekcje</div>
            <div class="value" id="fd-sum-count">0</div>
          </div>
          <div class="summary-card">
            <div class="label">Zapłacone</div>
            <div class="sub"><span id="fd-sum-paid-count">0</span> szt</div>
            <div class="value" id="fd-sum-paid-amount">0.00 zł</div>
            <div class="progress"><div class="progress-bar" id="fd-sum-paid-progress" style="width:0%"></div></div>
          </div>
          <div class="summary-card">
            <div class="label">Niezapłacone</div>
            <div class="sub"><span id="fd-sum-unpaid-count">0</span> szt</div>
            <div class="value" id="fd-sum-unpaid-amount">0.00 zł</div>
          </div>
          <div class="summary-card">
            <div class="label">Zysk</div>
            <div class="value" id="fd-sum-profit">0.00 zł</div>
            <div class="label" style="margin-top:6px;">Potencjalny zysk</div>
            <div class="sub" id="fd-sum-potential">0.00 zł</div>
          </div>
        </div>
      </div>
      <div class="content-box" id="fd-entries-list" style="margin-top:12px;"></div>
      <div style="margin-top:12px; text-align:right; color: var(--gold); font-weight:600;" id="fd-total"></div>
    </div>

    <!-- Schedule Section -->
    <div class="content-box" id="schedule-section" style="display:none;">
      <div class="content-header">
        <h3>Harmonogram</h3>
        <div>
          <button class="btn btn-primary" id="add-group-from-schedule"><i class="fas fa-plus"></i> Dodaj grupę</button>
        </div>
      </div>
      <div id="gcal-embed" style="margin-top:12px;">
        <iframe src="https://calendar.google.com/calendar/embed?src=imperia.studiotanca%40gmail.com&ctz=Europe%2FWarsaw" style="border:0; width:100%; height:600px;" frameborder="0" scrolling="no"></iframe>
      </div>
    </div>

    <!-- Participants Section -->
    <div class="content-box" id="participants-section" style="display:none;">
      <div class="content-header">
        <div style="display:flex; align-items:center; gap:10px;">
          <h3>Uczestnicy</h3>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
          <input id="participants-search" class="form-control" placeholder="Szukaj: imię/nazwisko/telefon" style="width:260px;" />
          <label style="display:flex; align-items:center; gap:6px; color: var(--text-gray);"><input type="checkbox" id="filter-paid" style="width:auto;" /> Zapłacone</label>
          <label style="display:flex; align-items:center; gap:6px; color: var(--text-gray);"><input type="checkbox" id="filter-unpaid" style="width:auto;" /> Niezapłacone</label>
          <button class="btn btn-primary" id="add-participant-global"><i class="fas fa-user-plus"></i> Dodaj uczestnika</button>
        </div>
      </div>
      <div class="content-box" style="margin-top:10px;">
        <div class="content-header" style="margin-bottom:12px;">
          <h3 style="font-size:1.1rem;">Aktywni</h3>
        </div>
        <div id="participants-list-all">
          <div class="empty-state"><p>Brak uczestników</p></div>
        </div>
      </div>
      <div class="content-box" style="margin-top:15px;">
        <div class="content-header" style="margin-bottom:12px;">
          <h3 style="font-size:1.1rem;">Nieaktywni</h3>
        </div>
        <div id="participants-list-inactive">
          <div class="empty-state"><p>Brak nieaktywnych</p></div>
        </div>
      </div>
    </div>

    <!-- Archive Section -->
    <div class="content-box" id="archive-section" style="display:none;">
      <div class="content-header">
        <h3>Archiwum uczestników</h3>
      </div>
      <div id="archive-list">
        <div class="empty-state"><p>Archiwum jest puste</p></div>
      </div>
    </div>

    <!-- Trainers Section -->
    <div class="content-box" id="trainers-section" style="display:none;">
      <div class="content-header">
        <h3>Trenerzy</h3>
        <div>
          <button class="btn btn-primary" id="add-trainer-btn"><i class="fas fa-user-plus"></i> Dodaj trenera</button>
        </div>
      </div>
      <div id="trainers-list">
        <div class="empty-state"><p>Brak trenerów</p></div>
      </div>
    </div>

    <!-- Edit Participant Modal -->
    <div class="modal" id="edit-participant-modal">
      <div class="modal-content">
        <button class="modal-close" id="close-edit-participant-modal">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3 id="edit-participant-title">Edytuj uczestnika</h3>
        </div>
        <div class="form-group">
          <label>Imię</label>
          <input type="text" id="edit-participant-first-name" class="form-control" placeholder="Imię">
        </div>
        <div class="form-group">
          <label>Nazwisko</label>
          <input type="text" id="edit-participant-last-name" class="form-control" placeholder="Nazwisko">
        </div>
        <div class="form-group">
          <label>Telefon</label>
          <input type="tel" id="edit-participant-phone" class="form-control" placeholder="Telefon">
        </div>
        <div class="form-group" style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="edit-participant-multisport" style="width:auto;">
          <label for="edit-participant-multisport" style="margin:0;">Korzysta z Multisport</label>
        </div>
        <div class="form-group">
          <label>Grupy (zaznacz ptaszkiem)</label>
          <div id="edit-participant-groups" style="display:flex; flex-direction:column; gap:6px;"></div>
          <div style="color: var(--text-gray); font-size: 0.85rem;">Możesz zaznaczyć kilka grup.</div>
        </div>
        <div class="form-actions">
          <button class="btn btn-outline" id="cancel-edit-participant">Anuluj</button>
          <button class="btn btn-primary" id="save-edit-participant"><i class="fas fa-save"></i> Zapisz</button>
        </div>
      </div>
    </div>

  <!-- Add Group Modal -->
  <div class="modal" id="add-group-modal">
    <div class="modal-content">
      <button class="modal-close" id="close-group-modal">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="modal-header">
        <h3 id="group-modal-title">Dodaj nową grupę</h3>
      </div>
      
      <div class="form-group">
        <label for="group-name">Nazwa grupy</label>
        <input type="text" id="group-name" class="form-control" placeholder="Nazwa grupy">
      </div>
      
      <div class="form-group">
        <label for="group-day">Dzień tygodnia</label>
        <select id="group-day" class="form-control">
          <option value="Poniedziałek">Poniedziałek</option>
          <option value="Wtorek">Wtorek</option>
          <option value="Środa">Środa</option>
          <option value="Czwartek">Czwartek</option>
          <option value="Piątek">Piątek</option>
          <option value="Sobota">Sobota</option>
          <option value="Niedziela">Niedziela</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="group-start">Godzina rozpoczęcia</label>
        <input type="time" id="group-start" class="form-control">
      </div>
      
      <div class="form-group">
        <label for="group-end">Godzina zakończenia</label>
        <input type="time" id="group-end" class="form-control">
      </div>
      
      <div class="form-group">
        <label for="group-trainer-select">Trener</label>
        <select id="group-trainer-select" class="form-control" required>
          <option value="" disabled>Wybierz trenera...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="group-fee">Kwota (zł)</label>
        <input type="number" id="group-fee" class="form-control" placeholder="0.00" step="0.01">
      </div>
      
      <div class="form-group">
        <label for="group-multisport">Kwota Multisport (zł)</label>
        <input type="number" id="group-multisport" class="form-control" placeholder="0.00" step="0.01">
      </div>
      
      <div class="form-group">
        <label for="group-months">Czas trwania kursu (miesiące)</label>
        <input type="number" id="group-months" class="form-control" placeholder="np. 3" min="1" step="1">
      </div>
      
      <div class="form-group">
        <label for="group-color">Kolor wydarzenia (Google Calendar)</label>
        <select id="group-color" class="form-control">
          <option value="">Domyślny</option>
          <option value="blue">Niebieski</option>
          <option value="green">Zielony</option>
          <option value="red">Czerwony</option>
          <option value="yellow">Żółty</option>
          <option value="orange">Pomarańczowy</option>
          <option value="turquoise">Turkusowy</option>
          <option value="purple">Fioletowy</option>
          <option value="gray">Szary</option>
        </select>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-outline" id="cancel-group-btn">Anuluj</button>
        <button class="btn btn-primary" id="save-group-btn">
          <i class="fas fa-save"></i> Zapisz grupę
        </button>
      </div>
    </div>
  </div>


  <script type="module">
    import { supabase } from './supabaseClient.js';
    // FullCalendar loader (lazy)
    let fcLoaded = false;
    async function ensureFullCalendarLoaded() {
      if (fcLoaded || (window && window.FullCalendar)) { fcLoaded = true; return; }
      await new Promise((resolve, reject) => {
        // CSS once
        if (!document.getElementById('fc-css')) {
          const link = document.createElement('link');
          link.id = 'fc-css';
          link.rel = 'stylesheet';
          link.href = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css';
          document.head.appendChild(link);
        }
        // JS once
        const existing = document.getElementById('fc-script');
        const onReady = () => { fcLoaded = true; resolve(); };
        if (existing) {
          existing.addEventListener('load', onReady, { once: true });
          existing.addEventListener('error', () => reject(new Error('FullCalendar load failed')), { once: true });
          return;
        }
        const s = document.createElement('script');
        s.id = 'fc-script';
        s.src = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js';
        s.onload = onReady;
        s.onerror = () => reject(new Error('FullCalendar load failed'));
        document.body.appendChild(s);
      });
    }
    
    // Check if user is admin
    async function checkAdmin() {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        alert("Nie jesteś zalogowany");
        window.location.href = "login.html";
        return;
      }
      
      const { data: profile, error } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();
        
      if (error || !profile || profile.role !== "admin") {
        alert("Nie masz uprawnień administratora");
        window.location.href = "login.html";
        return;
      }
    }
    
    // Logout function
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });
    
    // Modal functionality
    const addGroupModal = document.getElementById('add-group-modal');
    const addGroupBtn = document.getElementById('add-group-btn');
    const addFirstGroupBtn = document.getElementById('add-first-group');
    const closeModalBtn = document.getElementById('close-group-modal');
    const cancelGroupBtn = document.getElementById('cancel-group-btn');
    const saveGroupBtn = document.getElementById('save-group-btn');
    const groupsList = document.getElementById('groups-list');
    const emptyState = document.getElementById('emptyState');
    // Participants page refs (global)
    const participantsSection = document.getElementById('participants-section');
    const participantsListAll = document.getElementById('participants-list-all');
    const participantsSearch = document.getElementById('participants-search');
    // Nav links
    const groupsLink = document.getElementById('nav-groups');
    const participantsLink = document.getElementById('nav-participants');
    const lessonsLink = document.getElementById('nav-lessons');
    const firstDanceLink = document.getElementById('nav-first-dance');
    const scheduleLink = document.getElementById('nav-schedule');
    const trainersLink = document.getElementById('nav-trainers');
    const scheduleSection = document.getElementById('schedule-section');
    const trainersSection = document.getElementById('trainers-section');
    const lessonsSection = document.getElementById('lessons-section');
    const lessonsList = document.getElementById('lessons-list');
    const createLessonBtn = document.getElementById('create-lesson-btn');
    const lessonDetailsSection = document.getElementById('lesson-details-section');
    const firstDanceSection = document.getElementById('first-dance-section');
    const lessonDetailsTitle = document.getElementById('lesson-details-title');
    const addLessonEntryBtn = document.getElementById('add-lesson-entry-btn');
    const deleteLessonBtn = document.getElementById('delete-lesson-btn');
    const lessonEntriesList = document.getElementById('lesson-entries-list');
    const lessonParticipantsSummary = document.getElementById('lesson-participants-summary');
    const lessonTotalEl = document.getElementById('lesson-total');
    const lessonMonthSelect = document.getElementById('lesson-month-select');
    const leSumCount = document.getElementById('le-sum-count');
    const leSumPaidCount = document.getElementById('le-sum-paid-count');
    const leSumPaidAmount = document.getElementById('le-sum-paid-amount');
    const leSumPaidProgress = document.getElementById('le-sum-paid-progress');
    const leSumUnpaidCount = document.getElementById('le-sum-unpaid-count');
    const leSumUnpaidAmount = document.getElementById('le-sum-unpaid-amount');
    const leSumProfit = document.getElementById('le-sum-profit');
    const leSumPotential = document.getElementById('le-sum-potential');
    let selectedLessonMonth = null; // 'YYYY-MM'
    let selectedLessonId = null;
    const addGroupFromScheduleBtn = document.getElementById('add-group-from-schedule');
    const calendarEl = document.getElementById('calendar');
    let calendar;
    // Sidebar toggle
    const sidebar = document.querySelector('.sidebar');
    const mainContentEl = document.querySelector('.main-content');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    function collapseSidebar() {
      if (!sidebar || !mainContentEl) return;
      sidebar.classList.add('collapsed');
      mainContentEl.classList.add('collapsed');
    }
    function expandSidebar() {
      if (!sidebar || !mainContentEl) return;
      sidebar.classList.remove('collapsed');
      mainContentEl.classList.remove('collapsed');
    }
    if (sidebarToggle && sidebar && mainContentEl) {
      sidebarToggle.style.cursor = 'pointer';
      sidebarToggle.addEventListener('click', (ev) => {
        ev.preventDefault(); ev.stopPropagation();
        if (sidebar.classList.contains('collapsed')) expandSidebar(); else collapseSidebar();
      });
      // Fallback: delegate on document
      document.addEventListener('click', (ev) => {
        const btn = ev.target && ev.target.closest ? ev.target.closest('#sidebar-toggle') : null;
        if (!btn) return;
        ev.preventDefault(); ev.stopPropagation();
        if (sidebar.classList.contains('collapsed')) expandSidebar(); else collapseSidebar();
      });
    }

    function setActiveNav(section) {
      if (groupsLink && participantsLink) {
        if (section === 'groups') {
          groupsLink.classList.add('active');
          participantsLink.classList.remove('active');
          if (lessonsLink) lessonsLink.classList.remove('active');
          if (scheduleLink) scheduleLink.classList.remove('active');
          if (trainersLink) trainersLink.classList.remove('active');
          if (firstDanceLink) firstDanceLink.classList.remove('active');
        } else if (section === 'participants') {
          participantsLink.classList.add('active');
          groupsLink.classList.remove('active');
          if (lessonsLink) lessonsLink.classList.remove('active');
          if (scheduleLink) scheduleLink.classList.remove('active');
          if (trainersLink) trainersLink.classList.remove('active');
          if (firstDanceLink) firstDanceLink.classList.remove('active');
        } else if (section === 'lessons') {
          if (lessonsLink) lessonsLink.classList.add('active');
          groupsLink.classList.remove('active');
          participantsLink.classList.remove('active');
          if (scheduleLink) scheduleLink.classList.remove('active');
          if (trainersLink) trainersLink.classList.remove('active');
          if (firstDanceLink) firstDanceLink.classList.remove('active');
        } else if (section === 'schedule') {
          if (scheduleLink) scheduleLink.classList.add('active');
          groupsLink.classList.remove('active');
          participantsLink.classList.remove('active');
          if (lessonsLink) lessonsLink.classList.remove('active');
          if (firstDanceLink) firstDanceLink.classList.remove('active');
          if (trainersLink) trainersLink.classList.remove('active');
        } else if (section === 'first_dance') {
          if (firstDanceLink) firstDanceLink.classList.add('active');
          groupsLink.classList.remove('active');
          participantsLink.classList.remove('active');
          if (lessonsLink) lessonsLink.classList.remove('active');
          if (scheduleLink) scheduleLink.classList.remove('active');
          if (trainersLink) trainersLink.classList.remove('active');
        } else if (section === 'trainers') {
          if (trainersLink) trainersLink.classList.add('active');
          groupsLink.classList.remove('active');
          participantsLink.classList.remove('active');
          if (lessonsLink) lessonsLink.classList.remove('active');
          if (scheduleLink) scheduleLink.classList.remove('active');
          if (firstDanceLink) firstDanceLink.classList.remove('active');
        }
      }
    }
    // Group details section refs
    const groupsSection = document.getElementById('groups-section');
    const groupDetailsSection = document.getElementById('group-details-section');
    const backToGroupsBtn = document.getElementById('back-to-groups-btn');
    const groupDetailsTitle = document.getElementById('group-details-title');
    const monthSelect = document.getElementById('month-select');
    const participantsList = document.getElementById('participants-list');
    const participantsFilter = document.getElementById('participants-filter');
    const addParticipantBtn = document.getElementById('add-participant-btn');
    const addParticipantForm = document.getElementById('add-participant-form');
    const cancelAddParticipant = document.getElementById('cancel-add-participant');
    const saveParticipantBtn = document.getElementById('save-participant-btn');
    const participantFirstName = document.getElementById('participant-first-name');
    const participantLastName = document.getElementById('participant-last-name');
    const participantPhone = document.getElementById('participant-phone');
    const participantMultisport = document.getElementById('participant-multisport');
    // Summary refs
    const sumCountEl = document.getElementById('sum-count');
    const sumPaidCountEl = document.getElementById('sum-paid-count');
    const sumPaidAmountEl = document.getElementById('sum-paid-amount');
    const sumUnpaidCountEl = document.getElementById('sum-unpaid-count');
    const sumUnpaidAmountEl = document.getElementById('sum-unpaid-amount');
    const sumProfitEl = document.getElementById('sum-profit');
    const sumPotentialProfitEl = document.getElementById('sum-potential-profit');
    const sumPaidProgressEl = document.getElementById('sum-paid-progress');

    let selectedGroup = null;
    let selectedMonth = null; // 'YYYY-MM'
    
    function openModal() {
      addGroupModal.classList.add('active');
    }
    
    function closeModal() {
      addGroupModal.classList.remove('active');
      // Reset trybu formularza
      resetGroupFormMode();
    }
    
    addGroupBtn.addEventListener('click', openModal);
    addFirstGroupBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    cancelGroupBtn.addEventListener('click', closeModal);

    // Group details section controls
    function showGroupDetailsSection() {
      groupsSection.style.display = 'none';
      groupDetailsSection.style.display = 'block';
      if (trainersSection) trainersSection.style.display = 'none';
      setActiveNav('groups');
      collapseSidebar();
    }
    function showGroupsSection() {
      groupDetailsSection.style.display = 'none';
      groupsSection.style.display = 'block';
      participantsSection.style.display = 'none';
      if (lessonsSection) lessonsSection.style.display = 'none';
      scheduleSection.style.display = 'none';
      if (trainersSection) trainersSection.style.display = 'none';
      if (firstDanceSection) firstDanceSection.style.display = 'none';
      setActiveNav('groups');
      collapseSidebar();
      // reset
      addParticipantForm.style.display = 'none';
      participantFirstName.value = '';
      participantLastName.value = '';
      participantPhone.value = '';
      participantMultisport.checked = false;
    }
    backToGroupsBtn.addEventListener('click', showGroupsSection);
    // Sidebar 'Grupy' link handler
    if (groupsLink) {
      groupsLink.addEventListener('click', async (e) => {
        try {
          e.preventDefault();
          participantsSection.style.display = 'none';
          groupDetailsSection.style.display = 'none';
          if (lessonsSection) lessonsSection.style.display = 'none';
          if (lessonDetailsSection) lessonDetailsSection.style.display = 'none';
          if (firstDanceSection) firstDanceSection.style.display = 'none';
          scheduleSection.style.display = 'none';
          if (trainersSection) trainersSection.style.display = 'none';
          groupsSection.style.display = 'block';
          setActiveNav('groups');
          collapseSidebar();
          await loadGroups();
        } catch (err) {
          console.error('Błąd przełączania na Grupy:', err);
        }
      });
    }
    
    // Navigate to Participants page
    if (participantsLink) {
      participantsLink.addEventListener('click', async (e) => {
        try {
          e.preventDefault();
          groupsSection.style.display = 'none';
          groupDetailsSection.style.display = 'none';
          if (lessonsSection) lessonsSection.style.display = 'none';
          if (lessonDetailsSection) lessonDetailsSection.style.display = 'none';
          if (firstDanceSection) firstDanceSection.style.display = 'none';
          scheduleSection.style.display = 'none';
          if (trainersSection) trainersSection.style.display = 'none';
          participantsSection.style.display = 'block';
          setActiveNav('participants');
          collapseSidebar();
          await loadAllParticipants();
        } catch (err) {
          console.error('Błąd przełączania na Uczestnicy:', err);
          participantsListAll.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
        }
      });
    }

    // Navigate to Trainers page
    if (trainersLink) {
      trainersLink.addEventListener('click', async (e) => {
        try {
          e.preventDefault();
          groupsSection.style.display = 'none';
          groupDetailsSection.style.display = 'none';
          participantsSection.style.display = 'none';
          if (lessonsSection) lessonsSection.style.display = 'none';
          if (lessonDetailsSection) lessonDetailsSection.style.display = 'none';
          scheduleSection.style.display = 'none';
          if (trainersSection) trainersSection.style.display = 'block';
          setActiveNav('trainers');
          collapseSidebar();
          await loadTrainers();
        } catch (err) {
          console.error('Błąd przełączania na Trenerzy:', err);
        }
      });
    }

    // Navigate to Lessons page (monthly view)
    if (lessonsLink) {
      lessonsLink.addEventListener('click', async (e) => {
        e.preventDefault();
        groupsSection.style.display = 'none';
        groupDetailsSection.style.display = 'none';
        participantsSection.style.display = 'none';
        scheduleSection.style.display = 'none';
        if (trainersSection) trainersSection.style.display = 'none';
        if (firstDanceSection) firstDanceSection.style.display = 'none';
        if (lessonsSection) lessonsSection.style.display = 'none';
        if (lessonDetailsSection) lessonDetailsSection.style.display = 'block';
        if (lessonDetailsTitle) lessonDetailsTitle.textContent = 'Lekcje';
        if (deleteLessonBtn) deleteLessonBtn.style.display = 'none';
        if (lessonParticipantsSummary) lessonParticipantsSummary.style.display = 'none';
        selectedLessonId = null;
        setActiveNav('lessons');
        collapseSidebar();
        await renderLessonsForMonth();
        try { await loadAllParticipants(); } catch {}
      });
    }

    // Navigate to Schedule page
    if (scheduleLink) {
      scheduleLink.addEventListener('click', async (e) => {
        e.preventDefault();
        groupsSection.style.display = 'none';
        groupDetailsSection.style.display = 'none';
        participantsSection.style.display = 'none';
        if (lessonsSection) lessonsSection.style.display = 'none';
        if (firstDanceSection) firstDanceSection.style.display = 'none';
        if (lessonDetailsSection) lessonDetailsSection.style.display = 'none';
        if (trainersSection) trainersSection.style.display = 'none';
        scheduleSection.style.display = 'block';
        setActiveNav('schedule');
        collapseSidebar();
        // Only Google Calendar embed is shown now
      });
    }

    // Navigate to First Dance page
    if (firstDanceLink) {
      firstDanceLink.addEventListener('click', async (e) => {
        e.preventDefault();
        groupsSection.style.display = 'none';
        groupDetailsSection.style.display = 'none';
        participantsSection.style.display = 'none';
        if (lessonsSection) lessonsSection.style.display = 'none';
        if (lessonDetailsSection) lessonDetailsSection.style.display = 'none';
        scheduleSection.style.display = 'none';
        if (trainersSection) trainersSection.style.display = 'none';
        if (firstDanceSection) firstDanceSection.style.display = 'block';
        setActiveNav('first_dance');
        collapseSidebar();
        await renderFirstDanceForMonth();
      });
    }

    if (addGroupFromScheduleBtn) {
      addGroupFromScheduleBtn.addEventListener('click', () => {
        // Reuse existing modal
        openModal();
      });
    }

    function mapPolishDayToFcDays(day) {
      const map = {
        'Niedziela': [0],
        'Poniedziałek': [1],
        'Wtorek': [2],
        'Środa': [3],
        'Czwartek': [4],
        'Piątek': [5],
        'Sobota': [6]
      };
      return map[day] || [];
    }

    async function renderSchedule() {
      try {
        if (!window.FullCalendar) throw new Error('FullCalendar not loaded');
        const { data: groups, error } = await supabase
          .from('groups')
          .select('*');
        if (error) throw error;
        const events = (groups || []).flatMap(g => {
          const days = mapPolishDayToFcDays(g.day);
          return days.map(d => ({
            title: `${g.name} — ${g.trainer}`,
            daysOfWeek: [d],
            startTime: formatTimeHHMM(g.start_time),
            endTime: formatTimeHHMM(g.end_time)
          }));
        });
        if (!calendar) {
          calendar = new window.FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: 'pl',
            height: 'auto',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,dayGridMonth' },
            slotMinTime: '07:00:00',
            slotMaxTime: '23:00:00',
            allDaySlot: false,
            events
          });
          calendar.render();
        } else {
          calendar.removeAllEvents();
          events.forEach(ev => calendar.addEvent(ev));
        }
      } catch (err) {
        console.error('Błąd renderowania harmonogramu:', err);
        if (calendarEl) calendarEl.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
      }
    }
    
    // Edit group modal helpers
    const groupModalTitle = document.getElementById('group-modal-title');
    async function populateTrainerSelect(selectEl, preselectValue = '') {
      try {
        const { data: trainers } = await supabase
          .from('profiles')
          .select('*')
          .eq('role', 'trainer');
        if (!selectEl) return;
        const displayNameOf = (t) => {
          const full = `${(t.first_name||'').trim()} ${(t.last_name||'').trim()}`.trim();
          return full || (t.full_name || t.name || t.username || t.email || '').trim();
        };
        const opts = (trainers || [])
          .map(t => displayNameOf(t))
          .filter(Boolean)
          .sort((a,b)=>a.localeCompare(b));
        const current = preselectValue ? String(preselectValue) : '';
        const seen = new Set();
        selectEl.innerHTML = '<option value="">Wybierz trenera...</option>';
        opts.forEach(name => { if (!seen.has(name)) { seen.add(name); const o=document.createElement('option'); o.value=name; o.textContent=name; selectEl.appendChild(o);} });
        if (current) {
          if (!seen.has(current)) { const o=document.createElement('option'); o.value=current; o.textContent=current; selectEl.appendChild(o); }
          selectEl.value = current;
        }
      } catch {}
    }

    function fillGroupForm(g) {
      document.getElementById('group-name').value = g.name || '';
      document.getElementById('group-day').value = g.day || 'Poniedziałek';
      document.getElementById('group-start').value = g.start_time || '';
      document.getElementById('group-end').value = g.end_time || '';
      const sel = document.getElementById('group-trainer-select');
      if (sel) { populateTrainerSelect(sel, g.trainer || ''); }
      document.getElementById('group-fee').value = g.fee ?? '';
      document.getElementById('group-multisport').value = g.multisport ?? '';
      document.getElementById('group-months').value = g.months ?? '';
      document.getElementById('group-color').value = g.color || '';
    }
    function openEditGroupModal(group) {
      groupModalTitle.textContent = 'Edytuj grupę';
      fillGroupForm(group);
      addGroupModal.classList.add('active');
      saveGroupBtn.dataset.editId = group.id;
      saveGroupBtn.dataset.editGoogleId = group.google_event_id || '';
    }
    function resetGroupFormMode() {
      groupModalTitle.textContent = 'Dodaj nową grupę';
      delete saveGroupBtn.dataset.editId;
      delete saveGroupBtn.dataset.editGoogleId;
      document.getElementById('group-name').value = '';
      document.getElementById('group-start').value = '';
      document.getElementById('group-end').value = '';
      const sel = document.getElementById('group-trainer-select');
      if (sel) { populateTrainerSelect(sel, ''); }
      document.getElementById('group-fee').value = '';
      document.getElementById('group-multisport').value = '';
      document.getElementById('group-months').value = '';
      document.getElementById('group-color').value = '';
    }
    
    // Save group function (add or edit)
    saveGroupBtn.addEventListener('click', async () => {
      const name = document.getElementById('group-name').value;
      const day = document.getElementById('group-day').value;
      const start = document.getElementById('group-start').value;
      const end = document.getElementById('group-end').value;
      const trainer = (document.getElementById('group-trainer-select')?.value || '').trim();
      const fee = parseFloat(document.getElementById('group-fee').value);
      const multisport = parseFloat(document.getElementById('group-multisport').value);
      const monthsVal = parseInt(document.getElementById('group-months').value || '0', 10) || null;
      const colorVal = document.getElementById('group-color').value || '';
      
      // Walidacja pól
      if (!name || !day || !start || !end || !trainer || isNaN(fee) || isNaN(multisport)) {
        alert('Proszę wypełnić wszystkie pola poprawnie');
        return;
      }
      
      // Zmień tekst przycisku na ładowanie
      const originalText = saveGroupBtn.innerHTML;
      saveGroupBtn.innerHTML = '<span class="loading"></span> Zapisywanie...';
      saveGroupBtn.disabled = true;
      
      try {
        const editId = saveGroupBtn.dataset.editId;
        let error, data;
        if (editId) {
          ({ error } = await supabase
          .from('groups')
            .update({ name, day, start_time: start, end_time: end, trainer, fee, multisport, months: monthsVal, color: colorVal })
            .eq('id', editId));

          // Calendar: update or create if missing
          const { next_start_iso, next_end_iso, byday_code } = safeComputeNextIsoPair(day, start, end);
          const googleEventId = saveGroupBtn.dataset.editGoogleId || '';
          if (googleEventId) {
            await sendCalendarRequest({
              action: 'update', id: editId, name, trainer, day_pl: day,
              byday_code, start_time: start, end_time: end,
              next_start_iso, next_end_iso,
              google_event_id: googleEventId,
              months: monthsVal, color: colorVal,
              calendar_id: DEFAULT_CALENDAR_ID, timezone: DEFAULT_TIMEZONE
            }).then(r=>{ if(!r?.ok){ console.warn('Calendar update warning', r); } });
          } else {
            const resp = await sendCalendarRequest({
              action: 'create', id: editId, name, trainer, day_pl: day,
              byday_code, start_time: start, end_time: end,
              next_start_iso, next_end_iso,
              months: monthsVal, color: colorVal,
              calendar_id: DEFAULT_CALENDAR_ID, timezone: DEFAULT_TIMEZONE
            });
            if (resp && resp.ok && resp.eventId) {
              await supabase.from('groups').update({ google_event_id: resp.eventId }).eq('id', editId);
            } else if (resp && !resp.ok) {
              console.warn('Calendar create warning', resp);
            }
          }
        } else {
          const insertRes = await supabase
            .from('groups')
            .insert([{ name, day, start_time: start, end_time: end, trainer, fee, multisport, months: monthsVal, color: colorVal }])
            .select();
          data = insertRes.data;
          error = insertRes.error;
          if (!error && data && data[0]) {
            const g = data[0];
            const { next_start_iso, next_end_iso, byday_code } = safeComputeNextIsoPair(day, start, end);
            const resp = await sendCalendarRequest({
              action: 'create', id: g.id, name, trainer, day_pl: day,
              byday_code, start_time: start, end_time: end,
              next_start_iso, next_end_iso,
              months: monthsVal, color: colorVal,
              calendar_id: DEFAULT_CALENDAR_ID, timezone: DEFAULT_TIMEZONE
            });
            if (resp && resp.ok && resp.eventId) {
              await supabase.from('groups').update({ google_event_id: resp.eventId }).eq('id', g.id);
            } else if (resp && !resp.ok) {
              console.warn('Calendar create warning', resp);
            }
          }
        }
          
        if (error) {
          console.error('Błąd dodawania grupy:', error);
          alert('Błąd dodawania grupy: ' + error.message);
        } else {
          console.log('Grupa zapisana pomyślnie:', data);
          alert('Grupa zapisana pomyślnie!');
          closeModal();
          loadGroups();
        }
      } catch (err) {
        console.error('Nieoczekiwany błąd:', err);
        alert('Wystąpił nieoczekiwany błąd: ' + err.message);
      } finally {
        // Przywróć oryginalny tekst przycisku
        saveGroupBtn.innerHTML = originalText;
        saveGroupBtn.disabled = false;
      }
    });
    
    // Wczytanie wszystkich grup
    async function loadGroups() {
      // Pokaż stan ładowania
      groupsList.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie grup...</p></div>';
      
      try {
        const { data, error } = await supabase
          .from('groups')
          .select('*')
          .order('day', { ascending: true })
          .order('start_time', { ascending: true });
          
        if (error) {
          console.error('Błąd wczytywania grup:', error);
          groupsList.innerHTML = '<div class="empty-state"><p>Błąd wczytywania grup: ' + error.message + '</p></div>';
          return;
        }
        
        if (!data || data.length === 0) {
          // Pokaż stan pustej listy
          emptyState.style.display = 'block';
          groupsList.innerHTML = '';
          groupsList.appendChild(emptyState);
          return;
        }
        
        // Ukryj stan pustej listy
        emptyState.style.display = 'none';
        
        // Wyczyść listę i zgrupuj po dniu tygodnia
        groupsList.innerHTML = '';
        const dayOrder = ['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'];
        const byDay = new Map();
        data.forEach(g => {
          if (!byDay.has(g.day)) byDay.set(g.day, []);
          byDay.get(g.day).push(g);
        });
        const rendered = new Set();
        const renderDaySection = (dayLabel, list) => {
          if (!list || list.length === 0) return;
          const header = document.createElement('div');
          header.className = 'groups-day-header';
          header.innerHTML = `<h3 style="font-size:1rem; color: var(--text-gray);"><i class="fas fa-calendar-day" style="color: var(--gold); margin-right:6px;"></i>${dayLabel}</h3>`;
          groupsList.appendChild(header);
          list.forEach(group => {
          const groupCard = document.createElement('div');
          groupCard.className = 'group-card';
            const startHHMM = formatTimeHHMM(group.start_time);
            const endHHMM = formatTimeHHMM(group.end_time);
          groupCard.innerHTML = `
            <h4>${group.name}</h4>
            <div class="group-detail">
              <i class="fas fa-calendar-day"></i>
                <span>${group.day}, ${startHHMM} - ${endHHMM}</span>
            </div>
            <div class="group-detail">
              <i class="fas fa-user-tie"></i>
              <span>${group.trainer}</span>
            </div>
            <div class="group-detail">
              <i class="fas fa-money-bill-wave"></i>
              <span>Opłata: ${group.fee} zł</span>
            </div>
            <div class="group-detail">
              <i class="fas fa-credit-card"></i>
              <span>Multisport: ${group.multisport} zł</span>
            </div>
            <div class="group-actions">
              <button class="btn btn-outline edit-btn" data-id="${group.id}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-outline delete-btn" data-id="${group.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
            groupCard.addEventListener('click', (e) => {
              if (e.target.closest('.edit-btn') || e.target.closest('.delete-btn')) return;
              openGroupDetails(group);
            });
            groupCard.querySelector('.edit-btn').addEventListener('click', (e) => {
              e.stopPropagation();
              openEditGroupModal(group);
            });
            groupCard.querySelector('.delete-btn').addEventListener('click', async (e) => {
              e.stopPropagation();
              if (!confirm('Usunąć grupę? Spowoduje to usunięcie uczestników i płatności powiązanych.')) return;
              try {
                // Pobierz świeże google_event_id z bazy (grupa mogła być zaktualizowana po renderze)
                const fresh = await supabase.from('groups').select('google_event_id').eq('id', group.id).maybeSingle();
                const evId = fresh?.data?.google_event_id || group.google_event_id || '';
                if (evId) {
                  // Always attempt calendar delete (fallback on SUPA_GROUP_ID if no eventId)
                  const delResp = await sendCalendarRequest({
                    action: 'delete', id: group.id, google_event_id: evId || '',
                    calendar_id: DEFAULT_CALENDAR_ID, timezone: DEFAULT_TIMEZONE
                  });
                  if (delResp && !delResp.ok) {
                    console.warn('Calendar delete warning:', delResp);
                  }
                }
                const { error } = await supabase.from('groups').delete().eq('id', group.id);
                if (error) throw error;
                await loadGroups();
              } catch (err) {
                alert('Błąd usuwania grupy: ' + (err.message || 'Nieznany'));
              }
            });
          groupsList.appendChild(groupCard);
          });
        };
        dayOrder.forEach(day => {
          const arr = byDay.get(day);
          if (arr && arr.length) {
            renderDaySection(day, arr);
            rendered.add(day);
          }
        });
        // Render all remaining unexpected day keys
        byDay.forEach((arr, day) => {
          if (!rendered.has(day)) renderDaySection(day, arr);
        });
      } catch (err) {
        console.error('Nieoczekiwany błąd:', err);
        groupsList.innerHTML = '<div class="empty-state"><p>Wystąpił nieoczekiwany błąd: ' + err.message + '</p></div>';
      }
    }

    // Pomocnicze: lista 12 miesięcy (bieżący + 11 wstecz)
    function getLast12MonthsOptions() {
      const formatter = new Intl.DateTimeFormat('pl-PL', { month: 'long', year: 'numeric' });
      const options = [];
      const now = new Date();
      for (let i = 0; i < 12; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const value = `${yyyy}-${mm}`;
        const label = formatter.format(d);
        options.push({ value, label });
      }
      return options;
    }

    function populateMonthSelect(defaultValue) {
      monthSelect.innerHTML = '';
      const opts = getLast12MonthsOptions();
      opts.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        monthSelect.appendChild(opt);
      });
      if (defaultValue) {
        monthSelect.value = defaultValue;
      } else {
        monthSelect.selectedIndex = 0;
      }
      selectedMonth = monthSelect.value;
    }

    // Format time HH:MM (hide seconds)
    function formatTimeHHMM(t) {
      if (!t) return '';
      const parts = String(t).split(':');
      return parts.length >= 2 ? `${parts[0]}:${parts[1]}` : String(t);
    }

    // Otwieranie szczegółów grupy
    function openGroupDetails(group) {
      selectedGroup = group;
      groupDetailsTitle.textContent = `${group.name}`;
      populateMonthSelect(selectedMonth);
      showGroupDetailsSection();
      loadParticipantsAndPayments();

      // Prepare attendance UI state
      setupAttendanceTabs();
      populateAttendanceMonthSelect();
      renderAttendanceDates();
      renderAttendanceList();
    }

    function updateParticipantsSummary({ totalCount, paidCount, unpaidCount, paidAmount, unpaidAmount, profit }) {
      if (!sumCountEl) return;
      sumCountEl.textContent = String(totalCount ?? 0);
      sumPaidCountEl.textContent = String(paidCount ?? 0);
      sumPaidAmountEl.textContent = `${(paidAmount ?? 0).toFixed(2)} zł`;
      sumPaidAmountEl.style.color = 'var(--success)';
      sumUnpaidCountEl.textContent = String(unpaidCount ?? 0);
      sumUnpaidAmountEl.textContent = `${(unpaidAmount ?? 0).toFixed(2)} zł`;
      sumUnpaidAmountEl.style.color = 'var(--error)';
      sumProfitEl.textContent = `${(profit ?? 0).toFixed(2)} zł`;
      const potential = (paidAmount ?? 0) + (unpaidAmount ?? 0);
      if (sumPotentialProfitEl) sumPotentialProfitEl.textContent = `${potential.toFixed(2)} zł`;
      const totalForProgress = Math.max(1, (paidCount ?? 0) + (unpaidCount ?? 0));
      const percent = Math.min(100, Math.max(0, Math.round(((paidCount ?? 0) / totalForProgress) * 100)));
      if (sumPaidProgressEl) sumPaidProgressEl.style.width = percent + '%';
    }

    // Ładowanie uczestników + płatności dla wybranego miesiąca
    async function loadParticipantsAndPayments() {
      if (!selectedGroup || !selectedMonth) return;
      participantsList.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie uczestników...</p></div>';
      try {
        const { data: pgRows, error: pgErr } = await supabase
          .from('participant_groups')
          .select('participant_id, effective_from_month, effective_to_month')
          .eq('group_id', selectedGroup.id);
        if (pgErr) throw pgErr;
        // Filter memberships active for selectedMonth: from <= month < to
        const activeRows = (pgRows || []).filter(r => {
          const fromOk = !r.effective_from_month || r.effective_from_month <= selectedMonth;
          const toOk = !r.effective_to_month || r.effective_to_month > selectedMonth;
          return fromOk && toOk;
        });
        if (!activeRows || activeRows.length === 0) {
          participantsList.innerHTML = '<div class="empty-state"><p>Brak uczestników w tej grupie</p></div>';
          updateParticipantsSummary({ totalCount: 0, paidCount: 0, unpaidCount: 0, paidAmount: 0, unpaidAmount: 0, profit: 0 });
          return;
        }
        const pIds = activeRows.map(r => r.participant_id);
        const { data: participants, error: participantsError } = await supabase
          .from('participants')
          .select('*')
          .in('id', pIds)
          .order('last_name', { ascending: true });
        if (participantsError) throw participantsError;

        const participantIds = participants.map(p => p.id);
        const { data: payments, error: paymentsError } = await supabase
          .from('payments')
          .select('*')
          .in('participant_id', participantIds)
          .eq('month', selectedMonth);
        if (paymentsError) throw paymentsError;

        const paymentByParticipant = new Map();
        (payments || []).forEach(pay => paymentByParticipant.set(pay.participant_id, pay));

        // Renderuj
        const fragment = document.createDocumentFragment();
        const filterValue = (participantsFilter && participantsFilter.value) ? participantsFilter.value : 'all';
        const listToRender = participants.filter(p => {
          const pay = paymentByParticipant.get(p.id) || null;
          if (filterValue === 'paid') return !!(pay && pay.confirmed);
          if (filterValue === 'unpaid') return !(pay && pay.confirmed);
          return true;
        });

        if (listToRender.length === 0) {
          participantsList.innerHTML = '<div class="empty-state"><p>Brak wyników dla wybranego filtra</p></div>';
          // Summary zerowe
          updateParticipantsSummary({
            totalCount: participants.length,
            paidCount: 0,
            unpaidCount: 0,
            paidAmount: 0,
            unpaidAmount: 0,
            profit: 0
          });
          return;
        }

        let paidCount = 0;
        let unpaidCount = 0;
        let paidAmount = 0;
        let unpaidAmount = 0;

        listToRender.forEach((p, index) => {
          const pay = paymentByParticipant.get(p.id) || null;
          const baseAmount = p.multisport ? Number(selectedGroup.multisport || 0) : Number(selectedGroup.fee || 0);
          const amountToShow = pay && typeof pay.amount === 'number' ? pay.amount : baseAmount;
          const selectedMethod = pay && typeof pay.method === 'string' ? pay.method : '';
          const comment = pay && typeof pay.comment === 'string' ? pay.comment : '';

          if (pay && pay.confirmed) {
            paidCount += 1;
            paidAmount += Number(pay.amount || 0);
          } else {
            unpaidCount += 1;
            // Jeśli mamy niepotwierdzony wpis płatności z edytowaną kwotą, uwzględnij tę kwotę;
            // w przeciwnym razie użyj kwoty bazowej z grupy
            const unpaidVal = (pay && typeof pay.amount === 'number') ? Number(pay.amount) : Number(baseAmount);
            unpaidAmount += unpaidVal;
          }

          const row = document.createElement('div');
          row.className = 'content-box participant-row';
          row.style.marginBottom = '10px';
          row.dataset.participantId = p.id;
          if (pay && pay.confirmed) {
            row.classList.add('paid');
          } else {
            row.classList.add('unpaid');
          }
          row.innerHTML = `
            <div style="display:flex; flex-wrap: wrap; gap: 6px; align-items: center;">
              <div style="flex: 0 0 24px; min-width: 24px; text-align:center; color: var(--gold); font-weight: 600;">${index + 1}</div>
              <div style="flex: 1 1 110px; min-width: 110px;">
                <div style="font-weight:600; font-size: 0.95rem;">${p.first_name || ''} ${p.last_name || ''}</div>
                <div style="color: var(--text-gray); font-size: 0.72rem; line-height: 1.1;">${p.phone || ''} · ${p.multisport ? 'Multisport' : 'Std'}</div>
              </div>
              <div style="flex: 0 0 110px; min-width: 100px;">
                <input title="Kwota (${selectedMonth})" type="number" step="0.01" class="form-control small payment-amount" value="${amountToShow}" data-initial="${amountToShow}" />
              </div>
              <div style="flex: 0 0 120px; min-width: 110px;">
                <select title="Metoda" class="form-control small payment-method">
                  <option value="">Metoda...</option>
                  <option value="card" ${selectedMethod === 'card' ? 'selected' : ''}>Karta</option>
                  <option value="transfer" ${selectedMethod === 'transfer' ? 'selected' : ''}>Przelew</option>
                  <option value="cash" ${selectedMethod === 'cash' ? 'selected' : ''}>Gotówka</option>
                </select>
              </div>
              <div style="flex: 1 1 160px; min-width: 140px;">
                <input title="Komentarz" type="text" class="form-control small payment-comment" placeholder="Komentarz" value="${comment.replace(/"/g, '&quot;')}" />
              </div>
              <div style="flex: 0 0 auto; display:flex; gap:6px; align-items:center;">
                <button class="btn btn-primary btn-sm confirm-payment-btn">${pay && pay.confirmed ? 'Zapisz' : 'OK'}</button>
                ${pay ? '<button class="btn btn-outline btn-sm delete-payment-btn" title="Usuń płatność"><i class="fas fa-xmark"></i></button>' : ''}
                <span class="status" style="color:${pay && pay.confirmed ? 'var(--success)' : 'var(--text-gray)'}; font-size:0.8rem; white-space:nowrap;">${pay && pay.confirmed ? 'OK' : 'Brak'}</span>
              </div>
              <div style="flex: 1 1 100px; min-width: 100px; display:flex; gap:6px; align-items:center; justify-content:flex-end;">
                <label style="display:flex; align-items:center; gap:6px; color: var(--text-gray); font-size:0.8rem;">
                  <input type="checkbox" class="consent-checkbox" ${p.consent_signed ? 'checked' : ''} style="width:auto;"/>
                  Zgoda
                </label>
                <button class="btn btn-outline btn-sm delete-participant-btn" title="Usuń uczestnika"><i class="fas fa-user-minus"></i></button>
              </div>
            </div>
          `;
          fragment.appendChild(row);
        });
        participantsList.innerHTML = '';
        participantsList.appendChild(fragment);

        // Podsumowania: prosty zysk = suma zapłacona (brutto). Jeśli chcesz inne koszty, doprecyzuj.
        updateParticipantsSummary({
          totalCount: participants.length,
          paidCount,
          unpaidCount,
          paidAmount,
          unpaidAmount,
          profit: paidAmount
        });
      } catch (err) {
        console.error('Błąd ładowania uczestników/płatności:', err);
        participantsList.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
      }
    }

    // Auto-save amount edits (unconfirmed) on group participants list
    if (participantsList) participantsList.addEventListener('change', async (e) => {
      const input = e.target.closest('.payment-amount');
      if (!input) return;
      const row = e.target.closest('[data-participant-id]');
      if (!row) return;
      const participantId = row.dataset.participantId;
      const newAmount = parseFloat(input.value);
      if (isNaN(newAmount) || newAmount < 0) { alert('Podaj poprawną kwotę'); input.value = input.dataset.initial || '0'; return; }
      try {
        const { data: existing } = await supabase
          .from('payments')
          .select('id')
          .eq('participant_id', participantId)
          .eq('month', selectedMonth)
          .maybeSingle();
        if (existing) {
          const { error } = await supabase
            .from('payments')
            .update({ amount: newAmount })
            .eq('id', existing.id);
          if (error) throw error;
        } else {
          const { error } = await supabase
            .from('payments')
            .insert([{ participant_id: participantId, month: selectedMonth, amount: newAmount, confirmed: false }]);
          if (error) throw error;
        }
        input.dataset.initial = String(newAmount);
        await loadParticipantsAndPayments();
      } catch (err) {
        alert('Błąd zapisu kwoty: ' + (err.message || 'Nieznany'));
      }
    });

    // Zmiana miesiąca
    monthSelect.addEventListener('change', () => {
      selectedMonth = monthSelect.value;
      loadParticipantsAndPayments();
    });

    // Filtr uczestników
    if (participantsFilter) {
      participantsFilter.addEventListener('change', () => {
        loadParticipantsAndPayments();
      });
    }

    // Dodawanie uczestnika - UI toggle
    addParticipantBtn.addEventListener('click', () => {
      addParticipantForm.style.display = addParticipantForm.style.display === 'none' ? 'block' : 'none';
    });
    cancelAddParticipant.addEventListener('click', () => {
      addParticipantForm.style.display = 'none';
      participantFirstName.value = '';
      participantLastName.value = '';
      participantPhone.value = '';
      participantMultisport.checked = false;
    });

    // Zapis nowego uczestnika (tworzy powiązanie w participant_groups)
    saveParticipantBtn.addEventListener('click', async () => {
      if (!selectedGroup) return;
      const fn = participantFirstName.value.trim();
      const ln = participantLastName.value.trim();
      const phone = participantPhone.value.trim();
      const multi = !!participantMultisport.checked;
      if (!fn || !ln) {
        alert('Podaj imię i nazwisko');
        return;
      }
      saveParticipantBtn.disabled = true;
      const original = saveParticipantBtn.innerHTML;
      saveParticipantBtn.innerHTML = '<span class="loading"></span> Zapisywanie...';
      try {
        const insertRes = await supabase
          .from('participants')
          .insert([{ first_name: fn, last_name: ln, phone, multisport: multi, consent_signed: false }])
          .select()
          .single();
        if (insertRes.error) throw insertRes.error;
        const newParticipant = insertRes.data;
        const linkRes = await supabase
          .from('participant_groups')
          .insert([{ participant_id: newParticipant.id, group_id: selectedGroup.id, effective_from_month: selectedMonth }]);
        if (linkRes.error) throw linkRes.error;
        addParticipantForm.style.display = 'none';
        participantFirstName.value = '';
        participantLastName.value = '';
        participantPhone.value = '';
        participantMultisport.checked = false;
        await loadParticipantsAndPayments();
      } catch (err) {
        alert('Błąd dodawania uczestnika: ' + (err.message || 'Nieznany'));
      } finally {
        saveParticipantBtn.disabled = false;
        saveParticipantBtn.innerHTML = original;
      }
    });

    // Delegacja zdarzeń na liście uczestników: potwierdzenie płatności, zgoda, usunięcie
    participantsList.addEventListener('click', async (e) => {
      const row = e.target.closest('[data-participant-id]');
      if (!row) return;
      const participantId = row.dataset.participantId;

      // Potwierdzenie/Zapis płatności
      if (e.target.closest('.confirm-payment-btn')) {
        const amountInput = row.querySelector('.payment-amount');
        const amount = parseFloat(amountInput.value);
        const methodInput = row.querySelector('.payment-method');
        const commentInput = row.querySelector('.payment-comment');
        const method = methodInput ? methodInput.value : '';
        const comment = commentInput ? commentInput.value.trim() : '';
        if (isNaN(amount) || amount < 0) {
          alert('Podaj poprawną kwotę');
          return;
        }
        if (!method) {
          alert('Wybierz metodę płatności');
          return;
        }
        const btn = e.target.closest('.confirm-payment-btn');
        const original = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span>';
        try {
          // Spróbuj znaleźć istniejącą płatność
          const { data: existing, error: selErr } = await supabase
            .from('payments')
            .select('id')
            .eq('participant_id', participantId)
            .eq('month', selectedMonth)
            .limit(1)
            .maybeSingle();
          if (selErr) throw selErr;
          if (existing) {
            const { error: updErr } = await supabase
              .from('payments')
              .update({ amount, method, comment, confirmed: true, confirmed_at: new Date().toISOString() })
              .eq('id', existing.id);
            if (updErr) throw updErr;
          } else {
            const { error: insErr } = await supabase
              .from('payments')
              .insert([{ participant_id: participantId, month: selectedMonth, amount, method, comment, confirmed: true, confirmed_at: new Date().toISOString() }]);
            if (insErr) throw insErr;
          }
          await loadParticipantsAndPayments();
        } catch (err) {
          alert('Błąd zapisu płatności: ' + (err.message || 'Nieznany'));
        } finally {
          btn.disabled = false;
          btn.innerHTML = original;
        }
      }

      // Usuwanie uczestnika z grupy: zawsze usuń tylko powiązanie (uczestnik pozostaje w systemie i lekcjach)
      if (e.target.closest('.delete-participant-btn')) {
        if (!confirm('Usunąć uczestnika z tej grupy?')) return;
        try {
          const { error: delLinkErr } = await supabase
            .from('participant_groups')
            .update({ effective_to_month: selectedMonth })
            .eq('participant_id', participantId)
            .eq('group_id', selectedGroup.id);
          if (delLinkErr) throw delLinkErr;
          await loadParticipantsAndPayments();
        } catch (err) {
          alert('Błąd usuwania uczestnika: ' + (err.message || 'Nieznany'));
        }
      }

      // Usuwanie płatności dla wybranego miesiąca
      if (e.target.closest('.delete-payment-btn')) {
        if (!confirm('Usunąć płatność dla tego miesiąca?')) return;
        try {
          const { data: existing, error: selErr } = await supabase
            .from('payments')
            .select('id')
            .eq('participant_id', participantId)
            .eq('month', selectedMonth)
            .limit(1)
            .maybeSingle();
          if (selErr) throw selErr;
          if (existing) {
            const { error: delErr } = await supabase
              .from('payments')
              .delete()
              .eq('id', existing.id);
            if (delErr) throw delErr;
          }
          await loadParticipantsAndPayments();
        } catch (err) {
          alert('Błąd usuwania płatności: ' + (err.message || 'Nieznany'));
        }
      }
    });

    // Zgoda podpisana - change na checkboxie
    participantsList.addEventListener('change', async (e) => {
      const row = e.target.closest('[data-participant-id]');
      if (!row) return;
      if (e.target.classList.contains('consent-checkbox')) {
        const participantId = row.dataset.participantId;
        const checked = !!e.target.checked;
        try {
          const { error } = await supabase
            .from('participants')
            .update({ consent_signed: checked })
            .eq('id', participantId);
          if (error) throw error;
        } catch (err) {
          alert('Błąd zapisu zgody: ' + (err.message || 'Nieznany'));
          // rollback UI
          e.target.checked = !e.target.checked;
        }
      }
    });
    
    // -------- Participants page logic --------
    async function loadAllParticipants() {
      participantsListAll.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie uczestników...</p></div>';
      const inactiveContainer = document.getElementById('participants-list-inactive');
      if (inactiveContainer) inactiveContainer.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie nieaktywnych...</p></div>';
      try {
        const [{ data: participants, error: pErr }, { data: groups, error: gErr }, { data: allLinks } ] = await Promise.all([
          supabase.from('participants').select('*').order('last_name', { ascending: true }),
          supabase.from('groups').select('id,name,fee,multisport'),
          supabase.from('participant_groups').select('participant_id, group_id')
        ]);
        if (pErr) throw pErr;
        if (gErr) throw gErr;
        if (!participants || participants.length === 0) {
          participantsListAll.innerHTML = '<div class="empty-state"><p>Brak uczestników</p></div>';
          return;
        }
        const groupIdToName = new Map(groups.map(g => [g.id, g.name]));
        const linksByParticipant = new Map();
        (allLinks || []).forEach(l => {
          const arr = linksByParticipant.get(l.participant_id) || [];
          arr.push(l.group_id);
          linksByParticipant.set(l.participant_id, arr);
        });
        const participantIds = participants.map(p => p.id);
        const { data: payments, error: payErr } = await supabase
          .from('payments')
          .select('participant_id, amount, confirmed')
          .in('participant_id', participantIds);
        if (payErr) throw payErr;
        const payAgg = new Map();
        (payments || []).forEach(pay => {
          const agg = payAgg.get(pay.participant_id) || { paid: 0, unpaid: 0 };
          if (pay.confirmed) agg.paid += Number(pay.amount || 0);
          else agg.unpaid += Number(pay.amount || 0);
          payAgg.set(pay.participant_id, agg);
        });

        // Compute expected unpaid for current month for groups
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const currentMonth = `${yyyy}-${mm}`;
        const { data: paymentsMonth, error: payMonthErr } = await supabase
          .from('payments')
          .select('participant_id, amount, confirmed, month')
          .in('participant_id', participantIds)
          .eq('month', currentMonth);
        if (payMonthErr) throw payMonthErr;
        const paidMonth = new Map();
        (paymentsMonth || []).forEach(p => {
          const prev = paidMonth.get(p.participant_id) || 0;
          const add = p.confirmed ? Number(p.amount || 0) : 0;
          paidMonth.set(p.participant_id, prev + add);
        });
        const groupById = new Map((groups || []).map(g => [g.id, g]));

        // Lessons aggregation per participant (include both paid and unpaid)
        const { data: lpLinks, error: lpErr } = await supabase
          .from('lesson_participants')
          .select('lesson_id, participant_id')
          .in('participant_id', participantIds);
        if (lpErr) throw lpErr;
        const lessonIds = Array.from(new Set((lpLinks || []).map(l => l.lesson_id)));
        let leEntries = [];
        if (lessonIds.length) {
          const { data: le, error: leErr } = await supabase
            .from('lesson_entries')
            .select('lesson_id, amount, confirmed')
            .in('lesson_id', lessonIds);
          if (leErr) throw leErr;
          leEntries = le || [];
        }
        // Count participants per lesson (full counts)
        let lpAll = lpLinks || [];
        if (lessonIds.length) {
          const { data: lpAllData, error: lpAllErr } = await supabase
            .from('lesson_participants')
            .select('lesson_id, participant_id')
            .in('lesson_id', lessonIds);
          if (!lpAllErr && lpAllData) lpAll = lpAllData;
        }
        const lessonIdToParticipants = new Map();
        (lpAll || []).forEach(l => {
          const arr = lessonIdToParticipants.get(l.lesson_id) || [];
          arr.push(l.participant_id);
          lessonIdToParticipants.set(l.lesson_id, arr);
        });
        const leAgg = new Map();
        (leEntries || []).forEach(ent => {
          const pList = lessonIdToParticipants.get(ent.lesson_id) || [];
          const share = Number(ent.amount || 0) / Math.max(1, pList.length);
          pList.forEach(pid => {
            const agg = leAgg.get(pid) || { paid: 0, unpaid: 0 };
            if (ent.confirmed) agg.paid += share; else agg.unpaid += share;
            leAgg.set(pid, agg);
          });
        });

        // Render list with numbering
        const fragmentActive = document.createDocumentFragment();
        const fragmentInactive = document.createDocumentFragment();
        let activeCount = 0;
        let inactiveCount = 0;
        const paidFilter = document.getElementById('filter-paid');
        const unpaidFilter = document.getElementById('filter-unpaid');
        const paidEnabled = paidFilter ? paidFilter.checked : false;
        const unpaidEnabled = unpaidFilter ? unpaidFilter.checked : false;
        participants.forEach((p, idx) => {
          const gAgg = payAgg.get(p.id) || { paid: 0, unpaid: 0 };
          const lAgg = leAgg.get(p.id) || { paid: 0, unpaid: 0 };
          // Expected base for current month from group memberships
          const gIds = linksByParticipant.get(p.id) || [];
          const expectedBase = gIds.reduce((sum, gid) => {
            const g = groupById.get(gid); if (!g) return sum;
            const base = p.multisport ? Number(g.multisport || 0) : Number(g.fee || 0);
            return sum + (isNaN(base) ? 0 : base);
          }, 0);
          const paidForMonth = paidMonth.get(p.id) || 0;
          const unpaidExpectedMonth = Math.max(0, expectedBase - paidForMonth);
          const agg = { paid: (gAgg.paid + lAgg.paid), unpaid: (gAgg.unpaid + lAgg.unpaid + unpaidExpectedMonth) };
          const card = document.createElement('div');
          card.className = 'group-card';
          card.dataset.pid = p.id;
          const groupNames = (linksByParticipant.get(p.id) || []).map(id => groupIdToName.get(id) || '-');
          card.innerHTML = `
            <h4><span class="p-index">${idx + 1}</span>${p.first_name || ''} ${p.last_name || ''}</h4>
            <div class="group-detail"><i class="fas fa-phone"></i><span>${p.phone || ''}</span></div>
            <div class="group-detail"><i class="fas fa-money-bill-wave"></i><span>Zapłacone: <span style=\"color: var(--success);\">${agg.paid.toFixed(2)} zł</span> · Niezapłacone: <span style=\"color: var(--error);\">${agg.unpaid.toFixed(2)} zł</span></span></div>
            <div class="group-detail"><i class="fas fa-users"></i><span>Grupy: ${groupNames.length ? groupNames.join(', ') : '-'}</span></div>
            <div class="group-actions">
              <button class="btn btn-outline edit-participant-btn" data-id="${p.id}"><i class="fas fa-edit"></i></button>
              <button class="btn btn-outline delete-participant-global-btn" data-id="${p.id}"><i class="fas fa-trash"></i></button>
            </div>
          `;
          const hasAnyGroup = (linksByParticipant.get(p.id) || []).length > 0;
          const hasAnyLesson = !!leAgg.get(p.id); // ma jakiekolwiek przypisanie do lekcji
          const totalPaid = (gAgg.paid + lAgg.paid);
          const totalUnpaid = (gAgg.unpaid + lAgg.unpaid + unpaidExpectedMonth);
          // Apply multi-filter (both can be on): if both off => no filter; if one on => must match; if both on => always show
          let matchPaidFilter = true;
          if (paidEnabled && !unpaidEnabled) matchPaidFilter = totalPaid > 0;
          if (!paidEnabled && unpaidEnabled) matchPaidFilter = totalUnpaid > 0;
          // both enabled or both disabled => true
          if (!matchPaidFilter) {
            return; // skip rendering this participant in active list
          }
          if (hasAnyGroup || hasAnyLesson) {
            fragmentActive.appendChild(card);
            activeCount += 1;
          } else {
            fragmentInactive.appendChild(card);
            inactiveCount += 1;
          }
        });
        // Active
        participantsListAll.innerHTML = '';
        if (activeCount) participantsListAll.appendChild(fragmentActive); else participantsListAll.innerHTML = '<div class="empty-state"><p>Brak uczestników</p></div>';
        renumberVisibleParticipants();
        // Inactive
        if (inactiveContainer) {
          inactiveContainer.innerHTML = '';
          if (inactiveCount) inactiveContainer.appendChild(fragmentInactive); else inactiveContainer.innerHTML = '<div class="empty-state"><p>Brak nieaktywnych</p></div>';
        }
      } catch (err) {
        participantsListAll.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
        const inactiveContainer = document.getElementById('participants-list-inactive');
        if (inactiveContainer) inactiveContainer.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
      }
    }

    function renumberVisibleParticipants() {
      if (!participantsListAll) return;
      const cards = Array.from(participantsListAll.querySelectorAll('.group-card'));
      let counter = 1;
      cards.forEach(card => {
        if (card.style.display === 'none') return;
        const badge = card.querySelector('.p-index');
        if (badge) badge.textContent = String(counter++);
      });
    }

    // Floating preview modal for participant unpaid details
    const previewModal = document.createElement('div');
    previewModal.className = 'modal';
    previewModal.id = 'participant-preview-modal';
    previewModal.innerHTML = `
      <div class="modal-content" style="max-width:600px;">
        <button class="modal-close" id="close-preview-modal"><i class="fas fa-times"></i></button>
        <div class="modal-header"><h3>Nieopłacone pozycje</h3></div>
        <div id="preview-body"><div class="empty-state"><span class="loading"></span><p>Ładowanie...</p></div></div>
      </div>`;
    document.body.appendChild(previewModal);
    const closePreviewModalBtn = previewModal.querySelector('#close-preview-modal');
    const previewBody = previewModal.querySelector('#preview-body');
    function openPreviewModal() { previewModal.classList.add('active'); }
    function closePreviewModal() { previewModal.classList.remove('active'); }
    closePreviewModalBtn.addEventListener('click', closePreviewModal);

    async function showParticipantUnpaidPreview(participantId) {
      openPreviewModal();
      if (previewBody) previewBody.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie...</p></div>';
      try {
        // Unpaid group payments (all months)
        const { data: gp, error: gpErr } = await supabase
          .from('payments')
          .select('month, amount, confirmed, method, comment')
          .eq('participant_id', participantId)
          .order('month', { ascending: false });
        if (gpErr) throw gpErr;
        const unpaidGroups = (gp || []).filter(p => !p.confirmed && Number(p.amount || 0) > 0);

        // Expected unpaid for current month from group memberships
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const currentMonth = `${yyyy}-${mm}`;
        const [{ data: participantRow }, { data: links }] = await Promise.all([
          supabase.from('participants').select('id, multisport').eq('id', participantId).maybeSingle(),
          supabase.from('participant_groups').select('group_id, effective_from_month, effective_to_month').eq('participant_id', participantId)
        ]);
        const allGroupIds = Array.from(new Set((links || []).map(l => l.group_id)));
        const { data: allGroupsRows } = allGroupIds.length ? await supabase
          .from('groups')
          .select('id, name, day, fee, multisport')
          .in('id', allGroupIds) : { data: [] };
        const allGroupsById = new Map((allGroupsRows || []).map(g => [g.id, g]));
        const activeGroupIds = (links || []).filter(l => {
          const fromOk = !l.effective_from_month || l.effective_from_month <= currentMonth;
          const toOk = !l.effective_to_month || l.effective_to_month > currentMonth;
          return fromOk && toOk;
        }).map(l => l.group_id);
        let unpaidExpectedMonth = 0;
        if (activeGroupIds.length) {
          const { data: groupsRows } = await supabase
            .from('groups')
            .select('id, fee, multisport')
            .in('id', activeGroupIds);
          const isMulti = !!(participantRow && participantRow.multisport);
          const expectedBase = (groupsRows || []).reduce((sum, g) => {
            const base = isMulti ? Number(g.multisport || 0) : Number(g.fee || 0);
            return sum + (isNaN(base) ? 0 : base);
          }, 0);
          const { data: paidMonthRows } = await supabase
            .from('payments')
            .select('amount, confirmed')
            .eq('participant_id', participantId)
            .eq('month', currentMonth);
          const paidForMonth = (paidMonthRows || []).filter(p => p.confirmed).reduce((s,p) => s + Number(p.amount || 0), 0);
          const hasAnyPaymentRow = (paidMonthRows || []).length > 0;
          unpaidExpectedMonth = hasAnyPaymentRow ? 0 : Math.max(0, expectedBase - paidForMonth);
        }

        // Unpaid lessons (participant share)
        const { data: lpLinks, error: lpErr } = await supabase
          .from('lesson_participants')
          .select('lesson_id')
          .eq('participant_id', participantId);
        if (lpErr) throw lpErr;
        const lessonIds = Array.from(new Set((lpLinks || []).map(l => l.lesson_id)));
        let unpaidLessons = [];
        if (lessonIds.length) {
          const { data: le, error: leErr } = await supabase
            .from('lesson_entries')
            .select('id, lesson_id, month, amount, confirmed, lesson_date, lesson_time')
            .in('lesson_id', lessonIds);
          if (leErr) throw leErr;
          // Need participant counts to split amount
          const { data: lpAll, error: lpAllErr } = await supabase
            .from('lesson_participants')
            .select('lesson_id, participant_id')
            .in('lesson_id', lessonIds);
          if (lpAllErr) throw lpAllErr;
          const countByLesson = new Map();
          (lpAll || []).forEach(l => {
            countByLesson.set(l.lesson_id, 1 + (countByLesson.get(l.lesson_id) || 0));
          });
          unpaidLessons = (le || []).filter(e => !e.confirmed).map(e => {
            const cnt = Math.max(1, countByLesson.get(e.lesson_id) || 1);
            const share = Number(e.amount || 0) / cnt;
            return { ...e, share };
          }).filter(e => e.share > 0);
        }

        function groupsActiveInMonth(monthVal) {
          return (links || []).filter(l => {
            const fromOk = !l.effective_from_month || l.effective_from_month <= monthVal;
            const toOk = !l.effective_to_month || l.effective_to_month > monthVal;
            return fromOk && toOk;
          }).map(l => allGroupsById.get(l.group_id)).filter(Boolean);
        }
        const groupListUnpaid = unpaidGroups.map(p => {
          const ginfo = groupsActiveInMonth(p.month).map(g => `${g.name} (${g.day})`).join(', ');
          return `<li><strong>Grupa:</strong> ${p.month} — ${Number(p.amount||0).toFixed(2)} zł${ginfo ? ` · <span style=\"color: var(--text-gray);\">${ginfo}</span>` : ''}</li>`;
        }).join('');
        const groupListExpected = unpaidExpectedMonth > 0 ? (() => {
          const ginfoNow = activeGroupIds.map(id => allGroupsById.get(id)).filter(Boolean).map(g => {
            const base = participantRow && participantRow.multisport ? Number(g.multisport||0) : Number(g.fee||0);
            return `${g.name} (${g.day}) — ${base.toFixed(2)} zł`;
          }).join('; ');
          return `<li><strong>Grupy:</strong> ${currentMonth} — ${unpaidExpectedMonth.toFixed(2)} zł${ginfoNow ? ` · <span style=\"color: var(--text-gray);\">${ginfoNow}</span>` : ''}</li>`;
        })() : '';
        const lessonList = unpaidLessons.map(e => {
          const d = e.lesson_date ? String(e.lesson_date) : (e.month || '-');
          const time = e.lesson_time ? ` ${e.lesson_time}` : '';
          return `<li><strong>Lekcja:</strong> ${d}${time} — ${e.share.toFixed(2)} zł (udział)</li>`;
        }).join('');
        const anyGroupDue = (unpaidGroups.length > 0) || (unpaidExpectedMonth > 0);
        const anyLessonDue = unpaidLessons.length > 0;
        const html = `
          <div class="content-box" style="padding:12px;">
            <h4 style="margin-top:0;">Zaległości</h4>
            ${(!(anyGroupDue || anyLessonDue)) ? '<div class="group-detail"><span>Brak zaległości</span></div>' : ''}
            ${(unpaidGroups.length || unpaidExpectedMonth > 0) ? `<div class="group-detail"><i class="fas fa-users"></i><span>Płatności grupowe</span></div><ul style="margin:8px 0 12px 18px;">${groupListExpected}${groupListUnpaid}</ul>` : ''}
            ${unpaidLessons.length ? `<div class="group-detail"><i class="fas fa-book"></i><span>Lekcje prywatne</span></div><ul style="margin:8px 0 0 18px;">${lessonList}</ul>` : ''}
          </div>`;
        if (previewBody) previewBody.innerHTML = html;
      } catch (err) {
        if (previewBody) previewBody.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
      }
    }

    // Search filter for participants page
    if (participantsSearch) {
      participantsSearch.addEventListener('input', () => {
        const q = participantsSearch.value.toLowerCase().trim();
        if (!participantsListAll) return;
        const cards = participantsListAll.querySelectorAll('.group-card');
        cards.forEach(c => {
          const text = c.textContent.toLowerCase();
          c.style.display = text.includes(q) ? '' : 'none';
        });
        renumberVisibleParticipants();
      });
    }
    const paidFilterCb = document.getElementById('filter-paid');
    const unpaidFilterCb = document.getElementById('filter-unpaid');
    if (paidFilterCb) paidFilterCb.addEventListener('change', () => { loadAllParticipants(); });
    if (unpaidFilterCb) unpaidFilterCb.addEventListener('change', () => { loadAllParticipants(); });

    // Edit/Delete actions on participants page
    const editParticipantModal = document.getElementById('edit-participant-modal');
    const closeEditParticipantModalBtn = document.getElementById('close-edit-participant-modal');
    const cancelEditParticipantBtn = document.getElementById('cancel-edit-participant');
    const saveEditParticipantBtn = document.getElementById('save-edit-participant');
    const editParticipantTitleEl = document.getElementById('edit-participant-title');
    const editFirstNameEl = document.getElementById('edit-participant-first-name');
    const editLastNameEl = document.getElementById('edit-participant-last-name');
    const editPhoneEl = document.getElementById('edit-participant-phone');
    const editMultiEl = document.getElementById('edit-participant-multisport');
    const editGroupsContainer = document.getElementById('edit-participant-groups');
    function getSelectedGroupIdsFromChecks() {
      if (!editGroupsContainer) return [];
      return Array.from(editGroupsContainer.querySelectorAll('input[type="checkbox"][data-group-id]:checked')).map(i => i.dataset.groupId);
    }
    let editParticipantId = null;
    let isCreateParticipant = false;

    function openEditParticipantModal(p, groups) {
      editParticipantId = p.id;
      isCreateParticipant = false;
      if (editParticipantTitleEl) editParticipantTitleEl.textContent = 'Edytuj uczestnika';
      editFirstNameEl.value = p.first_name || '';
      editLastNameEl.value = p.last_name || '';
      editPhoneEl.value = p.phone || '';
      editMultiEl.checked = !!p.multisport;
      if (editGroupsContainer) editGroupsContainer.innerHTML = '';
      groups.forEach(g => {
        const row = document.createElement('label');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '8px';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.groupId = g.id;
        cb.style.width = 'auto';
        const span = document.createElement('span');
        span.textContent = g.name;
        row.appendChild(cb);
        row.appendChild(span);
        if (editGroupsContainer) editGroupsContainer.appendChild(row);
      });
      // preselect current groups of participant via join table
      (async () => {
        try {
          const { data: links, error } = await supabase
            .from('participant_groups')
            .select('group_id')
            .eq('participant_id', p.id);
          if (!error && links && editGroupsContainer) {
            const ids = new Set(links.map(l => l.group_id));
            Array.from(editGroupsContainer.querySelectorAll('input[type="checkbox"][data-group-id]')).forEach(cb => {
              cb.checked = ids.has(cb.dataset.groupId);
            });
          }
        } catch {}
      })();
      editParticipantModal.classList.add('active');
    }
    async function openCreateParticipantModal() {
      isCreateParticipant = true;
      editParticipantId = null;
      if (editParticipantTitleEl) editParticipantTitleEl.textContent = 'Dodaj uczestnika';
      editFirstNameEl.value = '';
      editLastNameEl.value = '';
      editPhoneEl.value = '';
      editMultiEl.checked = false;
      try {
        const { data: groups, error } = await supabase.from('groups').select('id,name').order('name', { ascending: true });
        if (error) throw error;
        if (editGroupsContainer) editGroupsContainer.innerHTML = '';
        (groups || []).forEach(g => {
          const row = document.createElement('label');
          row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.gap = '8px';
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.dataset.groupId = g.id; cb.style.width = 'auto';
          const span = document.createElement('span'); span.textContent = g.name;
          row.appendChild(cb); row.appendChild(span);
          if (editGroupsContainer) editGroupsContainer.appendChild(row);
        });
      } catch (err) {
        console.error('Błąd ładowania grup:', err);
      }
      editParticipantModal.classList.add('active');
    }
    function closeEditParticipantModal() { editParticipantModal.classList.remove('active'); editParticipantId = null; isCreateParticipant = false; }
    closeEditParticipantModalBtn.addEventListener('click', closeEditParticipantModal);
    cancelEditParticipantBtn.addEventListener('click', closeEditParticipantModal);
    const addParticipantGlobalBtn = document.getElementById('add-participant-global');
    if (addParticipantGlobalBtn) {
      addParticipantGlobalBtn.addEventListener('click', async () => {
        await openCreateParticipantModal();
      });
    }

    if (participantsListAll) participantsListAll.addEventListener('click', async (e) => {
      const editBtn = e.target.closest('.edit-participant-btn');
      const delBtn = e.target.closest('.delete-participant-global-btn');
      const cardEl = e.target.closest('.group-card');
      if (editBtn) {
        const pid = editBtn.dataset.id;
        try {
          const [{ data: p, error: pErr }, { data: groups, error: gErr }] = await Promise.all([
            supabase.from('participants').select('*').eq('id', pid).maybeSingle(),
            supabase.from('groups').select('id,name').order('name', { ascending: true })
          ]);
          if (pErr) throw pErr;
          if (gErr) throw gErr;
          openEditParticipantModal(p, groups || []);
        } catch (err) {
          alert('Błąd wczytania uczestnika: ' + (err.message || 'Nieznany'));
        }
      }
      if (delBtn) {
        const pid = delBtn.dataset.id;
        if (!confirm('Usunąć uczestnika?')) return;
        try {
          const { error } = await supabase.from('participants').delete().eq('id', pid);
          if (error) throw error;
          await loadAllParticipants();
        } catch (err) {
          alert('Błąd usuwania uczestnika: ' + (err.message || 'Nieznany'));
        }
      }
      // Preview unpaid when clicking on card (excluding action buttons)
      if (cardEl && !editBtn && !delBtn) {
        const pid = cardEl.dataset.pid;
        if (pid) { await showParticipantUnpaidPreview(pid); }
      }
    });

    // Also enable preview in inactive list
    const participantsListInactive = document.getElementById('participants-list-inactive');
    if (participantsListInactive) participantsListInactive.addEventListener('click', async (e) => {
      const editBtn = e.target.closest('.edit-participant-btn');
      const delBtn = e.target.closest('.delete-participant-global-btn');
      const cardEl = e.target.closest('.group-card');
      if (cardEl && !editBtn && !delBtn) {
        const pid = cardEl.dataset.pid;
        if (pid) { await showParticipantUnpaidPreview(pid); }
      }
    });

    saveEditParticipantBtn.addEventListener('click', async () => {
      const payload = {
        first_name: editFirstNameEl.value.trim(),
        last_name: editLastNameEl.value.trim(),
        phone: editPhoneEl.value.trim(),
        multisport: !!editMultiEl.checked
      };
      const selectedGroupIds = getSelectedGroupIdsFromChecks();
      try {
        let participantIdToUse = editParticipantId;
        if (isCreateParticipant || !editParticipantId) {
          const ins = await supabase.from('participants').insert([payload]).select('id').single();
          if (ins.error) throw ins.error;
          participantIdToUse = ins.data.id;
        } else {
          const { error } = await supabase.from('participants').update(payload).eq('id', editParticipantId);
          if (error) throw error;
        }
        // sync participant_groups links
        const { data: existingLinks, error: linksErr } = await supabase
          .from('participant_groups')
          .select('group_id')
          .eq('participant_id', participantIdToUse);
        if (linksErr) throw linksErr;
        const existingIds = new Set((existingLinks || []).map(l => l.group_id));
        const desiredIds = new Set(selectedGroupIds);
        const toAdd = [...desiredIds].filter(id => !existingIds.has(id)).map(id => ({ participant_id: participantIdToUse, group_id: id }));
        const toRemove = [...existingIds].filter(id => !desiredIds.has(id));
        if (toAdd.length) {
          const addRes = await supabase.from('participant_groups').insert(toAdd);
          if (addRes.error) throw addRes.error;
        }
        if (toRemove.length) {
          const delRes = await supabase.from('participant_groups').delete().in('group_id', toRemove).eq('participant_id', participantIdToUse);
          if (delRes.error) throw delRes.error;
        }
        isCreateParticipant = false;
        closeEditParticipantModal();
        await loadAllParticipants();
      } catch (err) {
        alert('Błąd zapisu uczestnika: ' + (err.message || 'Nieznany'));
      }
    });
    
    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', async () => {
      await checkAdmin();
      setActiveNav('groups');
      // Ensure groups section visible on first paint
      const groupsSectionEl = document.getElementById('groups-section');
      const groupDetailsSectionEl = document.getElementById('group-details-section');
      const participantsSectionEl = document.getElementById('participants-section');
      const lessonsSectionEl = document.getElementById('lessons-section');
      const scheduleSectionEl = document.getElementById('schedule-section');
      const trainersSectionEl = document.getElementById('trainers-section');
      if (groupsSectionEl) groupsSectionEl.style.display = 'block';
      if (groupDetailsSectionEl) groupDetailsSectionEl.style.display = 'none';
      if (participantsSectionEl) participantsSectionEl.style.display = 'none';
      if (lessonsSectionEl) lessonsSectionEl.style.display = 'none';
      if (scheduleSectionEl) scheduleSectionEl.style.display = 'none';
      if (trainersSectionEl) trainersSectionEl.style.display = 'none';
      await loadGroups();
    });

    // Lessons Modal
    const lessonModal = document.createElement('div');
    lessonModal.className = 'modal';
    lessonModal.id = 'create-lesson-modal';
    lessonModal.innerHTML = `
      <div class="modal-content">
        <button class="modal-close" id="close-lesson-modal"><i class="fas fa-times"></i></button>
        <div class="modal-header"><h3>Utwórz zajęcia</h3></div>
        <div class="form-group"><label>Trener</label>
          <select id="lesson-trainer-select" class="form-control" required><option value="" disabled>Wybierz trenera...</option></select>
        </div>
        <div class="form-group">
          <label>Uczestnicy</label>
          <div id="lesson-participants-container"></div>
          <div style="margin-top: 8px;"><button class="btn btn-outline" id="add-lesson-participant-btn" type="button"><i class="fas fa-user-plus"></i> Dodaj uczestnika</button></div>
        </div>
        <div class="form-actions" style="justify-content: flex-end;">
          <button class="btn btn-outline" id="cancel-lesson-btn" type="button">Anuluj</button>
          <button class="btn btn-primary" id="save-lesson-btn" type="button"><i class="fas fa-save"></i> Zapisz</button>
        </div>
      </div>`;
    document.body.appendChild(lessonModal);
    const openLessonModal = () => lessonModal.classList.add('active');
    const closeLessonModal = () => lessonModal.classList.remove('active');
    const closeLessonModalBtn = lessonModal.querySelector('#close-lesson-modal');
    const cancelLessonBtn = lessonModal.querySelector('#cancel-lesson-btn');
    const saveLessonBtn = lessonModal.querySelector('#save-lesson-btn');
    const lessonTrainerSel = lessonModal.querySelector('#lesson-trainer-select');
    const lessonParticipantsContainer = lessonModal.querySelector('#lesson-participants-container');
    const addLessonParticipantBtn = lessonModal.querySelector('#add-lesson-participant-btn');
    function createLessonParticipantRow(first = '', last = '', phone = '') {
      const row = document.createElement('div');
      row.className = 'lesson-participant-row';
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1fr 1fr 1fr auto';
      row.style.gap = '8px';
      row.style.marginBottom = '8px';
      row.innerHTML = `
        <input type="text" class="form-control lp-first-name" placeholder="Imię" value="${first.replace(/"/g, '&quot;')}" />
        <input type="text" class="form-control lp-last-name" placeholder="Nazwisko" value="${last.replace(/"/g, '&quot;')}" />
        <input type="tel" class="form-control lp-phone" placeholder="Telefon" value="${phone.replace(/"/g, '&quot;')}" />
        <button class="btn btn-outline btn-sm remove-lp-btn" type="button"><i class="fas fa-user-minus"></i></button>
      `;
      const removeBtn = row.querySelector('.remove-lp-btn');
      removeBtn.addEventListener('click', () => { row.remove(); });
      return row;
    }
    function resetLessonForm() {
      if (lessonTrainerSel) populateTrainerSelect(lessonTrainerSel, '');
      if (lessonParticipantsContainer) {
        lessonParticipantsContainer.innerHTML = '';
        lessonParticipantsContainer.appendChild(createLessonParticipantRow());
      }
    }
    closeLessonModalBtn.addEventListener('click', closeLessonModal);
    cancelLessonBtn.addEventListener('click', closeLessonModal);
    if (createLessonBtn) createLessonBtn.addEventListener('click', () => { resetLessonForm(); openLessonModal(); });
    if (addLessonParticipantBtn) addLessonParticipantBtn.addEventListener('click', () => {
      if (lessonParticipantsContainer) lessonParticipantsContainer.appendChild(createLessonParticipantRow());
    });

    // Trainers Modal (create/edit)
    const trainerModal = document.createElement('div');
    trainerModal.className = 'modal';
    trainerModal.id = 'trainer-modal';
    trainerModal.innerHTML = `
      <div class="modal-content">
        <button class="modal-close" id="close-trainer-modal"><i class="fas fa-times"></i></button>
        <div class="modal-header"><h3 id="trainer-modal-title">Dodaj trenera</h3></div>
        <div class="form-group"><label>Imię</label><input type="text" id="trainer-first-name" class="form-control" placeholder="Imię"></div>
        <div class="form-group"><label>Nazwisko</label><input type="text" id="trainer-last-name" class="form-control" placeholder="Nazwisko"></div>
        <div class="form-group"><label>Email</label><input type="email" id="trainer-email" class="form-control" placeholder="Email"></div>
        <div class="form-group"><label>Hasło</label><input type="password" id="trainer-password" class="form-control" placeholder="Hasło (min. 8 znaków)"></div>
        <div class="form-group"><label>Powtórz hasło</label><input type="password" id="trainer-password2" class="form-control" placeholder="Powtórz hasło"></div>
        <div class="form-actions" style="justify-content: flex-end;">
          <button class="btn btn-outline" id="cancel-trainer-btn" type="button">Anuluj</button>
          <button class="btn btn-primary" id="save-trainer-btn" type="button"><i class="fas fa-save"></i> Zapisz</button>
        </div>
      </div>`;
    document.body.appendChild(trainerModal);
    const addTrainerBtn = document.getElementById('add-trainer-btn');
    const closeTrainerModalBtn = trainerModal.querySelector('#close-trainer-modal');
    const cancelTrainerBtn = trainerModal.querySelector('#cancel-trainer-btn');
    const saveTrainerBtn = trainerModal.querySelector('#save-trainer-btn');
    const trainerFirstNameEl = trainerModal.querySelector('#trainer-first-name');
    const trainerLastNameEl = trainerModal.querySelector('#trainer-last-name');
    const trainerEmailEl = trainerModal.querySelector('#trainer-email');
    const trainerPasswordEl = trainerModal.querySelector('#trainer-password');
    const trainerPassword2El = trainerModal.querySelector('#trainer-password2');
    const trainerModalTitle = trainerModal.querySelector('#trainer-modal-title');
    let editingTrainerId = null;
    function openTrainerModal() { trainerModal.classList.add('active'); }
    function closeTrainerModal() { trainerModal.classList.remove('active'); editingTrainerId = null; trainerModalTitle.textContent = 'Dodaj trenera'; if (trainerFirstNameEl) trainerFirstNameEl.value=''; if (trainerLastNameEl) trainerLastNameEl.value=''; if (trainerEmailEl) trainerEmailEl.value=''; if (trainerPasswordEl) trainerPasswordEl.value=''; if (trainerPassword2El) trainerPassword2El.value=''; }
    if (addTrainerBtn) addTrainerBtn.addEventListener('click', () => { editingTrainerId = null; trainerModalTitle.textContent = 'Dodaj trenera'; openTrainerModal(); });
    closeTrainerModalBtn.addEventListener('click', closeTrainerModal);
    cancelTrainerBtn.addEventListener('click', closeTrainerModal);

    async function loadTrainers() {
      const trainersList = document.getElementById('trainers-list');
      if (!trainersList) return;
      trainersList.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie trenerów...</p></div>';
      try {
        let trainers = [];
        let error = null;
        {
          const q = await supabase
            .from('profiles')
            .select('*')
            .eq('role', 'trainer');
          error = q.error; trainers = q.data || [];
        }
        if (error) throw error;
        if (!trainers || trainers.length === 0) {
          trainersList.innerHTML = '<div class="empty-state"><p>Brak trenerów</p></div>';
          return;
        }
        const displayNameOf = (t) => {
          const full = `${(t.first_name||'').trim()} ${(t.last_name||'').trim()}`.trim();
          if (full) return full;
          return (t.full_name || t.name || t.username || '').trim();
        };
        const emailOf = (t) => (t.email || t.contact_email || t.user_email || '').trim();
        trainers.sort((a,b) => (displayNameOf(a) || emailOf(a) || a.id).localeCompare(displayNameOf(b) || emailOf(b) || b.id));
        const fragment = document.createDocumentFragment();
        trainers.forEach((t, idx) => {
          const card = document.createElement('div');
          card.className = 'group-card';
          const dname = displayNameOf(t) || '-';
          const demail = emailOf(t) || '';
          card.innerHTML = `
            <h4><span class="p-index">${idx + 1}</span>${dname}</h4>
            <div class="group-detail"><i class="fas fa-envelope"></i><span>${demail}</span></div>
            <div class="group-actions">
              <button class="btn btn-outline edit-trainer-btn" data-id="${t.id}"><i class="fas fa-edit"></i></button>
              <button class="btn btn-outline delete-trainer-btn" data-id="${t.id}"><i class="fas fa-trash"></i></button>
            </div>`;
          fragment.appendChild(card);
        });
        trainersList.innerHTML = '';
        trainersList.appendChild(fragment);
      } catch (err) {
        if (trainersList) trainersList.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
      }
    }

    // Create/update trainer into profiles as role=trainer
    if (saveTrainerBtn) saveTrainerBtn.addEventListener('click', async () => {
      const first = (trainerFirstNameEl?.value || '').trim();
      const last = (trainerLastNameEl?.value || '').trim();
      const email = (trainerEmailEl?.value || '').trim();
      const pwd = (trainerPasswordEl?.value || '').trim();
      const pwd2 = (trainerPassword2El?.value || '').trim();
      if (!first || !last || !email) { alert('Wypełnij imię, nazwisko i email'); return; }
      if (!editingTrainerId) {
        if (!pwd || pwd.length < 8) { alert('Hasło musi mieć min. 8 znaków'); return; }
        if (pwd !== pwd2) { alert('Hasła nie są zgodne'); return; }
      }
      saveTrainerBtn.disabled = true; const original = saveTrainerBtn.innerHTML; saveTrainerBtn.innerHTML = '<span class="loading"></span> Zapisywanie...';
      try {
        if (editingTrainerId) {
          // best-effort update across variable schemas
          let upd = await supabase
            .from('profiles')
            .update({ first_name: first, last_name: last, email })
            .eq('id', editingTrainerId);
          if (upd.error) {
            upd = await supabase
              .from('profiles')
              .update({ full_name: `${first} ${last}`.trim(), email })
              .eq('id', editingTrainerId);
            if (upd.error) {
              const upd2 = await supabase
                .from('profiles')
                .update({ role: 'trainer' })
                .eq('id', editingTrainerId);
              if (upd2.error) throw upd2.error;
            }
          }
        } else {
          // Create auth user without affecting admin session (use alt client with in-memory storage)
          const { createClient: createSupabaseClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
          const ALT_SUPABASE_URL = 'https://xsowdwnpguftmlvsogdb.supabase.co';
          const ALT_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhzb3dkd25wZ3VmdG1sdnNvZ2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NTc0MzQsImV4cCI6MjA3MTMzMzQzNH0.yFz01fJCqTuaY-jzgqlcgueiU4Id71t66xtjhAGXNWI';
          const memoryStorage = { getItem: () => null, setItem: () => {}, removeItem: () => {} };
          const alt = createSupabaseClient(ALT_SUPABASE_URL, ALT_SUPABASE_KEY, { auth: { storage: memoryStorage } });
          const { data: signData, error: signErr } = await alt.auth.signUp({ email, password: pwd });
          if (signErr) throw signErr;
          const newUserId = signData?.user?.id || null;
          if (!newUserId) throw new Error('Nie udało się utworzyć konta trenera');
          // minimal upsert then enrich
          let up = await supabase
            .from('profiles')
            .upsert([{ id: newUserId, role: 'trainer' }]);
          if (up.error) throw up.error;
          up = await supabase
            .from('profiles')
            .update({ first_name: first, last_name: last, email, full_name: `${first} ${last}`.trim() })
            .eq('id', newUserId);
          // if update fails, ignore; at least role exists
          try { await alt.auth.signOut(); } catch {}
        }
        closeTrainerModal();
        await loadTrainers();
      } catch (err) {
        alert('Błąd zapisu trenera: ' + (err.message || 'Nieznany'));
      } finally { saveTrainerBtn.disabled = false; saveTrainerBtn.innerHTML = original; }
    });

    // Trainers actions
    const trainersListEl = document.getElementById('trainers-list');
    if (trainersListEl) trainersListEl.addEventListener('click', async (e) => {
      const editBtn = e.target.closest('.edit-trainer-btn');
      const delBtn = e.target.closest('.delete-trainer-btn');
      if (editBtn) {
        const id = editBtn.dataset.id;
        try {
          let t = null; let error = null;
          {
            const q = await supabase.from('profiles').select('*').eq('id', id).maybeSingle();
            t = q.data; error = q.error;
          }
          if (error) throw error;
          editingTrainerId = t.id;
          trainerModalTitle.textContent = 'Edytuj trenera';
          if (trainerFirstNameEl) trainerFirstNameEl.value = (t.first_name || (t.full_name ? String(t.full_name).split(' ')[0] : '') || '');
          if (trainerLastNameEl) trainerLastNameEl.value = (t.last_name || (t.full_name ? String(t.full_name).split(' ').slice(1).join(' ') : '') || '');
          if (trainerEmailEl) trainerEmailEl.value = t.email || t.contact_email || t.user_email || '';
          openTrainerModal();
        } catch (err) {
          alert('Błąd wczytania trenera: ' + (err.message || 'Nieznany'));
        }
      }
      if (delBtn) {
        const id = delBtn.dataset.id;
        if (!confirm('Usunąć trenera?')) return;
        try {
          const { error } = await supabase.from('profiles').delete().eq('id', id);
          if (error) throw error;
          await loadTrainers();
        } catch (err) {
          alert('Błąd usuwania trenera: ' + (err.message || 'Nieznany'));
        }
      }
    });

    // Add Lesson Entry Modal
    const lessonEntryModal = document.createElement('div');
    lessonEntryModal.className = 'modal';
    lessonEntryModal.id = 'add-lesson-entry-modal';
    lessonEntryModal.innerHTML = `
      <div class="modal-content">
        <button class="modal-close" id="close-lesson-entry-modal"><i class="fas fa-times"></i></button>
        <div class="modal-header"><h3>Dodaj lekcję</h3></div>
        <div id="le-new-lesson-fields" style="display:none;">
          <div class="form-group">
            <label>Trener</label>
            <input type="text" id="le-trainer" class="form-control" placeholder="Imię i nazwisko trenera" />
          </div>
          <div class="form-group">
            <label>Uczestnicy</label>
            <div id="le-participants-container"></div>
            <div style="margin-top: 8px;"><button class="btn btn-outline" id="le-add-participant-btn" type="button"><i class="fas fa-user-plus"></i> Dodaj uczestnika</button></div>
          </div>
        </div>
        <div class="form-group" style="display:flex; gap:8px; align-items:center;">
          <div style="flex:1 1 50%">
            <label>Dzień</label>
            <input type="date" id="le-date" class="form-control" />
          </div>
          <div style="flex:1 1 50%">
            <label>Godzina</label>
            <input type="time" id="le-time" class="form-control" />
          </div>
        </div>
        <div class="form-group">
          <label>Kwota (zł)</label>
          <input type="number" id="le-amount" class="form-control" placeholder="0.00" step="0.01" />
        </div>
        <div class="form-actions">
          <button class="btn btn-outline" id="cancel-lesson-entry">Anuluj</button>
          <button class="btn btn-primary" id="save-lesson-entry"><i class="fas fa-save"></i> Zapisz</button>
        </div>
      </div>`;
    document.body.appendChild(lessonEntryModal);
    const openLessonEntryModal = () => lessonEntryModal.classList.add('active');
    const closeLessonEntryModal = () => lessonEntryModal.classList.remove('active');
    const closeLessonEntryBtn = lessonEntryModal.querySelector('#close-lesson-entry-modal');
    const cancelLessonEntryBtn = lessonEntryModal.querySelector('#cancel-lesson-entry');
    const saveLessonEntryBtn = lessonEntryModal.querySelector('#save-lesson-entry');
    const leAmount = lessonEntryModal.querySelector('#le-amount');
    const leDate = lessonEntryModal.querySelector('#le-date');
    const leTime = lessonEntryModal.querySelector('#le-time');
    const leNewLessonFields = lessonEntryModal.querySelector('#le-new-lesson-fields');
    const leTrainerEl = lessonEntryModal.querySelector('#le-trainer');
    const leParticipantsContainer = lessonEntryModal.querySelector('#le-participants-container');
    const leAddParticipantBtn = lessonEntryModal.querySelector('#le-add-participant-btn');
    let entryTypeContext = 'private';
    if (leAddParticipantBtn) leAddParticipantBtn.addEventListener('click', () => {
      if (leParticipantsContainer) leParticipantsContainer.appendChild(createLessonParticipantRow());
    });
    if (addLessonEntryBtn) addLessonEntryBtn.addEventListener('click', () => {
      entryTypeContext = 'private';
      leAmount.value = '';
      if (leNewLessonFields) {
        leNewLessonFields.style.display = 'block';
        if (lessonTrainerSel) populateTrainerSelect(lessonTrainerSel, '');
        if (leParticipantsContainer) {
          leParticipantsContainer.innerHTML = '';
          leParticipantsContainer.appendChild(createLessonParticipantRow());
        }
      }
      selectedLessonId = null;
      openLessonEntryModal();
    });
    closeLessonEntryBtn.addEventListener('click', closeLessonEntryModal);
    cancelLessonEntryBtn.addEventListener('click', closeLessonEntryModal);
    if (saveLessonEntryBtn) saveLessonEntryBtn.addEventListener('click', async () => {
      const amount = parseFloat(leAmount.value || '0');
      if (isNaN(amount) || amount < 0) { alert('Podaj poprawną kwotę'); return; }
      if (!selectedLessonMonth) {
        const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth()+1).padStart(2,'0');
        selectedLessonMonth = `${yyyy}-${mm}`;
      }
      const monthVal = lessonMonthSelect ? (lessonMonthSelect.value || selectedLessonMonth) : selectedLessonMonth;
      try {
        let lessonIdToUse = selectedLessonId;
        // If no lesson selected, create lesson with trainer and participants first
        if (!lessonIdToUse) {
          const trainerName = (lessonTrainerSel && lessonTrainerSel.value ? lessonTrainerSel.value.trim() : '');
          if (!trainerName) { alert('Podaj trenera'); return; }
          const rows = Array.from(leParticipantsContainer ? leParticipantsContainer.querySelectorAll('.lesson-participant-row') : []);
          if (!rows.length) { alert('Dodaj co najmniej jednego uczestnika'); return; }
          const phoneToId = new Map();
          const participantIds = [];
          for (const row of rows) {
            const fn = (row.querySelector('.lp-first-name')?.value || '').trim();
            const ln = (row.querySelector('.lp-last-name')?.value || '').trim();
            const phone = (row.querySelector('.lp-phone')?.value || '').trim();
            if (!fn || !ln || !phone) { alert('Wypełnij imię, nazwisko i telefon dla każdego uczestnika'); return; }
            let participantId = phoneToId.get(phone) || null;
            if (!participantId) {
              const found = await supabase.from('participants').select('id').eq('phone', phone).maybeSingle();
              if (found.error) throw found.error;
              if (found.data) {
                participantId = found.data.id;
                await supabase.from('participants').update({ first_name: fn, last_name: ln }).eq('id', participantId);
              } else {
                const insP = await supabase
                  .from('participants')
                  .insert([{ first_name: fn, last_name: ln, phone, multisport: false, consent_signed: false }])
                  .select('id')
                  .single();
                if (insP.error) throw insP.error;
                participantId = insP.data.id;
              }
              phoneToId.set(phone, participantId);
            }
            participantIds.push(participantId);
          }
          const lessonCreate = await supabase.from('lessons').insert([{ trainer: trainerName }]).select('id').single();
          if (lessonCreate.error) throw lessonCreate.error;
          lessonIdToUse = lessonCreate.data.id;
          for (const pid of participantIds) {
            const lpIns = await supabase.from('lesson_participants').insert([{ lesson_id: lessonIdToUse, participant_id: pid }]);
            if (lpIns.error) throw lpIns.error;
          }
        }
        const payload = { lesson_id: lessonIdToUse, type: entryTypeContext || 'private', use_package: false, package: null, amount, month: monthVal };
        if (leDate && leDate.value) payload.lesson_date = leDate.value;
        if (leTime && leTime.value) payload.lesson_time = leTime.value;
        const ins = await supabase.from('lesson_entries').insert([payload]);
        if (ins.error) throw ins.error;
        closeLessonEntryModal();
        // Refresh appropriate view
        if (firstDanceSection && firstDanceSection.style.display === 'block') await renderFirstDanceForMonth(); else await renderLessonsForMonth();
      } catch (err) {
        alert('Błąd zapisu lekcji: ' + (err.message || 'Nieznany'));
      }
    });

    // Helper: resort current DOM rows by inputs (date/time)
    function resortLessonRowsByInputs() {
      if (!lessonEntriesList) return;
      const rows = Array.from(lessonEntriesList.querySelectorAll('.content-box.participant-row'));
      const parseRowDate = (row) => {
        const d = row.querySelector('.le-date')?.value || '';
        const t = row.querySelector('.le-time')?.value || '';
        if (d) {
          // Prefer input values
          const base = new Date(d + 'T' + (t || '00:00'));
          if (!isNaN(base.getTime())) return base;
        }
        const createdAt = row.dataset.createdAt || '';
        const fallback = createdAt ? new Date(createdAt) : new Date();
        return fallback;
      };
      rows.sort((ra, rb) => parseRowDate(rb) - parseRowDate(ra));
      // Re-append in new order
      const frag = document.createDocumentFragment();
      rows.forEach(r => frag.appendChild(r));
      lessonEntriesList.appendChild(frag);
    }

    // Monthly lessons view (all lessons for selected month)
    async function renderLessonsForMonth() {
      try {
        if (!selectedLessonMonth) {
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          selectedLessonMonth = `${yyyy}-${mm}`;
        }
        if (lessonMonthSelect) {
          lessonMonthSelect.innerHTML = '';
          const opts = getLast12MonthsOptions();
          opts.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.value; opt.textContent = o.label;
            lessonMonthSelect.appendChild(opt);
          });
          lessonMonthSelect.value = selectedLessonMonth;
        }
        if (lessonParticipantsSummary) {
          lessonParticipantsSummary.style.display = 'none';
          lessonParticipantsSummary.innerHTML = '';
        }
        if (lessonEntriesList) {
          lessonEntriesList.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie lekcji...</p></div>';
        }
        const { data: entries, error: eErr } = await supabase
          .from('lesson_entries')
          .select('*')
          .eq('month', selectedLessonMonth)
          .eq('type', 'private');
        if (eErr) throw eErr;
        if (!entries || entries.length === 0) {
          if (lessonEntriesList) lessonEntriesList.innerHTML = '<div class="empty-state"><p>Brak lekcji</p></div>';
          if (leSumCount) leSumCount.textContent = '0';
          if (leSumPaidCount) leSumPaidCount.textContent = '0';
          if (leSumUnpaidCount) leSumUnpaidCount.textContent = '0';
          if (leSumPaidAmount) leSumPaidAmount.textContent = '0.00 zł';
          if (leSumUnpaidAmount) leSumUnpaidAmount.textContent = '0.00 zł';
          if (leSumProfit) leSumProfit.textContent = '0.00 zł';
          if (leSumPotential) leSumPotential.textContent = '0.00 zł';
          if (leSumPaidProgress) leSumPaidProgress.style.width = '0%';
          return;
        }
        const lessonIds = Array.from(new Set(entries.map(e => e.lesson_id)));
        const [{ data: links, error: linkErr }, { data: lessons, error: lErr }] = await Promise.all([
          supabase.from('lesson_participants').select('lesson_id, participant_id, effective_from_month, effective_to_month').in('lesson_id', lessonIds),
          supabase.from('lessons').select('id, trainer').in('id', lessonIds)
        ]);
        if (linkErr) throw linkErr;
        if (lErr) throw lErr;
        const activeLinksByLesson = new Map();
        (links || []).forEach(l => {
          const fromOk = !l.effective_from_month || l.effective_from_month <= selectedLessonMonth;
          const toOk = !l.effective_to_month || l.effective_to_month > selectedLessonMonth;
          if (!(fromOk && toOk)) return;
          const arr = activeLinksByLesson.get(l.lesson_id) || [];
          arr.push(l.participant_id);
          activeLinksByLesson.set(l.lesson_id, arr);
        });
        const allPIds = Array.from(new Set((links || []).map(l => l.participant_id)));
        const { data: parts, error: pErr } = allPIds.length ? await supabase.from('participants').select('id, first_name, last_name, phone').in('id', allPIds) : { data: [], error: null };
        if (pErr) throw pErr;
        const pMap = new Map((parts || []).map(p => [p.id, p]));
        const trainerMap = new Map((lessons || []).map(l => [l.id, l.trainer || '']));
        // Sort entries by lesson date/time descending (newest/closest later first)
        const getEntryDate = (ent) => {
          if (ent.lesson_date) {
            const [y, m, d] = String(ent.lesson_date).split('-').map(n => parseInt(n, 10));
            const date = new Date(Date.UTC(y, (m || 1) - 1, d || 1, 0, 0, 0));
            if (ent.lesson_time) {
              const [hh, mm] = String(ent.lesson_time).split(':').map(n => parseInt(n, 10) || 0);
              date.setUTCHours(hh, mm, 0, 0);
            }
            return date;
          }
          return new Date(ent.created_at);
        };
        const sortedEntries = (entries || []).slice().sort((a,b) => getEntryDate(b) - getEntryDate(a));

        const fragment = document.createDocumentFragment();
        let total = 0;
        sortedEntries.forEach(ent => {
          total += Number(ent.amount || 0);
          const box = document.createElement('div');
          box.className = 'content-box participant-row ' + (ent.confirmed ? 'paid' : 'unpaid');
          box.style.marginBottom = '8px';
          box.dataset.createdAt = ent.created_at || '';
          const pIds = activeLinksByLesson.get(ent.lesson_id) || [];
          const names = pIds.map(id => {
            const person = pMap.get(id) || {}; return `${(person.first_name||'').trim()} ${(person.last_name||'').trim()}`.trim();
          }).filter(Boolean);
          const trainerName = trainerMap.get(ent.lesson_id) || '';
          const title = `Lekcja prywatna — ${names.length ? names.join(', ') : '(bez uczestników)'}`;
          box.innerHTML = `
            <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
              <div style="flex:1 1 220px; min-width:180px;">
                <div class="group-detail"><i class="fas fa-book"></i><span>${title}</span>${trainerName ? ` <span style=\"color: var(--text-gray);\"> — ${trainerName}</span>` : ''}</div>
              </div>
              <div style="flex:0 0 140px; min-width:120px;">
                <input title="Kwota (${selectedLessonMonth})" type="number" step="0.01" class="form-control small le-amount" value="${Number(ent.amount || 0).toFixed(2)}" />
              </div>
              <div style="flex:0 0 120px; min-width:110px;">
                <select title="Metoda" class="form-control small le-method">
                  <option value="">Metoda...</option>
                  <option value="card" ${ent.method === 'card' ? 'selected' : ''}>Karta</option>
                  <option value="transfer" ${ent.method === 'transfer' ? 'selected' : ''}>Przelew</option>
                  <option value="cash" ${ent.method === 'cash' ? 'selected' : ''}>Gotówka</option>
                </select>
              </div>
              <div style="flex:1 1 160px; min-width:140px;">
                <input title="Komentarz" type="text" class="form-control small le-comment" placeholder="Komentarz" value="${(ent.comment || '').replace(/"/g, '&quot;')}" />
              </div>
              <div style="flex:0 0 auto; display:flex; gap:6px; align-items:center;">
                <button class="btn btn-primary btn-sm le-confirm-btn">${ent.confirmed ? 'Zapisz' : 'OK'}</button>
                ${ent.confirmed ? '<span class="status" style="color: var(--success); font-size:0.8rem; white-space:nowrap;">OK</span>' : '<span class="status" style="color: var(--text-gray); font-size:0.8rem; white-space:nowrap;">Brak</span>'}
                <button class="btn btn-outline btn-sm le-delete-payment-btn" title="Usuń płatność"><i class="fas fa-xmark"></i></button>
                <button class="btn btn-outline btn-sm le-delete-lesson-btn" title="Usuń lekcję"><i class="fas fa-trash"></i></button>
              </div>
              <div style="flex:0 0 auto; display:flex; gap:6px; align-items:center;">
                <input type="date" class="form-control small le-date" value="${ent.lesson_date ? String(ent.lesson_date).substring(0,10) : ''}" />
                <input type="time" class="form-control small le-time" value="${ent.lesson_time ? ent.lesson_time : ''}" />
              </div>
            </div>
          `;
          box.dataset.entryId = ent.id;
          fragment.appendChild(box);
        });
        const paidCount = entries.filter(e => e.confirmed).length;
        const unpaidCount = entries.length - paidCount;
        const paidAmount = entries.filter(e => e.confirmed).reduce((s,e)=> s + Number(e.amount || 0), 0);
        const unpaidAmount = entries.filter(e => !e.confirmed).reduce((s,e)=> s + Number(e.amount || 0), 0);
        if (leSumCount) leSumCount.textContent = String(entries.length);
        if (leSumPaidCount) leSumPaidCount.textContent = String(paidCount);
        if (leSumUnpaidCount) leSumUnpaidCount.textContent = String(unpaidCount);
        if (leSumPaidAmount) { leSumPaidAmount.textContent = `${paidAmount.toFixed(2)} zł`; leSumPaidAmount.style.color = 'var(--success)'; }
        if (leSumUnpaidAmount) { leSumUnpaidAmount.textContent = `${unpaidAmount.toFixed(2)} zł`; leSumUnpaidAmount.style.color = 'var(--error)'; }
        if (leSumProfit) leSumProfit.textContent = `${paidAmount.toFixed(2)} zł`;
        if (leSumPotential) leSumPotential.textContent = `${(paidAmount + unpaidAmount).toFixed(2)} zł`;
        const percent = entries.length ? Math.round((paidCount / entries.length) * 100) : 0;
        if (leSumPaidProgress) leSumPaidProgress.style.width = percent + '%';
        if (lessonEntriesList) {
          lessonEntriesList.innerHTML = '';
          lessonEntriesList.appendChild(fragment);
          // Attach one-time listeners to auto resort on date/time change
          if (!lessonEntriesList.dataset.sortHandlersAttached) {
            const shouldResort = (ev) => {
              const el = ev.target;
              if (!el) return;
              if (el.classList && (el.classList.contains('le-date') || el.classList.contains('le-time'))) {
                resortLessonRowsByInputs();
              }
            };
            lessonEntriesList.addEventListener('change', shouldResort);
            lessonEntriesList.addEventListener('input', shouldResort);
            lessonEntriesList.dataset.sortHandlersAttached = '1';
          }
          // Initial resort after render to ensure tie-breaking is consistent
          resortLessonRowsByInputs();
        }
      } catch (err) {
        if (lessonEntriesList) lessonEntriesList.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
      }
    }

    // First Dance: reuse lessons logic, scoped by type 'first_dance'
    async function renderFirstDanceForMonth() {
      const fdMonthSelect = document.getElementById('fd-month-select');
      const fdEntriesList = document.getElementById('fd-entries-list');
      const fdSumCount = document.getElementById('fd-sum-count');
      const fdSumPaidCount = document.getElementById('fd-sum-paid-count');
      const fdSumPaidAmount = document.getElementById('fd-sum-paid-amount');
      const fdSumUnpaidCount = document.getElementById('fd-sum-unpaid-count');
      const fdSumUnpaidAmount = document.getElementById('fd-sum-unpaid-amount');
      const fdSumPaidProgress = document.getElementById('fd-sum-paid-progress');
      const fdSumProfit = document.getElementById('fd-sum-profit');
      const fdSumPotential = document.getElementById('fd-sum-potential');
      const fdTotalEl = document.getElementById('fd-total');
      try {
        if (!selectedLessonMonth) {
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          selectedLessonMonth = `${yyyy}-${mm}`;
        }
        if (fdMonthSelect) {
          fdMonthSelect.innerHTML = '';
          const opts = getLast12MonthsOptions();
          opts.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.value; opt.textContent = o.label;
            fdMonthSelect.appendChild(opt);
          });
          fdMonthSelect.value = selectedLessonMonth;
        }
        if (fdEntriesList) {
          fdEntriesList.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie lekcji...</p></div>';
        }
        const { data: entries, error: eErr } = await supabase
          .from('lesson_entries')
          .select('*')
          .eq('month', selectedLessonMonth)
          .eq('type', 'first_dance');
        if (eErr) throw eErr;
        if (!entries || entries.length === 0) {
          if (fdEntriesList) fdEntriesList.innerHTML = '<div class="empty-state"><p>Brak lekcji</p></div>';
          if (fdSumCount) fdSumCount.textContent = '0';
          if (fdSumPaidCount) fdSumPaidCount.textContent = '0';
          if (fdSumUnpaidCount) fdSumUnpaidCount.textContent = '0';
          if (fdSumPaidAmount) fdSumPaidAmount.textContent = '0.00 zł';
          if (fdSumUnpaidAmount) fdSumUnpaidAmount.textContent = '0.00 zł';
          if (fdSumProfit) fdSumProfit.textContent = '0.00 zł';
          if (fdSumPotential) fdSumPotential.textContent = '0.00 zł';
          if (fdSumPaidProgress) fdSumPaidProgress.style.width = '0%';
          return;
        }
        const lessonIds = Array.from(new Set(entries.map(e => e.lesson_id)));
        const [{ data: links, error: linkErr }, { data: lessons, error: lErr }] = await Promise.all([
          supabase.from('lesson_participants').select('lesson_id, participant_id, effective_from_month, effective_to_month').in('lesson_id', lessonIds),
          supabase.from('lessons').select('id, trainer').in('id', lessonIds)
        ]);
        if (linkErr) throw linkErr;
        if (lErr) throw lErr;
        const activeLinksByLesson = new Map();
        (links || []).forEach(l => {
          const fromOk = !l.effective_from_month || l.effective_from_month <= selectedLessonMonth;
          const toOk = !l.effective_to_month || l.effective_to_month > selectedLessonMonth;
          if (!(fromOk && toOk)) return;
          const arr = activeLinksByLesson.get(l.lesson_id) || [];
          arr.push(l.participant_id);
          activeLinksByLesson.set(l.lesson_id, arr);
        });
        const allPIds = Array.from(new Set((links || []).map(l => l.participant_id)));
        const { data: parts, error: pErr } = allPIds.length ? await supabase.from('participants').select('id, first_name, last_name, phone').in('id', allPIds) : { data: [], error: null };
        if (pErr) throw pErr;
        const pMap = new Map((parts || []).map(p => [p.id, p]));
        const trainerMap = new Map((lessons || []).map(l => [l.id, l.trainer || '']));
        const getEntryDate = (ent) => {
          if (ent.lesson_date) {
            const [y, m, d] = String(ent.lesson_date).split('-').map(n => parseInt(n, 10));
            const date = new Date(Date.UTC(y, (m || 1) - 1, d || 1, 0, 0, 0));
            if (ent.lesson_time) {
              const [hh, mm] = String(ent.lesson_time).split(':').map(n => parseInt(n, 10) || 0);
              date.setUTCHours(hh, mm, 0, 0);
            }
            return date;
          }
          return new Date(ent.created_at);
        };
        const sorted = (entries || []).slice().sort((a,b) => getEntryDate(b) - getEntryDate(a));
        const fragment = document.createDocumentFragment();
        let total = 0;
        sorted.forEach(ent => {
          total += Number(ent.amount || 0);
          const box = document.createElement('div');
          box.className = 'content-box participant-row ' + (ent.confirmed ? 'paid' : 'unpaid');
          box.style.marginBottom = '8px';
          box.dataset.createdAt = ent.created_at || '';
          const pIds = activeLinksByLesson.get(ent.lesson_id) || [];
          const names = pIds.map(id => {
            const person = pMap.get(id) || {}; return `${(person.first_name||'').trim()} ${(person.last_name||'').trim()}`.trim();
          }).filter(Boolean);
          const trainerName = trainerMap.get(ent.lesson_id) || '';
          const title = `Lekcja prywatna — ${names.length ? names.join(', ') : '(bez uczestników)'}`;
          box.innerHTML = `
            <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
              <div style="flex:1 1 220px; min-width:180px;">
                <div class="group-detail"><i class="fas fa-book"></i><span>${title}</span>${trainerName ? ` <span style=\"color: var(--text-gray);\"> — ${trainerName}</span>` : ''}</div>
              </div>
              <div style="flex:0 0 140px; min-width:120px;">
                <input title="Kwota (${selectedLessonMonth})" type="number" step="0.01" class="form-control small le-amount" value="${Number(ent.amount || 0).toFixed(2)}" data-entry-id="${ent.id}" />
              </div>
              <div style="flex:0 0 120px; min-width:110px;">
                <select title="Metoda" class="form-control small le-method">
                  <option value="">Metoda...</option>
                  <option value="card" ${ent.method === 'card' ? 'selected' : ''}>Karta</option>
                  <option value="transfer" ${ent.method === 'transfer' ? 'selected' : ''}>Przelew</option>
                  <option value="cash" ${ent.method === 'cash' ? 'selected' : ''}>Gotówka</option>
                </select>
              </div>
              <div style="flex:1 1 160px; min-width:140px;">
                <input title="Komentarz" type="text" class="form-control small le-comment" placeholder="Komentarz" value="${(ent.comment || '').replace(/"/g, '&quot;')}" />
              </div>
              <div style="flex:0 0 auto; display:flex; gap:6px; align-items:center;">
                <button class="btn btn-primary btn-sm le-confirm-btn">${ent.confirmed ? 'Zapisz' : 'OK'}</button>
                ${ent.confirmed ? '<span class="status" style="color: var(--success); font-size:0.8rem; white-space:nowrap;">OK</span>' : '<span class="status" style="color: var(--text-gray); font-size:0.8rem; white-space:nowrap;">Brak</span>'}
                <button class="btn btn-outline btn-sm le-delete-payment-btn" title="Usuń płatność"><i class="fas fa-xmark"></i></button>
                <button class="btn btn-outline btn-sm le-delete-lesson-btn" title="Usuń lekcję"><i class="fas fa-trash"></i></button>
              </div>
              <div style="flex:0 0 auto; display:flex; gap:6px; align-items:center;">
                <input type="date" class="form-control small le-date" value="${ent.lesson_date ? String(ent.lesson_date).substring(0,10) : ''}" />
                <input type="time" class="form-control small le-time" value="${ent.lesson_time ? ent.lesson_time : ''}" />
              </div>
            </div>
          `;
          box.dataset.entryId = ent.id;
          fragment.appendChild(box);
        });
        const paidCount = entries.filter(e => e.confirmed).length;
        const unpaidCount = entries.length - paidCount;
        const paidAmount = entries.filter(e => e.confirmed).reduce((s,e)=> s + Number(e.amount || 0), 0);
        const unpaidAmount = entries.filter(e => !e.confirmed).reduce((s,e)=> s + Number(e.amount || 0), 0);
        if (fdSumCount) fdSumCount.textContent = String(entries.length);
        if (fdSumPaidCount) fdSumPaidCount.textContent = String(paidCount);
        if (fdSumUnpaidCount) fdSumUnpaidCount.textContent = String(unpaidCount);
        if (fdSumPaidAmount) { fdSumPaidAmount.textContent = `${paidAmount.toFixed(2)} zł`; fdSumPaidAmount.style.color = 'var(--success)'; }
        if (fdSumUnpaidAmount) { fdSumUnpaidAmount.textContent = `${unpaidAmount.toFixed(2)} zł`; fdSumUnpaidAmount.style.color = 'var(--error)'; }
        if (fdSumProfit) fdSumProfit.textContent = `${paidAmount.toFixed(2)} zł`;
        if (fdSumPotential) fdSumPotential.textContent = `${(paidAmount + unpaidAmount).toFixed(2)} zł`;
        const percent = entries.length ? Math.round((paidCount / entries.length) * 100) : 0;
        if (fdSumPaidProgress) fdSumPaidProgress.style.width = percent + '%';
        if (fdEntriesList) { fdEntriesList.innerHTML = ''; fdEntriesList.appendChild(fragment); }
        if (fdTotalEl) fdTotalEl.textContent = `Suma: ${total.toFixed(2)} zł`;
      } catch (err) {
        const fdEntriesList = document.getElementById('fd-entries-list');
        if (fdEntriesList) fdEntriesList.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
      }
    }

    const fdMonthSelect = document.getElementById('fd-month-select');
    if (fdMonthSelect) fdMonthSelect.addEventListener('change', async () => { selectedLessonMonth = fdMonthSelect.value; await renderFirstDanceForMonth(); });

    const fdAddEntryBtn = document.getElementById('fd-add-entry-btn');
    if (fdAddEntryBtn) fdAddEntryBtn.addEventListener('click', () => {
      entryTypeContext = 'first_dance';
      // Reuse lesson entry modal
      const leAmount = document.querySelector('#le-amount');
      const leNewLessonFields = document.querySelector('#le-new-lesson-fields');
      const leTrainerSel2 = document.querySelector('#lesson-trainer-select');
      const leParticipantsContainer = document.querySelector('#le-participants-container');
      if (leAmount) leAmount.value = '';
      if (leNewLessonFields) leNewLessonFields.style.display = 'block';
      if (leTrainerSel2) populateTrainerSelect(leTrainerSel2, '');
      if (leParticipantsContainer) { leParticipantsContainer.innerHTML = ''; leParticipantsContainer.appendChild(createLessonParticipantRow()); }
      selectedLessonId = null;
      openLessonEntryModal();
    });

    // First dance actions (delegation)
    const fdEntriesList = document.getElementById('fd-entries-list');
    if (fdEntriesList) fdEntriesList.addEventListener('change', async (e) => {
      const input = e.target.closest('.le-amount');
      if (!input) return;
      const row = e.target.closest('.content-box.participant-row');
      if (!row) return;
      const entryId = row.dataset.entryId;
      const newAmount = parseFloat(input.value || '0');
      if (isNaN(newAmount) || newAmount < 0) { alert('Podaj poprawną kwotę'); return; }
      try {
        const { error } = await supabase
          .from('lesson_entries')
          .update({ amount: newAmount })
          .eq('id', entryId)
          .eq('type', 'first_dance');
        if (error) throw error;
        await renderFirstDanceForMonth();
      } catch (err) { alert('Błąd zapisu kwoty: ' + (err.message || 'Nieznany')); }
    });
    if (fdEntriesList) fdEntriesList.addEventListener('click', async (e) => {
      const row = e.target.closest('.content-box.participant-row');
      if (!row) return;
      const entryId = row.dataset.entryId;
      if (e.target.closest('.le-confirm-btn')) {
        const amount = parseFloat(row.querySelector('.le-amount')?.value || '0');
        const method = row.querySelector('.le-method')?.value || '';
        const comment = row.querySelector('.le-comment')?.value?.trim() || '';
        const dateVal = row.querySelector('.le-date')?.value || null;
        const timeVal = row.querySelector('.le-time')?.value || null;
        if (isNaN(amount) || amount < 0) { alert('Podaj poprawną kwotę'); return; }
        if (!method) { alert('Wybierz metodę płatności'); return; }
        const btn = e.target.closest('.le-confirm-btn');
        const original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span class="loading"></span>';
        try {
          const { error } = await supabase
            .from('lesson_entries')
            .update({ amount, method, comment, lesson_date: dateVal, lesson_time: timeVal, confirmed: true, confirmed_at: new Date().toISOString() })
            .eq('id', entryId)
            .eq('type', 'first_dance');
          if (error) throw error;
          await renderFirstDanceForMonth();
        } catch (err2) {
          alert('Błąd zapisu płatności: ' + (err2.message || 'Nieznany'));
        } finally { btn.disabled = false; btn.innerHTML = original; }
      }
      if (e.target.closest('.le-delete-payment-btn')) {
        if (!confirm('Usunąć dane płatności dla tej lekcji?')) return;
        try {
          const { error } = await supabase
            .from('lesson_entries')
            .update({ confirmed: false, confirmed_at: null, method: '', comment: '' })
            .eq('id', entryId)
            .eq('type', 'first_dance');
          if (error) throw error;
          await renderFirstDanceForMonth();
        } catch (err4) {
          alert('Błąd usuwania płatności: ' + (err4.message || 'Nieznany'));
        }
      }
      if (e.target.closest('.le-delete-lesson-btn')) {
        if (!confirm('Usunąć tę lekcję?')) return;
        try {
          const { error } = await supabase
            .from('lesson_entries')
            .delete()
            .eq('id', entryId)
            .eq('type', 'first_dance');
          if (error) throw error;
          await renderFirstDanceForMonth();
        } catch (err3) {
          alert('Błąd usuwania lekcji: ' + (err3.message || 'Nieznany'));
        }
      }
    });

    async function loadLessons() {
      if (!lessonsList) return;
      lessonsList.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie zajęć...</p></div>';
      try {
        const { data: lessons, error } = await supabase
          .from('lessons')
          .select('id, created_at, trainer')
          .order('created_at', { ascending: false });
        if (error) throw error;
        if (!lessons || lessons.length === 0) {
          lessonsList.innerHTML = '<div class="empty-state"><i class="fas fa-book"></i><p>Brak zajęć</p></div>';
          return;
        }
        // Fetch participants for all lessons via join table
        const lIds = lessons.map(l => l.id);
        const { data: links, error: linkErr } = await supabase
          .from('lesson_participants')
          .select('lesson_id, participant_id')
          .in('lesson_id', lIds);
        if (linkErr) throw linkErr;
        const allPIds = Array.from(new Set((links || []).map(x => x.participant_id)));
        const { data: parts, error: pErr } = allPIds.length ? await supabase
          .from('participants')
          .select('id, first_name, last_name, phone')
          .in('id', allPIds) : { data: [], error: null };
        if (pErr) throw pErr;
        const pMap = new Map((parts || []).map(p => [p.id, p]));
        const byLesson = new Map();
        (links || []).forEach(l => {
          const arr = byLesson.get(l.lesson_id) || [];
          arr.push(pMap.get(l.participant_id));
          byLesson.set(l.lesson_id, arr);
        });
        const fragment = document.createDocumentFragment();
        lessons.forEach((l, idx) => {
          const card = document.createElement('div');
          card.className = 'group-card';
          const plist = (byLesson.get(l.id) || []).filter(Boolean);
          const names = plist.map(p => (p?.first_name || '').trim()).filter(Boolean);
          const phones = plist.map(p => p?.phone || '').filter(Boolean);
          card.innerHTML = `
            <h4><span class="p-index">${idx + 1}</span>Zajęcia ${names.length ? names.join(', ') : '(bez imion)'} — ${l.trainer || ''}</h4>
            <div class="group-detail"><i class="fas fa-phone"></i><span>${phones.join(', ')}</span></div>
            <div class="group-detail"><i class="fas fa-calendar"></i><span>${new Date(l.created_at).toLocaleString('pl-PL')}</span></div>
          `;
          fragment.appendChild(card);
          card.addEventListener('click', async () => { await openLessonDetails(l.id); });
        });
        lessonsList.innerHTML = '';
        lessonsList.appendChild(fragment);
      } catch (err) {
        lessonsList.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
      }
    }
    
    async function openLessonDetails(lessonId) {
      selectedLessonId = lessonId;
      if (lessonsSection) lessonsSection.style.display = 'none';
      if (lessonDetailsSection) lessonDetailsSection.style.display = 'block';
      await renderLessonDetails();
    }
    
    async function renderLessonDetails() {
      if (!selectedLessonId) return;
      try {
        const { data: lesson, error: lErr } = await supabase.from('lessons').select('id, trainer, created_at').eq('id', selectedLessonId).maybeSingle();
        if (lErr) throw lErr;
        if (lessonDetailsTitle) lessonDetailsTitle.textContent = `Lekcje`;
        const { data: links, error: linkErr } = await supabase.from('lesson_participants').select('participant_id, effective_from_month, effective_to_month, id').eq('lesson_id', selectedLessonId);
        if (linkErr) throw linkErr;
        const pIds = (links || []).filter(l => {
          const fromOk = !l.effective_from_month || l.effective_from_month <= selectedLessonMonth;
          const toOk = !l.effective_to_month || l.effective_to_month > selectedLessonMonth;
          return fromOk && toOk;
        }).map(x => x.participant_id);
        let pMap = new Map();
        if (pIds.length) {
          const { data: parts, error: pErr } = await supabase.from('participants').select('id, first_name, last_name, phone').in('id', pIds);
          if (pErr) throw pErr;
          pMap = new Map(parts.map(p => [p.id, p]));
        }
        if (lessonParticipantsSummary) { lessonParticipantsSummary.style.display = 'none'; lessonParticipantsSummary.innerHTML = ''; }
        if (lessonEntriesList) {
          lessonEntriesList.innerHTML = '<div class="empty-state"><span class="loading"></span><p>Ładowanie lekcji...</p></div>';
          // Ensure lesson month select is populated
          if (!selectedLessonMonth) {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            selectedLessonMonth = `${yyyy}-${mm}`;
          }
          if (lessonMonthSelect) {
            lessonMonthSelect.innerHTML = '';
            const opts = getLast12MonthsOptions();
            opts.forEach(o => {
              const opt = document.createElement('option');
              opt.value = o.value; opt.textContent = o.label;
              lessonMonthSelect.appendChild(opt);
            });
            lessonMonthSelect.value = selectedLessonMonth;
          }
          const { data: entries, error: eErr } = await supabase
            .from('lesson_entries')
            .select('*')
            .eq('lesson_id', selectedLessonId)
            .eq('month', selectedLessonMonth)
            .order('created_at', { ascending: false });
          if (eErr) throw eErr;
          const fragment = document.createDocumentFragment();
          let total = 0;
          if (!entries || entries.length === 0) {
            lessonEntriesList.innerHTML = '<div class="empty-state"><p>Brak lekcji</p></div>';
            if (lessonTotalEl) lessonTotalEl.textContent = '';
            if (leSumCount) leSumCount.textContent = '0';
            if (leSumPaidCount) leSumPaidCount.textContent = '0';
            if (leSumUnpaidCount) leSumUnpaidCount.textContent = '0';
            if (leSumPaidAmount) leSumPaidAmount.textContent = '0.00 zł';
            if (leSumUnpaidAmount) leSumUnpaidAmount.textContent = '0.00 zł';
            if (leSumProfit) leSumProfit.textContent = '0.00 zł';
            if (leSumPotential) leSumPotential.textContent = '0.00 zł';
            if (leSumPaidProgress) leSumPaidProgress.style.width = '0%';
          } else {
            entries.forEach(ent => {
              total += Number(ent.amount || 0);
              const box = document.createElement('div');
              box.className = 'content-box participant-row ' + (ent.confirmed ? 'paid' : 'unpaid');
              box.style.marginBottom = '8px';
              const typeLabel = 'Lekcja prywatna';
              const pkg = '';
              const pIdsActive = (links || []).filter(l => {
                const fromOk = !l.effective_from_month || l.effective_from_month <= selectedLessonMonth;
                const toOk = !l.effective_to_month || l.effective_to_month > selectedLessonMonth;
                return fromOk && toOk;
              }).map(x => x.participant_id);
              const names = pIdsActive.map(id => { const person = pMap.get(id) || {}; return `${(person.first_name||'').trim()} ${(person.last_name||'').trim()}`.trim(); }).filter(Boolean);
              box.innerHTML = `
                <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
                  <div style="flex:1 1 160px; min-width:140px;">
                    <div class="group-detail"><i class="fas fa-book"></i><span>${typeLabel}${pkg} — ${names.length ? names.join(', ') : '(bez uczestników)'} </span></div>
                  </div>
                  <div style="flex:0 0 140px; min-width:120px;">
                    <input title="Kwota (${selectedLessonMonth})" type="number" step="0.01" class="form-control small le-amount" value="${Number(ent.amount || 0).toFixed(2)}" data-entry-id="${ent.id}" />
                  </div>
                  <div style="flex:0 0 120px; min-width:110px;">
                    <select title="Metoda" class="form-control small le-method">
                      <option value="">Metoda...</option>
                      <option value="card" ${ent.method === 'card' ? 'selected' : ''}>Karta</option>
                      <option value="transfer" ${ent.method === 'transfer' ? 'selected' : ''}>Przelew</option>
                      <option value="cash" ${ent.method === 'cash' ? 'selected' : ''}>Gotówka</option>
                    </select>
                  </div>
                  <div style="flex:1 1 160px; min-width:140px;">
                    <input title="Komentarz" type="text" class="form-control small le-comment" placeholder="Komentarz" value="${(ent.comment || '').replace(/"/g, '&quot;')}" />
                  </div>
                  <div style="flex:0 0 auto; display:flex; gap:6px; align-items:center;">
                    <button class="btn btn-primary btn-sm le-confirm-btn">${ent.confirmed ? 'Zapisz' : 'OK'}</button>
                    ${ent.confirmed ? '<span class="status" style="color: var(--success); font-size:0.8rem; white-space:nowrap;">OK</span>' : '<span class="status" style="color: var(--text-gray); font-size:0.8rem; white-space:nowrap;">Brak</span>'}
                    <button class="btn btn-outline btn-sm le-delete-btn" title="Usuń płatność"><i class="fas fa-xmark"></i></button>
                  </div>
                  <div style="flex:0 0 auto; display:flex; gap:6px; align-items:center;">
                    <input type="date" class="form-control small le-date" value="${ent.lesson_date ? String(ent.lesson_date).substring(0,10) : ''}" />
                    <input type="time" class="form-control small le-time" value="${ent.lesson_time ? ent.lesson_time : ''}" />
                  </div>
                </div>
              `;
              box.dataset.entryId = ent.id;
              fragment.appendChild(box);
            });
            const paidCount = entries.filter(e => e.confirmed).length;
            const unpaidCount = entries.length - paidCount;
            const paidAmount = entries.filter(e => e.confirmed).reduce((s,e)=> s + Number(e.amount || 0), 0);
            const unpaidAmount = entries.filter(e => !e.confirmed).reduce((s,e)=> s + Number(e.amount || 0), 0);
            if (leSumCount) leSumCount.textContent = String(entries.length);
            if (leSumPaidCount) leSumPaidCount.textContent = String(paidCount);
            if (leSumUnpaidCount) leSumUnpaidCount.textContent = String(unpaidCount);
            if (leSumPaidAmount) { leSumPaidAmount.textContent = `${paidAmount.toFixed(2)} zł`; leSumPaidAmount.style.color = 'var(--success)'; }
            if (leSumUnpaidAmount) { leSumUnpaidAmount.textContent = `${unpaidAmount.toFixed(2)} zł`; leSumUnpaidAmount.style.color = 'var(--error)'; }
            if (leSumProfit) leSumProfit.textContent = `${paidAmount.toFixed(2)} zł`;
            if (leSumPotential) leSumPotential.textContent = `${(paidAmount + unpaidAmount).toFixed(2)} zł`;
            const percent = entries.length ? Math.round((paidCount / entries.length) * 100) : 0;
            if (leSumPaidProgress) leSumPaidProgress.style.width = percent + '%';
            lessonEntriesList.innerHTML = '';
            lessonEntriesList.appendChild(fragment);
            if (lessonTotalEl) lessonTotalEl.textContent = `Suma: ${total.toFixed(2)} zł`;
          }
        }
      } catch (err) {
        if (lessonEntriesList) lessonEntriesList.innerHTML = '<div class="empty-state"><p>Błąd: ' + (err.message || 'Nieznany') + '</p></div>';
      }
    }
    if (deleteLessonBtn) deleteLessonBtn.addEventListener('click', async () => {
      if (!selectedLessonId) return;
      if (!confirm('Usunąć całe zajęcia? Spowoduje to usunięcie wszystkich lekcji w tych zajęciach.')) return;
      try {
        const { error } = await supabase.from('lessons').delete().eq('id', selectedLessonId);
        if (error) throw error;
        selectedLessonId = null;
        if (lessonDetailsSection) lessonDetailsSection.style.display = 'none';
        if (lessonsSection) { lessonsSection.style.display = 'block'; await loadLessons(); }
      } catch (err) {
        alert('Błąd usuwania zajęć: ' + (err.message || 'Nieznany'));
      }
    });
    // Month change for lessons (monthly view)
    if (lessonMonthSelect) {
      lessonMonthSelect.addEventListener('change', async () => {
        selectedLessonMonth = lessonMonthSelect.value;
        await renderLessonsForMonth();
      });
    }

    // Auto-save amount change on lessons list
    if (lessonEntriesList) lessonEntriesList.addEventListener('change', async (e) => {
      const input = e.target.closest('.le-amount');
      if (!input) return;
      const row = e.target.closest('.content-box.participant-row');
      if (!row) return;
      const entryId = row.dataset.entryId;
      const newAmount = parseFloat(input.value || '0');
      if (isNaN(newAmount) || newAmount < 0) { alert('Podaj poprawną kwotę'); return; }
      try {
        const { error } = await supabase
          .from('lesson_entries')
          .update({ amount: newAmount })
          .eq('id', entryId)
          .eq('type', 'private');
        if (error) throw error;
        await renderLessonsForMonth();
      } catch (err) { alert('Błąd zapisu kwoty: ' + (err.message || 'Nieznany')); }
    });

    // Confirm/save handlers for lesson entries (delegation)
    if (lessonEntriesList) lessonEntriesList.addEventListener('click', async (e) => {
      const row = e.target.closest('.content-box.participant-row');
      if (!row) return;
      const entryId = row.dataset.entryId;
      if (e.target.closest('.le-confirm-btn')) {
        const amount = parseFloat(row.querySelector('.le-amount')?.value || '0');
        const method = row.querySelector('.le-method')?.value || '';
        const comment = row.querySelector('.le-comment')?.value?.trim() || '';
        const dateVal = row.querySelector('.le-date')?.value || null;
        const timeVal = row.querySelector('.le-time')?.value || null;
        if (isNaN(amount) || amount < 0) { alert('Podaj poprawną kwotę'); return; }
        if (!method) { alert('Wybierz metodę płatności'); return; }
        const btn = e.target.closest('.le-confirm-btn');
        const original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span class="loading"></span>';
        try {
          const { error } = await supabase
            .from('lesson_entries')
            .update({ amount, method, comment, lesson_date: dateVal, lesson_time: timeVal, confirmed: true, confirmed_at: new Date().toISOString() })
            .eq('id', entryId);
          if (error) throw error;
          await renderLessonsForMonth();
        } catch (err2) {
          alert('Błąd zapisu płatności: ' + (err2.message || 'Nieznany'));
        } finally { btn.disabled = false; btn.innerHTML = original; }
      }
      if (e.target.closest('.le-delete-lesson-btn')) {
        if (!confirm('Usunąć tę lekcję?')) return;
        try {
          const { error } = await supabase
            .from('lesson_entries')
            .delete()
            .eq('id', entryId)
            .eq('type', 'private');
          if (error) throw error;
          await renderLessonsForMonth();
        } catch (err3) {
          alert('Błąd usuwania lekcji: ' + (err3.message || 'Nieznany'));
        }
      }
      if (e.target.closest('.le-delete-payment-btn')) {
        if (!confirm('Usunąć dane płatności dla tej lekcji?')) return;
        try {
          const { error } = await supabase
            .from('lesson_entries')
            .update({ confirmed: false, confirmed_at: null, method: '', comment: '' })
            .eq('id', entryId);
          if (error) throw error;
          await renderLessonsForMonth();
        } catch (err4) {
          alert('Błąd usuwania płatności: ' + (err4.message || 'Nieznany'));
        }
      }
    });

    // Remove participant action no longer available in lessons view per new flow

    // Save lesson: ensure participants exist (by phone), else create; then insert lessons
    if (saveLessonBtn) saveLessonBtn.addEventListener('click', async () => {
      const trainer = lessonTrainerEl.value.trim();
      if (!trainer) { alert('Podaj trenera'); return; }
      const rows = Array.from(lessonParticipantsContainer ? lessonParticipantsContainer.querySelectorAll('.lesson-participant-row') : []);
      if (!rows.length) { alert('Dodaj co najmniej jednego uczestnika'); return; }
      saveLessonBtn.disabled = true; const original = saveLessonBtn.innerHTML; saveLessonBtn.innerHTML = '<span class="loading"></span> Zapisywanie...';
      try {
        const phoneToId = new Map();
        for (const row of rows) {
          const fn = (row.querySelector('.lp-first-name')?.value || '').trim();
          const ln = (row.querySelector('.lp-last-name')?.value || '').trim();
          const phone = (row.querySelector('.lp-phone')?.value || '').trim();
          if (!fn || !ln || !phone) { throw new Error('Wypełnij imię, nazwisko i telefon dla każdego uczestnika'); }
          let participantId = phoneToId.get(phone) || null;
          if (!participantId) {
            const found = await supabase.from('participants').select('id').eq('phone', phone).maybeSingle();
            if (found.error) throw found.error;
            if (found.data) {
              participantId = found.data.id;
              await supabase.from('participants').update({ first_name: fn, last_name: ln }).eq('id', participantId);
            } else {
              const ins = await supabase
                .from('participants')
                .insert([{ first_name: fn, last_name: ln, phone, multisport: false, consent_signed: false }])
                .select('id')
                .single();
              if (ins.error) throw ins.error;
              participantId = ins.data.id;
            }
            phoneToId.set(phone, participantId);
          }
          // Create or reuse a single lesson for this save
          if (!window._currentLessonIdForSave) {
            const lessonCreate = await supabase.from('lessons').insert([{ trainer }]).select('id').single();
            if (lessonCreate.error) throw lessonCreate.error;
            window._currentLessonIdForSave = lessonCreate.data.id;
          }
          const lpIns = await supabase.from('lesson_participants').insert([{ lesson_id: window._currentLessonIdForSave, participant_id: participantId }]);
          if (lpIns.error) throw lpIns.error;
        }
        window._currentLessonIdForSave = null;
        await loadLessons();
        try { await loadAllParticipants(); } catch {}
        closeLessonModal();
        if (lessonTrainerEl) lessonTrainerEl.value = '';
        if (lessonParticipantsContainer) lessonParticipantsContainer.innerHTML = '';
      } catch (err) {
        alert('Błąd zapisu zajęć: ' + (err.message || 'Nieznany'));
      } finally {
        saveLessonBtn.disabled = false; saveLessonBtn.innerHTML = original;
      }
    });

    // Google Apps Script bridge (provide your Web App URL here)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwop1QUBjJfIzow6KlHw1B9Iv5RxdQ-lhjh7F1aUlP3ODkYbXtr7GWiT4m2shKYL3R0/exec';
    const DEFAULT_CALENDAR_ID = 'primary';
    const DEFAULT_TIMEZONE = 'Europe/Warsaw';
    
    function safeComputeNextIsoPair(dayPl, startHHMM, endHHMM) {
      try { if (typeof computeNextIsoPair === 'function') return computeNextIsoPair(dayPl, startHHMM, endHHMM); } catch (e) {}
      const map = { 'Poniedziałek':'MO','Wtorek':'TU','Środa':'WE','Czwartek':'TH','Piątek':'FR','Sobota':'SA','Niedziela':'SU' };
      const byday = map[dayPl] || 'MO';
      const idxMap = { SU:0, MO:1, TU:2, WE:3, TH:4, FR:5, SA:6 };
      const idx = idxMap[byday] ?? 1;
      const [sh, sm] = String(startHHMM||'00:00').split(':').map(n=>parseInt(n,10)||0);
      const [eh, em] = String(endHHMM||'00:00').split(':').map(n=>parseInt(n,10)||0);
      const now = new Date();
      const d = new Date(now); d.setSeconds(0,0);
      let delta = idx - d.getDay(); if (delta < 0) delta += 7; d.setDate(d.getDate()+delta); d.setHours(sh, sm, 0, 0);
      if (d <= now) d.setDate(d.getDate()+7);
      const end = new Date(d.getTime()); end.setHours(eh, em, 0, 0);
      if (end <= d) end.setTime(d.getTime() + 60*60*1000);
      const fmt = (dd)=>{ const pad=n=>String(n).padStart(2,'0'); const tzMin=-dd.getTimezoneOffset(); const sign=tzMin>=0?'+':'-'; const tzh=pad(Math.floor(Math.abs(tzMin)/60)); const tzm=pad(Math.abs(tzMin)%60); return `${dd.getFullYear()}-${pad(dd.getMonth()+1)}-${pad(dd.getDate())}T${pad(dd.getHours())}:${pad(dd.getMinutes())}:${pad(dd.getSeconds())}${sign}${tzh}:${tzm}`; };
      return { next_start_iso: fmt(d), next_end_iso: fmt(end), byday_code: byday };
    }

    async function sendCalendarRequest(payload) {
      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          // Use text/plain to avoid CORS preflight on Apps Script
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          mode: 'no-cors',
          body: JSON.stringify(payload)
        });
        // In no-cors mode we cannot read the response. Assume success and rely on fallbacks.
        return { ok: true, transport: 'no-cors' };
      } catch (e) {
        // Swallow noisy CORS errors; treat as best-effort
        return { ok: true, transport: 'no-cors-error', note: e?.message || 'network error' };
      }
    }

    // ===== Dziennik (Attendance) =====
    const groupViewTabBtn = document.getElementById('group-view-tab');
    const groupAttendanceTabBtn = document.getElementById('group-attendance-tab');
    const groupControlsRow = document.getElementById('group-controls-row');
    const attendancePanel = document.getElementById('group-attendance-panel');
    const attendanceMonthSelect = document.getElementById('attendance-month-select');
    const attendanceDatesWrap = document.getElementById('attendance-dates');
    const attendanceList = document.getElementById('attendance-list');
    const confirmAttendanceBtn = document.getElementById('confirm-attendance-btn');
    const editAttendanceBtn = document.getElementById('edit-attendance-btn');

    const lockedAttendanceDates = new Set(); // dates 'YYYY-MM-DD' that are confirmed (locked)
    let attendanceSelectedDate = null; // 'YYYY-MM-DD'
    let inMemoryAttendance = new Map(); // key: date -> Set(participant_id)

    function setupAttendanceTabs() {
      if (!groupViewTabBtn || !groupAttendanceTabBtn) return;
      // Default: show group view
      groupViewTabBtn.classList.add('btn-primary');
      groupViewTabBtn.classList.remove('btn-outline');
      groupAttendanceTabBtn.classList.add('btn-outline');
      groupAttendanceTabBtn.classList.remove('btn-primary');
      showGroupView();

      groupViewTabBtn.onclick = () => {
        showGroupView();
      };
      groupAttendanceTabBtn.onclick = () => {
        showAttendanceView();
      };
    }

    function showGroupView() {
      if (groupControlsRow) groupControlsRow.style.display = 'flex';
      const summary = document.getElementById('participants-summary');
      const list = document.getElementById('participants-list');
      if (summary) summary.style.display = '';
      if (list) list.style.display = '';
      if (attendancePanel) attendancePanel.style.display = 'none';
      if (groupViewTabBtn && groupAttendanceTabBtn) {
        groupViewTabBtn.classList.add('btn-primary');
        groupViewTabBtn.classList.remove('btn-outline');
        groupAttendanceTabBtn.classList.add('btn-outline');
        groupAttendanceTabBtn.classList.remove('btn-primary');
      }
    }

    function showAttendanceView() {
      if (groupControlsRow) groupControlsRow.style.display = 'none';
      const summary = document.getElementById('participants-summary');
      const list = document.getElementById('participants-list');
      if (summary) summary.style.display = 'none';
      if (list) list.style.display = 'none';
      if (attendancePanel) attendancePanel.style.display = '';
      if (groupViewTabBtn && groupAttendanceTabBtn) {
        groupViewTabBtn.classList.remove('btn-primary');
        groupViewTabBtn.classList.add('btn-outline');
        groupAttendanceTabBtn.classList.remove('btn-outline');
        groupAttendanceTabBtn.classList.add('btn-primary');
      }
    }

    function populateAttendanceMonthSelect() {
      if (!attendanceMonthSelect) return;
      attendanceMonthSelect.innerHTML = '';
      const opts = getLast12MonthsOptions();
      opts.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        attendanceMonthSelect.appendChild(opt);
      });
      attendanceMonthSelect.value = selectedMonth || opts[0]?.value || '';
      attendanceMonthSelect.onchange = () => {
        selectedMonth = attendanceMonthSelect.value;
        attendanceSelectedDate = null;
        renderAttendanceDates();
        renderAttendanceList();
      };
    }

    function getWeekdayIndex(plDay) {
      const map = {
        'Niedziela': 0,
        'Poniedziałek': 1,
        'Wtorek': 2,
        'Środa': 3,
        'Czwartek': 4,
        'Piątek': 5,
        'Sobota': 6
      };
      return map[plDay] ?? 0;
    }

    function getSessionDatesForMonth(group, monthValue) {
      if (!group || !monthValue) return [];
      const [yyyy, mm] = monthValue.split('-').map(s => parseInt(s, 10));
      const first = new Date(yyyy, mm - 1, 1);
      const last = new Date(yyyy, mm, 0);
      const targetDow = getWeekdayIndex(group.day);
      const dates = [];
      for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
        if (d.getDay() === targetDow) {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          dates.push(`${y}-${m}-${day}`);
        }
      }
      return dates;
    }

    function renderAttendanceDates() {
      if (!attendanceDatesWrap || !selectedGroup) return;
      const dates = getSessionDatesForMonth(selectedGroup, selectedMonth);
      attendanceDatesWrap.innerHTML = '';
      dates.forEach(dateStr => {
        const btn = document.createElement('button');
        const isSelected = attendanceSelectedDate === dateStr;
        btn.className = isSelected ? 'btn btn-primary' : 'btn btn-outline';
        btn.textContent = dateStr;
        btn.onclick = () => {
          attendanceSelectedDate = dateStr;
          renderAttendanceList();
          renderAttendanceDates();
        };
        attendanceDatesWrap.appendChild(btn);
      });
      // Auto-select first date if none
      if (!attendanceSelectedDate && dates.length) {
        attendanceSelectedDate = dates[0];
        renderAttendanceDates();
      }
    }

    async function fetchActiveParticipantsForSelectedMonth() {
      // reuse logic from loadParticipantsAndPayments membership window
      const { data: pgRows } = await supabase
        .from('participant_groups')
        .select('participant_id, effective_from_month, effective_to_month')
        .eq('group_id', selectedGroup.id);
      const activeRows = (pgRows || []).filter(r => {
        const fromOk = !r.effective_from_month || r.effective_from_month <= selectedMonth;
        const toOk = !r.effective_to_month || r.effective_to_month > selectedMonth;
        return fromOk && toOk;
      });
      if (!activeRows.length) return [];
      const pIds = activeRows.map(r => r.participant_id);
      const { data: participants } = await supabase
        .from('participants')
        .select('id, first_name, last_name')
        .in('id', pIds)
        .order('last_name', { ascending: true });
      return participants || [];
    }

    function isPresent(participantId) {
      const set = inMemoryAttendance.get(attendanceSelectedDate);
      return !!(set && set.has(participantId));
    }

    function togglePresence(participantId, checked) {
      const set = inMemoryAttendance.get(attendanceSelectedDate) || new Set();
      if (checked) set.add(participantId); else set.delete(participantId);
      inMemoryAttendance.set(attendanceSelectedDate, set);
    }

    async function renderAttendanceList() {
      if (!attendanceList) return;
      if (!attendanceSelectedDate) {
        attendanceList.innerHTML = '<div class="empty-state"><p>Wybierz termin zajęć</p></div>';
        confirmAttendanceBtn.style.display = 'none';
        editAttendanceBtn.style.display = 'none';
        return;
      }
      const participants = await fetchActiveParticipantsForSelectedMonth();
      if (!participants.length) {
        attendanceList.innerHTML = '<div class="empty-state"><p>Brak uczestników</p></div>';
        confirmAttendanceBtn.style.display = 'none';
        editAttendanceBtn.style.display = 'none';
        return;
      }
      const canEdit = attendanceSelectedDate ? !lockedAttendanceDates.has(attendanceSelectedDate) : true;
      const frag = document.createDocumentFragment();
      participants.forEach(p => {
        const row = document.createElement('div');
        row.className = 'list-row';
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.padding = '8px 12px';
        const name = document.createElement('div');
        name.textContent = `${p.first_name || ''} ${p.last_name || ''}`.trim();
        const right = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.style.width = 'auto';
        checkbox.disabled = !canEdit;
        checkbox.checked = isPresent(p.id);
        checkbox.onchange = (ev) => {
          togglePresence(p.id, ev.target.checked);
        };
        right.appendChild(checkbox);
        row.appendChild(name);
        row.appendChild(right);
        frag.appendChild(row);
      });
      attendanceList.innerHTML = '';
      attendanceList.appendChild(frag);
      if (confirmAttendanceBtn) confirmAttendanceBtn.style.display = canEdit ? '' : 'none';
      if (editAttendanceBtn) editAttendanceBtn.style.display = canEdit ? 'none' : '';
    }

    if (confirmAttendanceBtn) {
      confirmAttendanceBtn.onclick = async () => {
        if (attendanceSelectedDate) lockedAttendanceDates.add(attendanceSelectedDate);
        renderAttendanceList();
        // TODO: persist to DB in the future (e.g., group_attendance table)
      };
    }
    if (editAttendanceBtn) {
      editAttendanceBtn.onclick = () => {
        if (attendanceSelectedDate) lockedAttendanceDates.delete(attendanceSelectedDate);
        renderAttendanceList();
      };
    }
    // ===== end Dziennik =====

    // ===== Dziennik DB persistence (override with Supabase) =====
    const sessionIdByDate = new Map(); // date => session_id

    function getMonthBounds(monthValue) {
      if (!monthValue) return { start: '', end: '' };
      const [yyyy, mm] = monthValue.split('-').map(n => parseInt(n, 10));
      const first = new Date(yyyy, mm - 1, 1);
      const last = new Date(yyyy, mm, 0);
      const fmt = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      return { start: fmt(first), end: fmt(last) };
    }

    async function fetchSessionsForMonth() {
      try {
        if (!selectedGroup || !selectedMonth) return;
        const { start, end } = getMonthBounds(selectedMonth);
        const { data, error } = await supabase
          .from('group_sessions')
          .select('id, session_date, locked')
          .eq('group_id', selectedGroup.id)
          .gte('session_date', start)
          .lte('session_date', end);
        if (error) throw error;
        lockedAttendanceDates.clear();
        sessionIdByDate.clear();
        (data || []).forEach(s => {
          sessionIdByDate.set(s.session_date, s.id);
          if (s.locked) lockedAttendanceDates.add(s.session_date);
        });
      } catch (err) {
        console.warn('fetchSessionsForMonth warn:', err);
      }
    }

    async function ensureSession(dateStr) {
      if (!selectedGroup) throw new Error('No group selected');
      let id = sessionIdByDate.get(dateStr) || null;
      let locked = lockedAttendanceDates.has(dateStr);
      if (!id) {
        try {
          const sel = await supabase
            .from('group_sessions')
            .select('id, locked')
            .eq('group_id', selectedGroup.id)
            .eq('session_date', dateStr)
            .maybeSingle();
          if (sel.data) {
            id = sel.data.id;
            locked = !!sel.data.locked;
          } else {
            const ins = await supabase
              .from('group_sessions')
              .insert([{ group_id: selectedGroup.id, session_date: dateStr }])
              .select('id, locked')
              .single();
            if (ins.error) throw ins.error;
            id = ins.data.id;
            locked = !!ins.data.locked;
          }
          sessionIdByDate.set(dateStr, id);
          if (locked) lockedAttendanceDates.add(dateStr); else lockedAttendanceDates.delete(dateStr);
        } catch (err) {
          console.warn('ensureSession warn:', err);
        }
      }
      return { id, locked };
    }

    async function loadAttendanceForSelectedDate() {
      if (!attendanceSelectedDate) return;
      try {
        const { id, locked } = await ensureSession(attendanceSelectedDate);
        const res = await supabase
          .from('group_attendance')
          .select('participant_id')
          .eq('session_id', id);
        const set = new Set((res.data || []).map(r => r.participant_id));
        inMemoryAttendance.set(attendanceSelectedDate, set);
        if (locked) lockedAttendanceDates.add(attendanceSelectedDate); else lockedAttendanceDates.delete(attendanceSelectedDate);
      } catch (err) {
        console.warn('loadAttendanceForSelectedDate warn:', err);
      }
    }

    async function saveAttendanceForSelectedDate() {
      if (!attendanceSelectedDate) return;
      const presentSet = inMemoryAttendance.get(attendanceSelectedDate) || new Set();
      try {
        const { id } = await ensureSession(attendanceSelectedDate);
        // Replace: delete all then insert present
        const del = await supabase.from('group_attendance').delete().eq('session_id', id);
        if (del.error) throw del.error;
        const rows = Array.from(presentSet).map(pid => ({ session_id: id, participant_id: pid, present: true }));
        if (rows.length) {
          const ins = await supabase.from('group_attendance').insert(rows);
          if (ins.error) throw ins.error;
        }
      } catch (err) {
        console.error('saveAttendanceForSelectedDate error:', err);
        throw err;
      }
    }

    // Override: render dates with sessions and locked markers
    async function renderAttendanceDates() {
      if (!attendanceDatesWrap || !selectedGroup) return;
      await fetchSessionsForMonth();
      const dates = getSessionDatesForMonth(selectedGroup, selectedMonth);
      attendanceDatesWrap.innerHTML = '';
      dates.forEach(dateStr => {
        const isSelected = attendanceSelectedDate === dateStr;
        const isLocked = lockedAttendanceDates.has(dateStr);
        const btn = document.createElement('button');
        btn.className = isSelected ? 'btn btn-primary' : 'btn btn-outline';
        btn.textContent = dateStr;
        if (isLocked) btn.title = 'Zablokowane';
        btn.onclick = async () => {
          attendanceSelectedDate = dateStr;
          await renderAttendanceList();
          await renderAttendanceDates();
        };
        attendanceDatesWrap.appendChild(btn);
      });
      if (!attendanceSelectedDate && dates.length) {
        attendanceSelectedDate = dates[0];
        await renderAttendanceDates();
      }
    }

    // Override: render list loads attendance from DB
    async function renderAttendanceList() {
      if (!attendanceList) return;
      if (!attendanceSelectedDate) {
        attendanceList.innerHTML = '<div class="empty-state"><p>Wybierz termin zajęć</p></div>';
        if (confirmAttendanceBtn) confirmAttendanceBtn.style.display = 'none';
        if (editAttendanceBtn) editAttendanceBtn.style.display = 'none';
        return;
      }
      await loadAttendanceForSelectedDate();
      const participants = await fetchActiveParticipantsForSelectedMonth();
      if (!participants.length) {
        attendanceList.innerHTML = '<div class="empty-state"><p>Brak uczestników</p></div>';
        if (confirmAttendanceBtn) confirmAttendanceBtn.style.display = 'none';
        if (editAttendanceBtn) editAttendanceBtn.style.display = 'none';
        return;
      }
      const canEdit = !lockedAttendanceDates.has(attendanceSelectedDate);
      const frag = document.createDocumentFragment();
      participants.forEach(p => {
        const row = document.createElement('div');
        row.className = 'list-row';
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.padding = '8px 12px';
        const name = document.createElement('div');
        name.textContent = `${p.first_name || ''} ${p.last_name || ''}`.trim();
        const right = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.style.width = 'auto';
        checkbox.disabled = !canEdit;
        checkbox.checked = isPresent(p.id);
        checkbox.onchange = (ev) => {
          togglePresence(p.id, ev.target.checked);
        };
        right.appendChild(checkbox);
        row.appendChild(name);
        row.appendChild(right);
        frag.appendChild(row);
      });
      attendanceList.innerHTML = '';
      attendanceList.appendChild(frag);
      if (confirmAttendanceBtn) confirmAttendanceBtn.style.display = canEdit ? '' : 'none';
      if (editAttendanceBtn) editAttendanceBtn.style.display = canEdit ? 'none' : '';
    }

    if (confirmAttendanceBtn) {
      confirmAttendanceBtn.onclick = async () => {
        try {
          await saveAttendanceForSelectedDate();
          const { id } = await ensureSession(attendanceSelectedDate);
          const upd = await supabase.from('group_sessions').update({ locked: true }).eq('id', id);
          if (upd.error) throw upd.error;
          lockedAttendanceDates.add(attendanceSelectedDate);
          await renderAttendanceList();
          await renderAttendanceDates();
        } catch (err) {
          alert('Błąd zapisu obecności: ' + (err.message || 'Nieznany'));
        }
      };
    }
    if (editAttendanceBtn) {
      editAttendanceBtn.onclick = async () => {
        try {
          const { id } = await ensureSession(attendanceSelectedDate);
          const upd = await supabase.from('group_sessions').update({ locked: false }).eq('id', id);
          if (upd.error) throw upd.error;
          lockedAttendanceDates.delete(attendanceSelectedDate);
          await renderAttendanceList();
          await renderAttendanceDates();
        } catch (err) {
          alert('Błąd odblokowania: ' + (err.message || 'Nieznany'));
        }
      };
    }
    // ===== end Dziennik =====
  </script>
</body>
</html>
