<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Imperia - Tworzenie obozu</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    .small-input { width:120px; }
    .trainers-list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .trainer-row { display:flex; gap:8px; align-items:center; }
    .trainer-row input { padding:6px; border-radius:6px; background:#111; border:1px solid #222; color:#fff; }
  </style>
</head>
<body>
  <main style="padding:20px; max-width:1000px; margin:0 auto;">
    <h2 style="color:#d4af37;">Tworzenie obozu</h2>
    <div style="margin-top:12px;">
      <button class="btn btn-primary" id="createCampBtn">+ Stwórz camp</button>
    </div>

    <!-- Modal -->
    <div id="overlayOboz" style="display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999;"></div>
    <div id="modalOboz" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:1000; width:800px; max-width:95%; background:#1e1e1e; padding:16px; border:1px solid #333; border-radius:8px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="color:#d4af37;">Nowy camp</h3>
        <button class="btn btn-outline" id="closeOboz">Zamknij</button>
      </div>

      <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:120px;">Nazwa campu</label>
          <input id="campName" style="flex:1; padding:8px; border-radius:6px; background:#111; border:1px solid #333; color:#fff;" />
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:120px;">Data</label>
          <input id="campDate" type="date" class="small-input" />
          <label style="width:120px; text-align:right;">Kwota</label>
          <input id="campPrice" type="number" class="small-input" />
          <select id="campCurrency" class="small-input"><option>PLN</option><option>EUR</option></select>
        </div>

        <div style="display:flex; gap:20px;">
          <div style="flex:1;">
            <h4 style="color:#d4af37;">Szkoleniowcy ST</h4>
            <div id="stTrainers" class="trainers-list"></div>
            <button class="btn" id="addStTrainer">+ Dodaj szkoleniowca ST</button>
          </div>

          <div style="flex:1;">
            <h4 style="color:#d4af37;">Szkoleniowcy LA</h4>
            <div id="laTrainers" class="trainers-list"></div>
            <button class="btn" id="addLaTrainer">+ Dodaj szkoleniowca LA</button>
          </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
          <button class="btn" id="cancelCreate">Anuluj</button>
          <button class="btn btn-primary" id="createCamp">Utwórz obóz</button>
        </div>
      </div>
    </div>

    <div id="campResult" style="margin-top:20px;"></div>

    <div style="margin-top:24px;">
      <h3 style="color:var(--gold);">Lista obozów</h3>
      <div id="trainingsList" style="margin-top:8px;"></div>
    </div>

    <div id="campDetails" style="margin-top:20px; display:none;">
      <h3 id="campDetailsTitle" style="color:var(--gold);"></h3>
      <div id="campParticipants" style="margin-top:8px;"></div>
    </div>
  </main>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    function showModal() { document.getElementById('overlayOboz').style.display='block'; document.getElementById('modalOboz').style.display='block'; }
    function hideModal() { document.getElementById('overlayOboz').style.display='none'; document.getElementById('modalOboz').style.display='none'; }

    document.getElementById('createCampBtn').addEventListener('click', ()=>{ showModal(); });
    document.getElementById('closeOboz').addEventListener('click', hideModal);
    document.getElementById('cancelCreate').addEventListener('click', hideModal);

    const stTrainers = document.getElementById('stTrainers');
    const laTrainers = document.getElementById('laTrainers');

    function createTrainerRow(container) {
      const row = document.createElement('div'); row.className='trainer-row';
      row.innerHTML = `<input placeholder="Imię i nazwisko" class="trainer-name" style="flex:1;"/><input placeholder="Cena za lekcję" class="trainer-price small-input" type="number"/> <button class="btn btn-delete">Usuń</button>`;
      const del = row.querySelector('.btn-delete'); del.addEventListener('click', ()=> row.remove());
      container.appendChild(row);
    }

    document.getElementById('addStTrainer').addEventListener('click', ()=> createTrainerRow(stTrainers));
    document.getElementById('addLaTrainer').addEventListener('click', ()=> createTrainerRow(laTrainers));

    document.getElementById('createCamp').addEventListener('click', async ()=>{
      const name = document.getElementById('campName').value.trim();
      const date = document.getElementById('campDate').value;
      const price = parseFloat(document.getElementById('campPrice').value)||0;
      const currency = document.getElementById('campCurrency').value || 'PLN';
      if (!name) { alert('Podaj nazwę campu'); return; }

      // create training
      const { data: training, error } = await supabase.from('trainings').insert([{ name, type: 'camp_la', date, price, currency }]).select().single();
      if (error) { alert('Błąd tworzenia: '+error.message); return; }

      // save trainers
      const trainersToInsert = [];
      const trainerRows = [...stTrainers.querySelectorAll('.trainer-row'), ...laTrainers.querySelectorAll('.trainer-row')];
      for (const r of trainerRows) {
        const tname = r.querySelector('.trainer-name').value.trim();
        const tprice = parseFloat(r.querySelector('.trainer-price').value)||0;
        if (!tname) continue;
        trainersToInsert.push({ name: tname, default_price: tprice, currency });
      }
      if (trainersToInsert.length>0) {
        const { data: trainersData, error: tErr } = await supabase.from('trainers').insert(trainersToInsert).select();
        if (tErr) console.warn('Trainers insert error', tErr.message);
        // link trainers to training
        const links = trainersData.map(t => ({ training_id: training.id, trainer_id: t.id, price: t.default_price }));
        await supabase.from('training_trainers').insert(links);
      }

      // create participants from members
      const { data: membersData, error: mErr } = await supabase.from('members').select('*');
      if (mErr) { alert('Błąd pobierania członków: '+mErr.message); return; }
      const participants = membersData.map(m => ({ training_id: training.id, member_id: m.id, participant_name: m.name }));
      await supabase.from('training_participants').insert(participants);

      hideModal();
      document.getElementById('campResult').innerHTML = '<div style="color:var(--gold);">Camp utworzony pomyślnie</div>';
      loadTrainingsList();
    });

    async function loadTrainingsList() {
      const { data, error } = await supabase.from('trainings').select('*').order('created_at', { ascending: false });
      const container = document.getElementById('trainingsList'); container.innerHTML = '';
      if (error) { container.innerHTML = '<div>Błąd ładowania</div>'; return; }
      data.forEach(t => {
        const el = document.createElement('div'); el.style.padding='8px'; el.style.border='1px solid #333'; el.style.marginBottom='6px';
        el.innerHTML = `<strong>${t.name}</strong> — ${t.date || ''} — <button class="btn" onclick="openTraining('${t.id}')">Otwórz</button>`;
        container.appendChild(el);
      });
    }

    window.openTraining = async function(id) {
      // load participants and trainers
      const { data: training } = await supabase.from('trainings').select('*').eq('id', id).single();
      const { data: participants } = await supabase.from('training_participants').select('*').eq('training_id', id);
      const { data: trainers } = await supabase.from('training_trainers').select('price, trainer_id, trainers(name)').eq('training_id', id);
      document.getElementById('campDetailsTitle').textContent = training.name + ' (' + (training.date||'') + ')';
      const partContainer = document.getElementById('campParticipants'); partContainer.innerHTML = '';
      // header
      const table = document.createElement('table'); table.style.width='100%';
      const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Imię i nazwisko</th><th>Kwota camp</th>' + trainers.map(tr=>`<th>${tr.trainers.name} - lekcje</th><th>${tr.trainers.name} - kwota</th>`).join('') + '<th>Akcje</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      participants.forEach(p => {
        const tr = document.createElement('tr');
        let cols = `<td>${p.participant_name}</td><td><input value="${p.camp_amount||''}"/></td>`;
        trainers.forEach(t => { cols += `<td><input type="number"/></td><td><input type="number"/></td>`; });
        cols += `<td><button class="btn">Zapisz</button></td>`;
        tr.innerHTML = cols; tbody.appendChild(tr);
      });
      table.appendChild(tbody); partContainer.appendChild(table);
      document.getElementById('campDetails').style.display='block';
    }

    // initial load
    loadTrainingsList();
  </script>
</body>
</html>


