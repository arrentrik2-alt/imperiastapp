<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Imperia - Lista Klubu</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-bg: #121212;
      --secondary-bg: #1e1e1e;
      --gold: #d4af37;
      --gold-light: #f1e5b9;
      --text-light: #f5f5f5;
      --text-gray: #b0b0b0;
      --border-dark: #333;
      --success: #28a745;
      --error: #dc3545;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: var(--primary-bg); color: var(--text-light); min-height:100vh; display:flex; overflow-x:hidden; }
    .sidebar { width: 250px; background-color: var(--secondary-bg); height: 100vh; position: fixed; left:0; top:0; padding:20px 0; border-right:1px solid var(--border-dark); }
    .logo { text-align:center; padding:0 20px 20px; border-bottom:1px solid var(--border-dark); margin-bottom:20px; }
    .logo h1 { color: var(--gold); font-size:1.2rem; }
    .nav-links { list-style:none; padding:0 15px; }
    .nav-links li { margin-bottom:8px; }
    .nav-links a { display:flex; align-items:center; padding:10px 12px; text-decoration:none; color:var(--text-gray); border-radius:6px; }
    .nav-links a:hover { background-color: rgba(212,175,55,0.06); color:var(--gold); }
    .main-content { flex:1; margin-left:250px; padding:20px; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .header h2 { color:var(--gold); }
    .content-box { background-color: var(--secondary-bg); border-radius:8px; padding:18px; margin-bottom:16px; border:1px solid var(--border-dark); }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #2b2b2b; padding:10px; text-align:left; }
    th { background: rgba(212,175,55,0.08); color:var(--gold); }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    .btn-primary { background:var(--gold); color:#121212; }
    .btn-delete { background:#e53935; color:white; }
    .form-inline { display:flex; gap:10px; align-items:center; }
    .form-inline input, .form-inline select { padding:8px; border-radius:6px; border:1px solid var(--border-dark); background:#111; color:var(--text-light); }
    .btn-outline { background-color: transparent; border: 1px solid var(--gold); color: var(--gold); padding:6px 10px; border-radius:6px; }
    /* modal overlay */
    #overlay { display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; }
    #addModal { display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:1000; width:700px; max-width:95%; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    .modal-header { border-bottom:1px solid var(--border-dark); padding-bottom:10px; margin-bottom:12px; }
    #addModal input, #addModal select { background: #111; border:1px solid var(--border-dark); color:var(--text-light); padding:8px; border-radius:6px; }
    #modalTitle { color: var(--gold); }
    /* modal overlay */
    #overlay { display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; }
    #addModal { display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:1000; width:700px; max-width:95%; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo"><h1>IMPERIA</h1><div style="color:var(--text-gray); font-size:12px;">Panel Klubu</div></div>
    <ul class="nav-links">
      <li><a href="#" id="nav-members"><i class="fas fa-users"></i><span style="margin-left:8px;">Lista członków</span></a></li>
      <li><a href="#" id="nav-trainings-st"><i class="fas fa-chalkboard-teacher"></i><span style="margin-left:8px;">Szkolenia ST</span></a></li>
      <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span style="margin-left:8px;">Wyloguj</span></a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="header">
      <h2>Lista Klubu</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="addMemberHeaderBtn" class="btn btn-primary">+ Dodaj członka</button>
        <button id="createTrainingSTHeaderBtn" class="btn btn-primary" style="display:none;">+ Stwórz szkolenie ST</button>
        <button id="createCampHeaderBtn" class="btn btn-primary" style="display:none;">+ Stwórz obóz</button>
      </div>
    </div>

    <div id="members-section">
    <div class="content-box">
      <div style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:8px;">
          <input id="searchInput" placeholder="Szukaj..." style="padding:8px; border-radius:6px; border:1px solid var(--border-dark); background:#111; color:var(--text-light);" />
          <button class="btn" onclick="loadMembers()">Odśwież</button>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Imię i nazwisko</th>
              <th>ID</th>
              <th>Email</th>
              <th>Telefon</th>
              <th>Styl</th>
              <th>Karnet</th>
              <th>Akcje</th>
            </tr>
          </thead>
          <tbody id="membersBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Trainings ST section (simplified UI) -->
    <div id="trainings-st-section" style="display:none;">
      <div class="content-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3 style="color:var(--gold);">Szkolenia ST</h3>
          <div><!-- header create button is in the main header; simplified section has its own small create button for direct access -->
            <button id="createTrainingBtn" class="btn btn-primary" style="display:none;">+ Stwórz szkolenie</button>
          </div>
        </div>
        <div id="trainingsStListContainer" style="margin-top:12px;">
          <h4 style="color:var(--gold);">Lista szkoleń ST</h4>
          <div id="trainingsStList"></div>
        </div>
      </div>
    </div>

    <!-- Trainings ST modal (inline in club.html) -->
    <div id="overlayTrainSt" style="display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999;"></div>
    <div id="modalTrainSt" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:1000; width:800px; max-width:95%; background:#1e1e1e; padding:16px; border:1px solid #333; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.6);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;" class="modal-header">
        <h3 style="color:var(--gold);">Nowe szkolenie ST</h3>
        <button class="btn btn-outline" id="closeTrainSt">Zamknij</button>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:140px;">Nazwa szkolenia</label>
          <input id="trainingStName" style="flex:1; padding:8px; border-radius:6px; background:#111; border:1px solid #333; color:#fff;" />
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:140px;">Kwota za szkolenie</label>
          <input id="trainingStPrice" type="number" class="small-input" />
          <select id="trainingStCurrency" class="small-input"><option>PLN</option><option>EUR</option></select>
          <label style="width:100px; text-align:right;">Data</label>
          <input id="trainingStDate" type="date" class="small-input" />
        </div>

        <div>
          <h4 style="color:var(--gold);">Szkoleniowcy</h4>
          <div id="trainersStContainer" class="trainers-list"></div>
          <button class="btn" id="addTrainerSt">+ Dodaj szkoleniowca</button>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
          <button class="btn" id="cancelTrainSt">Anuluj</button>
          <button class="btn btn-primary" id="createTrainingStBtn">Utwórz szkolenie</button>
        </div>
      </div>
    </div>

    <!-- Camps removed per request -->

    <div id="overlay"></div>
    <div id="addModal" class="content-box" style="display:none; max-width:700px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;" class="modal-header">
        <h3 id="modalTitle">Dodaj nowego członka</h3>
        <button class="btn btn-outline" onclick="hideAddForm()">Zamknij</button>
      </div>
      <form id="addMemberForm" data-editing="false" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:120px;">Imię i nazwisko</label>
          <input id="m_name" placeholder="Imię i nazwisko" required style="flex:1;" />
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:120px;">Email</label>
          <input id="m_email" placeholder="Email" style="flex:1;" />
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:120px;">Telefon</label>
          <input id="m_phone" placeholder="Telefon" style="flex:1;" />
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:120px;">Styl</label>
          <select id="m_style" required style="flex:1;">
            <option value="">Wybierz</option>
            <option value="LA">LA</option>
            <option value="ST">ST</option>
            <option value="10t">10T</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:120px;">Karnet</label>
          <select id="m_karnet" required>
            <option value="290">290</option>
            <option value="250">250</option>
            <option value="200">200</option>
          </select>
          <label style="width:80px; text-align:right;">ID</label>
          <input id="m_id" readonly style="width:120px;" />
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" class="btn" onclick="hideAddForm()">Anuluj</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Dodaj</button>
        </div>
      </form>
    </div>
    <!-- Camp modal (merged from oboz.html) -->
    <div id="overlayOboz" style="display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999;"></div>
    <div id="modalOboz" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:1000; width:800px; max-width:95%; background:#1e1e1e; padding:16px; border:1px solid #333; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.6);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;" class="modal-header">
        <h3 id="campModalTitle" style="color:var(--gold);">Nowy camp</h3>
        <button class="btn btn-outline" id="closeOboz">Zamknij</button>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:120px;">Nazwa campu</label>
          <input id="campName" style="flex:1; padding:8px; border-radius:6px; background:#111; border:1px solid #333; color:#fff;" />
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="width:120px;">Data</label>
          <input id="campDate" type="date" class="small-input" />
          <label style="width:120px; text-align:right;">Kwota</label>
          <input id="campPrice" type="number" class="small-input" />
          <select id="campCurrency" class="small-input"><option>PLN</option><option>EUR</option></select>
        </div>
        <div style="display:flex; gap:20px;">
          <div style="flex:1;">
            <h4 style="color:var(--gold);">Szkoleniowcy ST</h4>
            <div id="stTrainers" class="trainers-list"></div>
            <button class="btn" id="addStTrainer">+ Dodaj szkoleniowca ST</button>
          </div>
          <div style="flex:1;">
            <h4 style="color:var(--gold);">Szkoleniowcy LA</h4>
            <div id="laTrainers" class="trainers-list"></div>
            <button class="btn" id="addLaTrainer">+ Dodaj szkoleniowca LA</button>
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
          <button class="btn" id="cancelCreate">Anuluj</button>
          <button class="btn btn-primary" id="createCamp">Utwórz obóz</button>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { supabase } from './supabaseClient.js';
    document.addEventListener('DOMContentLoaded', function() {

    function showAddForm(isEditing) {
      // if caller explicitly passes false, treat as new; otherwise respect form.dataset.editing
      const form = document.getElementById('addMemberForm');
      const currentlyEditing = form.dataset.editing === 'true';
      const editing = typeof isEditing === 'boolean' ? isEditing : currentlyEditing;

      if (!editing) {
        // reset form for new member
        form.dataset.editing = 'false';
        document.getElementById('modalTitle').textContent = 'Dodaj nowego członka';
        document.getElementById('submitBtn').textContent = 'Dodaj';
        document.getElementById('m_name').value = '';
        document.getElementById('m_email').value = '';
        document.getElementById('m_phone').value = '';
        document.getElementById('m_style').value = '';
        document.getElementById('m_karnet').value = '290';
        document.getElementById('m_id').value = generateId();
      } else {
        // keep existing id and values (edit mode)
        form.dataset.editing = 'true';
        document.getElementById('modalTitle').textContent = 'Edytuj członka';
        document.getElementById('submitBtn').textContent = 'Zapisz';
      }

      document.getElementById('overlay').style.display = 'block';
      document.getElementById('addModal').style.display = 'block';
    }

    function hideAddForm() {
      document.getElementById('addModal').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
      const form = document.getElementById('addMemberForm');
      form.dataset.editing = 'false';
      document.getElementById('submitBtn').textContent = 'Dodaj';
    }
    function generateId() { let id=''; for(let i=0;i<6;i++) id+=Math.floor(1+Math.random()*9); return id; }

    async function loadMembers() {
      const search = document.getElementById('searchInput').value.toLowerCase().trim();
      const { data, error } = await supabase.from('members').select('*');
      if (error) { alert('Błąd ładowania: '+error.message); return; }
      // sort alphabetically by name (Polish locale, case-insensitive)
      const sorted = (data||[]).slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'pl', {sensitivity:'base'}));
      const rows = sorted.filter(m => {
        if (!search) return true;
        return (m.name||'').toLowerCase().includes(search) || (m.id||'').toString().includes(search);
      });
      const tbody = document.getElementById('membersBody'); tbody.innerHTML='';
      rows.forEach((m,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${m.name}</td>
          <td>${m.id}</td>
          <td>${m.email||''}</td>
          <td>${m.phone||''}</td>
          <td>${m.style||''}</td>
          <td>${m.karnet||''}</td>
          <td>
            <button class="btn" onclick="editMember('${m.id}')" style="margin-right:6px;">Edytuj</button>
            <button class="btn btn-delete" onclick="deleteMember('${m.id}')">Usuń</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    window.deleteMember = async function(id){ if(!confirm('Usunąć tego członka?')) return; const { error } = await supabase.from('members').delete().eq('id', id); if(error) alert('Błąd: '+error.message); else loadMembers(); }

    // Edit member - open modal with member data
    window.editMember = async function(id) {
      const { data, error } = await supabase.from('members').select('*').eq('id', id).single();
      if (error || !data) { alert('Nie znaleziono członka'); return; }
      document.getElementById('modalTitle').textContent = 'Edytuj członka';
      document.getElementById('m_name').value = data.name || '';
      document.getElementById('m_email').value = data.email || '';
      document.getElementById('m_phone').value = data.phone || '';
      document.getElementById('m_style').value = data.style || '';
      document.getElementById('m_karnet').value = data.karnet || '290';
      document.getElementById('m_id').value = data.id;
      document.getElementById('addMemberForm').dataset.editing = 'true';
      document.getElementById('submitBtn').textContent = 'Zapisz';
      showAddForm(true);
    }

    document.getElementById('addMemberForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const editing = document.getElementById('addMemberForm').dataset.editing === 'true';
      const member={ id: document.getElementById('m_id').value, name: document.getElementById('m_name').value.trim(), email: document.getElementById('m_email').value.trim(), phone: document.getElementById('m_phone').value.trim(), style: document.getElementById('m_style').value, karnet: parseInt(document.getElementById('m_karnet').value,10) };
      if (editing) {
        // update
        const { error } = await supabase.from('members').update({ name: member.name, email: member.email, phone: member.phone, style: member.style, karnet: member.karnet }).eq('id', member.id);
        if (error) { alert('Błąd zapisu: '+error.message); return; }
      } else {
        const { error } = await supabase.from('members').insert([member]);
        if (error) { alert('Błąd dodawania: '+error.message); return; }
      }
      document.getElementById('addMemberForm').dataset.editing = 'false';
      document.getElementById('submitBtn').textContent = 'Dodaj';
      hideAddForm();
      loadMembers();
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{ await supabase.auth.signOut(); window.location.href='index.html'; });

    // Camp modal handlers (merged)
    function showCampModal() { document.getElementById('overlayOboz').style.display='block'; document.getElementById('modalOboz').style.display='block'; }
    function hideCampModal() { document.getElementById('overlayOboz').style.display='none'; document.getElementById('modalOboz').style.display='none'; }
    // expose for debugging/global access
    window.showCampModal = showCampModal;
    window.hideCampModal = hideCampModal;
    // nav handlers (attach safely only if elements exist)
    const navMembers = document.getElementById('nav-members');
    if (navMembers) navMembers.addEventListener('click', (e) => {
      e.preventDefault();
      const ms = document.getElementById('members-section');
      const cs = document.getElementById('camps-section');
      const ts = document.getElementById('trainings-st-section');
      if (ms) ms.style.display = 'block';
      if (cs) cs.style.display = 'none';
      if (ts) ts.style.display = 'none';
      const createHdr = document.getElementById('createCampHeaderBtn');
      if (createHdr) createHdr.style.display = 'none';
      const stHdr = document.getElementById('createTrainingSTHeaderBtn'); if (stHdr) stHdr.style.display = 'none';
      const secCreate = document.getElementById('createTrainingBtn'); if (secCreate) secCreate.style.display = 'none';
      const addHdr = document.getElementById('addMemberHeaderBtn');
      if (addHdr) addHdr.style.display = 'inline-block';
    });

    const navCamps = document.getElementById('nav-camps');
    if (navCamps) navCamps.addEventListener('click', (e) => {
      e.preventDefault();
      const ms = document.getElementById('members-section');
      const cs = document.getElementById('camps-section');
      const ts = document.getElementById('trainings-st-section');
      if (ms) ms.style.display = 'none';
      if (cs) cs.style.display = 'block';
      if (ts) ts.style.display = 'none';
      const createHdr = document.getElementById('createCampHeaderBtn');
      if (createHdr) createHdr.style.display = 'inline-block';
      const stHdr = document.getElementById('createTrainingSTHeaderBtn'); if (stHdr) stHdr.style.display = 'none';
      const secCreate = document.getElementById('createTrainingBtn'); if (secCreate) secCreate.style.display = 'none';
      const addHdr = document.getElementById('addMemberHeaderBtn');
      if (addHdr) addHdr.style.display = 'none';
      if (typeof loadTrainingsList === 'function') loadTrainingsList();
    });

    const navTrainingsST = document.getElementById('nav-trainings-st');
    if (navTrainingsST) navTrainingsST.addEventListener('click', (e) => {
      e.preventDefault();
      const ms = document.getElementById('members-section');
      const cs = document.getElementById('camps-section');
      const ts = document.getElementById('trainings-st-section');
      if (ms) ms.style.display = 'none';
      if (cs) cs.style.display = 'none';
      if (ts) ts.style.display = 'block';
      const createHdr = document.getElementById('createCampHeaderBtn');
      if (createHdr) createHdr.style.display = 'none';
      const addHdr = document.getElementById('addMemberHeaderBtn');
      if (addHdr) addHdr.style.display = 'none';
      if (typeof loadTrainingsSTList === 'function') loadTrainingsSTList();
    });

    // attach create camp listeners if element exists
    const campBtn = document.getElementById('createCampBtnCamps');
    if (campBtn) campBtn.addEventListener('click', showCampModal);
    // header create button wired to same modal (attach safely)
    const hdrBtn = document.getElementById('createCampHeaderBtn');
    if (hdrBtn) hdrBtn.addEventListener('click', showCampModal);
    // header add member button attach
    const addHdrBtn = document.getElementById('addMemberHeaderBtn');
    if (addHdrBtn) addHdrBtn.addEventListener('click', () => (window.showAddForm ? window.showAddForm(false) : null));
    const closeOb = document.getElementById('closeOboz'); if (closeOb) closeOb.addEventListener('click', hideCampModal);
    const cancelCreateBtn = document.getElementById('cancelCreate'); if (cancelCreateBtn) cancelCreateBtn.addEventListener('click', hideCampModal);

    const stTrainers = document.getElementById('stTrainers');
    const laTrainers = document.getElementById('laTrainers');
    const trainersStContainer = document.getElementById('trainersStContainer');

    function createTrainerRow(container) {
      const row = document.createElement('div'); row.className='trainer-row';
      row.innerHTML = `<input placeholder="Imię i nazwisko" class="trainer-name" style="flex:1;"/><input placeholder="Cena za lekcję" class="trainer-price small-input" type="number"/> <button class="btn btn-delete">Usuń</button>`;
      const del = row.querySelector('.btn-delete'); del.addEventListener('click', ()=> row.remove());
      container.appendChild(row);
    }

    document.getElementById('addStTrainer').addEventListener('click', ()=> createTrainerRow(stTrainers));
    document.getElementById('addLaTrainer').addEventListener('click', ()=> createTrainerRow(laTrainers));

    document.getElementById('createCamp').addEventListener('click', async ()=>{
      const name = document.getElementById('campName').value.trim();
      const date = document.getElementById('campDate').value;
      const price = parseFloat(document.getElementById('campPrice').value)||0;
      const currency = document.getElementById('campCurrency').value || 'PLN';
      if (!name) { alert('Podaj nazwę campu'); return; }

      // create training
      const { data: training, error } = await supabase.from('trainings').insert([{ name, type: 'camp_la', date, price, currency }]).select().single();
      if (error) { alert('Błąd tworzenia: '+error.message); return; }

      // save trainers
      const trainersToInsert = [];
      const trainerRows = [...stTrainers.querySelectorAll('.trainer-row'), ...laTrainers.querySelectorAll('.trainer-row')];
      for (const r of trainerRows) {
        const tname = r.querySelector('.trainer-name').value.trim();
        const tprice = parseFloat(r.querySelector('.trainer-price').value)||0;
        if (!tname) continue;
        trainersToInsert.push({ name: tname, default_price: tprice, currency });
      }
      if (trainersToInsert.length>0) {
        const { data: trainersData, error: tErr } = await supabase.from('trainers').insert(trainersToInsert).select();
        if (tErr) console.warn('Trainers insert error', tErr.message);
        // link trainers to training
        const links = trainersData.map(t => ({ training_id: training.id, trainer_id: t.id, price: t.default_price }));
        await supabase.from('training_trainers').insert(links);
      }

      // create participants from members
      const { data: membersData, error: mErr } = await supabase.from('members').select('*');
      if (mErr) { alert('Błąd pobierania członków: '+mErr.message); return; }
      const participants = membersData.map(m => ({ training_id: training.id, member_id: m.id, participant_name: m.name }));
      await supabase.from('training_participants').insert(participants);

      hideCampModal();
      alert('Camp utworzony pomyślnie');
    });

    // Trainings ST modal handlers and logic
    function showTrainStModal(){
      const overlay = document.getElementById('overlayTrainSt');
      const modal = document.getElementById('modalTrainSt');
      if (!modal) return;
      // ensure overlay and modal are visible and on top of everything
      if (overlay) {
        overlay.style.display = 'block';
        overlay.style.zIndex = '1999';
        overlay.style.pointerEvents = 'auto';
        overlay.style.opacity = '1';
      }
      modal.style.display = 'block';
      // force fixed centering and highest stacking context
      modal.style.position = 'fixed';
      modal.style.left = '50%';
      modal.style.top = '50%';
      modal.style.transform = 'translate(-50%,-50%)';
      modal.style.zIndex = '2000';
      modal.style.pointerEvents = 'auto';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';

      // focus first focusable element inside modal
      const firstInput = modal.querySelector('input,select,button,textarea');
      if (firstInput) {
        try { firstInput.focus(); } catch(e){}
      }

      // also attempt to bring to front by appending to body
      try {
        document.body.appendChild(modal);
        if (overlay) document.body.appendChild(overlay);
      } catch(e){}
    }
    function hideTrainStModal(){ const overlay = document.getElementById('overlayTrainSt'); const modal = document.getElementById('modalTrainSt'); if (overlay) overlay.style.display='none'; if (modal) modal.style.display='none'; }
    // expose modal functions globally and attach header/section create buttons safely
    window.showTrainStModal = showTrainStModal;
    window.hideTrainStModal = hideTrainStModal;
    const createSTHdrBtn = document.getElementById('createTrainingSTHeaderBtn');
    const createTrainingBtn = document.getElementById('createTrainingBtn');
    if (createSTHdrBtn) {
      createSTHdrBtn.style.display = 'none'; // shown when entering ST view
      createSTHdrBtn.addEventListener('click', showTrainStModal);
    }
    if (createTrainingBtn) {
      createTrainingBtn.style.display = 'none';
      createTrainingBtn.addEventListener('click', showTrainStModal);
    }
    const closeTrainStEl = document.getElementById('closeTrainSt'); if (closeTrainStEl) closeTrainStEl.addEventListener('click', hideTrainStModal);
    const cancelTrainStEl = document.getElementById('cancelTrainSt'); if (cancelTrainStEl) cancelTrainStEl.addEventListener('click', hideTrainStModal);
    document.getElementById('addTrainerSt').addEventListener('click', ()=>{
      const row=document.createElement('div'); row.className='trainer-row'; row.innerHTML=`<input class="trainer-name" placeholder="Imię i nazwisko" style="flex:1;"/><input class="trainer-price small-input" type="number" placeholder="Cena"/><button class="btn btn-delete">Usuń</button>`;
      row.querySelector('.btn-delete').addEventListener('click', ()=>row.remove()); trainersStContainer.appendChild(row);
    });
    document.getElementById('createTrainingStBtn').addEventListener('click', async ()=>{
      const name=document.getElementById('trainingStName').value.trim(); const price=parseFloat(document.getElementById('trainingStPrice').value)||0; const currency=document.getElementById('trainingStCurrency').value||'PLN'; const date=document.getElementById('trainingStDate').value; if(!name){ alert('Wprowadź nazwę'); return; }
      const allowedTypes = ['camp_la','camp_st','training_la','training_st'];
      const payload = { name, type: 'training_st', date, price, currency };
      if (!allowedTypes.includes(payload.type)) { alert('Nieprawidłowy typ szkolenia: '+payload.type); console.error('Invalid trainings.type', payload); return; }
      let training; let error;
      try {
        const resp = await supabase.from('trainings').insert([payload]).select().single();
        training = resp.data; error = resp.error;
      } catch(e) {
        console.error('Insert trainings exception', e);
        alert('Błąd tworzenia (exception). Sprawdź konsolę.');
        return;
      }
      if(error){
        console.error('Trainings insert error', error);
        alert('Błąd: '+error.message + '\nSzczegóły: '+ (error.details||'no details'));
        return;
      }
      const rows=[...trainersStContainer.querySelectorAll('.trainer-row')]; const trainersToInsert=[]; for(const r of rows){ const n=r.querySelector('.trainer-name').value.trim(); const p=parseFloat(r.querySelector('.trainer-price').value)||0; if(!n) continue; trainersToInsert.push({ name: n, default_price: p, currency }); }
      if(trainersToInsert.length){ const { data: trainersData } = await supabase.from('trainers').insert(trainersToInsert).select(); const links=trainersData.map(t=>({ training_id: training.id, trainer_id: t.id, price: t.default_price })); await supabase.from('training_trainers').insert(links); }
      const { data: members } = await supabase.from('members').select('*'); const participants = members.map(m=>({ training_id: training.id, member_id: m.id, participant_name: m.name })); await supabase.from('training_participants').insert(participants);
      hideTrainStModal(); alert('Szkolenie ST utworzone'); loadTrainingsSTList();
    });

    // Trainings ST list loader
    async function loadTrainingsSTList() {
      const container = document.getElementById('trainingsStList');
      if (!container) return;
      container.innerHTML = '';
      let data, error;
      try {
        const resp = await supabase.from('trainings').select('id,name,type,date,price,currency').eq('type','training_st').order('created_at',{ascending:false});
        data = resp.data; error = resp.error;
      } catch(e) {
        console.error('loadTrainingsSTList exception', e);
        container.innerHTML = '<div>Błąd (exception). Sprawdź konsolę.</div>';
        return;
      }
      if (error) { console.error('loadTrainingsSTList error', error); container.innerHTML = '<div>Błąd</div>'; return; }
      if (!data || data.length===0) { container.innerHTML = '<div>Brak szkoleń ST</div>'; return; }
      data.forEach(t=>{ const el=document.createElement('div'); el.style.padding='8px'; el.style.border='1px solid #333'; el.style.marginBottom='6px'; el.innerHTML=`<strong>${t.name}</strong> - ${t.date||''} <button class="btn" data-id="${t.id}">Otwórz</button>`; el.querySelector('button').addEventListener('click', ()=> openTraining(t.id)); container.appendChild(el); });
    }

    // Load trainings list for camps section
    async function loadTrainingsList() {
      const container = document.getElementById('trainingsList');
      if (!container) return;
      container.innerHTML = '';
      let data, error;
      try {
        const resp = await supabase.from('trainings').select('id,name,type,date,price,currency').order('created_at', { ascending: false });
        data = resp.data; error = resp.error;
      } catch(e) {
        console.error('loadTrainingsList exception', e);
        container.innerHTML = '<div>Błąd (exception). Sprawdź konsolę.</div>';
        return;
      }
      if (error) { console.error('loadTrainingsList error', error); container.innerHTML = '<div>Błąd ładowania listy obozów</div>'; return; }
      if (!data || data.length === 0) {
        container.innerHTML = '<div>Brak obozów</div>';
        return;
      }
      data.forEach(t => {
        const el = document.createElement('div');
        el.style.padding = '8px';
        el.style.border = '1px solid #333';
        el.style.marginBottom = '6px';
        const dateStr = t.date ? new Date(t.date).toLocaleDateString() : '';
        el.innerHTML = `<strong>${t.name}</strong> — ${dateStr} — <button class="btn" data-id="${t.id}">Otwórz</button>`;
        const btn = el.querySelector('button');
        btn.addEventListener('click', () => openTraining(t.id));
        container.appendChild(el);
      });
    }

    // Open training detail: render participants and trainer columns
    async function openTraining(trainingId) {
      const { data: training, error: terr } = await supabase.from('trainings').select('*').eq('id', trainingId).single();
      if (terr || !training) { alert('Nie można wczytać campu'); return; }

      // fetch trainers linked to this training
      const { data: trLinks } = await supabase.from('training_trainers').select('price,trainer_id,trainers(id,name)').eq('training_id', trainingId);
      const trainers = trLinks || [];

      // fetch participants
      const { data: participants } = await supabase.from('training_participants').select('*').eq('training_id', trainingId).order('participant_name');

      const titleEl = document.getElementById('campDetailsTitle');
      const participantsEl = document.getElementById('campParticipants');
      titleEl.textContent = training.name + ' (' + (training.date||'') + ')';
      participantsEl.innerHTML = '';

      const table = document.createElement('table');
      table.style.width = '100%';
      const thead = document.createElement('thead');
      let headRow = '<tr><th>Imię i nazwisko</th><th>Camp (kwota)</th>';
      trainers.forEach(t => { headRow += `<th>${t.trainers.name} - lekcje</th><th>${t.trainers.name} - kwota</th>`; });
      headRow += '<th>Akcje</th></tr>';
      thead.innerHTML = headRow; table.appendChild(thead);

      const tbody = document.createElement('tbody');
      for (const p of (participants || [])) {
        const tr = document.createElement('tr');
        let cols = `<td>${p.participant_name}</td>`;
        cols += `<td><input class="camp-amount" data-rowid="${p.id}" value="${p.camp_amount||''}" style="width:80px;"/></td>`;
        trainers.forEach(t => {
          cols += `<td><input class="lessons-count" data-participant="${p.id}" data-trainer="${t.trainer_id}" type="number" style="width:70px;"/></td>`;
          cols += `<td><input class="lesson-amount" data-participant="${p.id}" data-trainer="${t.trainer_id}" type="number" style="width:80px;"/></td>`;
        });
        cols += `<td><button class="btn" data-pid="${p.id}">Zapisz</button></td>`;
        tr.innerHTML = cols; tbody.appendChild(tr);
      }

      table.appendChild(tbody); participantsEl.appendChild(table);
      document.getElementById('campDetails').style.display = 'block';

      // attach save handlers for each row button
      participantsEl.querySelectorAll('button[data-pid]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const pid = btn.dataset.pid;
          const campInput = participantsEl.querySelector(`input.camp-amount[data-rowid="${pid}"]`);
          const campVal = parseFloat(campInput.value) || null;
          // update camp amount
          await supabase.from('training_participants').update({ camp_amount: campVal }).eq('id', pid);

          // for each trainer, upsert oboz_lesson_payments
          for (const t of trainers) {
            const lessonsEl = participantsEl.querySelector(`input.lessons-count[data-participant="${pid}"][data-trainer="${t.trainer_id}"]`);
            const amountEl = participantsEl.querySelector(`input.lesson-amount[data-participant="${pid}"][data-trainer="${t.trainer_id}"]`);
            const lessons = lessonsEl ? parseInt(lessonsEl.value) || 0 : 0;
            const amount = amountEl ? parseFloat(amountEl.value) || 0 : 0;

            // check existing
            const { data: existing } = await supabase.from('oboz_lesson_payments').select('*').eq('training_participant_id', pid).eq('trainer_id', t.trainer_id).limit(1).single();
            if (existing && existing.id) {
              await supabase.from('oboz_lesson_payments').update({ lessons_count: lessons, amount: amount, status: amount>0? 'pending':'unset' }).eq('id', existing.id);
            } else {
              await supabase.from('oboz_lesson_payments').insert([{ training_participant_id: pid, trainer_id: t.trainer_id, lessons_count: lessons, amount: amount, currency: training.currency, status: amount>0? 'pending':'unset' }]);
            }
          }

          alert('Zapisano płatności');
        });
      });
    }

    // expose functions for inline handlers (module scope isn't global)
    window.showAddForm = showAddForm;
    window.hideAddForm = hideAddForm;
    window.loadMembers = loadMembers;
    // expose trainings loaders and openTraining for console/debug
    if (typeof loadTrainingsSTList === 'function') window.loadTrainingsSTList = loadTrainingsSTList;
    if (typeof loadTrainingsList === 'function') window.loadTrainingsList = loadTrainingsList;
    if (typeof openTraining === 'function') window.openTraining = openTraining;

    // helper to show Trainings ST view
    function showTrainingsSTView() {
      const ms = document.getElementById('members-section');
      const ts = document.getElementById('trainings-st-section');
      if (ms) ms.style.display = 'none';
      if (ts) ts.style.display = 'block';
      const hdr = document.querySelector('.header h2'); if (hdr) hdr.textContent = 'Szkolenia ST';
      // show ST header and section create buttons
      const stCreate = document.getElementById('createTrainingSTHeaderBtn'); if (stCreate) stCreate.style.display = 'inline-block';
      const secCreate = document.getElementById('createTrainingBtn'); if (secCreate) secCreate.style.display = 'inline-block';
      // ensure modal create buttons are wired
      if (stCreate) stCreate.removeEventListener && stCreate.addEventListener('click', showTrainStModal);
      if (secCreate) secCreate.removeEventListener && secCreate.addEventListener('click', showTrainStModal);
      // hide other header buttons
      const addHdr = document.getElementById('addMemberHeaderBtn'); if (addHdr) addHdr.style.display = 'none';
      const campHdr = document.getElementById('createCampHeaderBtn'); if (campHdr) campHdr.style.display = 'none';
      if (typeof loadTrainingsSTList === 'function') loadTrainingsSTList();
    }

    // attach nav click safely
    const navTrainings = document.getElementById('nav-trainings-st');
    if (navTrainings) navTrainings.addEventListener('click', function(e){ e.preventDefault(); showTrainingsSTView(); });

    // Init
    loadMembers();
    });
  </script>
</body>
</html>


